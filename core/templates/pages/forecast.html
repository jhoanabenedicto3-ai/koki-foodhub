{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Forecast - Koki's Foodhub{% endblock %}

{% block content %}
  <div class="forecast-wrapper container">
  {% block extra_head %}
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
  {% endblock %}
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between; gap:18px;">
    <div style="flex:1;">
      <h1 class="section-title">Sales Forecast</h1>
      <p class="muted">AI-powered predictions based on your historical sales data.</p>
    </div>
    <div class="page-controls" style="display:flex; gap:10px; align-items:center;">
      <button class="btn btn-ghost" id="btnExport" title="Export CSV"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right:8px; vertical-align:middle;"><path d="M12 3v12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Export</button>
    </div>
  </div>

    <!-- Forecast hero cards (three-up layout matching mock) -->
    <div class="forecast-hero-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;align-items:stretch; margin-bottom:32px;">

      <div class="forecast-hero-card" style="width:100%;">
        <div class="hero-pct"><span class="growth-badge {% if today_growth_positive %}growth-up{% else %}growth-down{% endif %}">{{ today_growth_pct_display }}</span></div>
        <div class="hero-header">
          <div class="hero-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="3" stroke="#111" stroke-opacity="0.8" stroke-width="1.2" fill="none"/><path d="M8 2v4M16 2v4" stroke="#111" stroke-opacity="0.8" stroke-width="1.2" stroke-linecap="round"/><path d="M7 11h10" stroke="#111" stroke-opacity="0.8" stroke-width="1.2" stroke-linecap="round"/></svg></div>
          <div class="hero-meta">
            <div class="hero-title">Tomorrow's Sales</div>
            <div class="hero-date">{{ tomorrow_label }}</div>
          </div>
        </div>
        <div class="hero-amount" id="hero-tomorrow-amount">{{ today_forecast_revenue_display }}</div>
        <div class="hero-row-bottom">
          <div class="hero-sub">Confidence: <span class="conf-pill" id="hero-tomorrow-margin">±{{ today_confidence_margin_display }}</span> <span class="muted info" title="Confidence interval">ⓘ</span></div>
          <div class="hero-trend" id="hero-tomorrow-conf-pct">▲ {{ today_confidence_pct }}%</div>
        </div>
      </div>

      <div class="forecast-hero-card">
        <div class="hero-pct"><span class="growth-badge {% if week_growth_positive %}growth-up{% else %}growth-down{% endif %}">{{ week_growth_pct_display }}</span></div>
        <div class="hero-header">
          <div class="hero-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17l6-8 4 5 8-10" stroke="#111" stroke-opacity="0.9" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div>
          <div class="hero-meta">
            <div class="hero-title">Next Week</div>
            <div class="hero-date">{{ next_week_label }}</div>
          </div>
        </div>
        <div class="hero-amount" id="hero-week-amount">{{ week_forecast_revenue_display }}</div>
        <div class="hero-row-bottom">
          <div class="hero-sub">Confidence: <span class="conf-pill" id="hero-week-margin">±{{ week_confidence_margin_display }}</span> <span class="muted info" title="Confidence interval">ⓘ</span></div>
          <div class="hero-trend" id="hero-week-conf-pct">▲ {{ week_confidence_pct }}%</div>
        </div>
      </div>

      <div class="forecast-hero-card">
        <div class="hero-pct"><span class="growth-badge {% if month_growth_positive %}growth-up{% else %}growth-down{% endif %}">{{ month_growth_pct_display }}</span></div>
        <div class="hero-header">
          <div class="hero-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="4" height="10" rx="1" stroke="#111" stroke-width="1.2" fill="none"/><rect x="10" y="4" width="4" height="13" rx="1" stroke="#111" stroke-width="1.2" fill="none"/><rect x="17" y="10" width="4" height="7" rx="1" stroke="#111" stroke-width="1.2" fill="none"/></svg></div>
          <div class="hero-meta">
            <div class="hero-title">Next Month</div>
            <div class="hero-date">{{ next_month_label }}</div>
          </div>
        </div>
        <div class="hero-amount" id="hero-month-amount">{{ month_forecast_revenue_display }}</div>
        <div class="hero-row-bottom">
          <div class="hero-sub">Confidence: <span class="conf-pill" id="hero-month-margin">±{{ month_confidence_margin_display }}</span> <span class="muted info" title="Confidence interval">ⓘ</span></div>
          <div class="hero-trend" id="hero-month-conf-pct">▲ {{ month_confidence_pct }}%</div>
        </div>
      </div>

      <!-- Next Year hero card - hidden in main view -->
      <div class="forecast-hero-card" style="display:none;">
        <div class="hero-pct"><span class="growth-badge {% if year_growth_positive %}growth-up{% else %}growth-down{% endif %}">{{ year_growth_pct_display }}</span></div>
        <div class="hero-header">
          <div class="hero-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="3" stroke="#111" stroke-opacity="0.8" stroke-width="1.2" fill="none"/><path d="M8 8h8" stroke="#111" stroke-opacity="0.8" stroke-width="1.2" stroke-linecap="round"/><path d="M8 12h8" stroke="#111" stroke-opacity="0.8" stroke-width="1.2" stroke-linecap="round"/></svg></div>
          <div class="hero-meta">
            <div class="hero-title">Next Year</div>
            <div class="hero-date">{{ next_year_label }}</div>
          </div>
        </div>
        <div class="hero-amount" id="hero-year-amount">{{ year_forecast_revenue_display }}</div>
        <div class="hero-row-bottom">
          <div class="hero-sub">Confidence: <span class="conf-pill" id="hero-year-margin">±{{ year_confidence_margin_display }}</span> <span class="muted info" title="Confidence interval">ⓘ</span></div>
          <div class="hero-trend" id="hero-year-conf-pct">▲ {{ year_confidence_pct }}%</div>
        </div>
      </div>

    </div>

  <!-- Compact controls removed for simplified UI to match mock -->

  {% if error_message %}
    <div style="margin-bottom: 16px; padding: 12px 16px; background: #fff3f2; border: 1px solid #fcd5d5; color:#7f1d1d; border-radius:8px;">
      <strong>Note:</strong> {{ error_message }}
    </div>
  {% endif %}

  {% if data %}
    <!-- Revenue Trend Chart (Interactive Forecast Visualization) -->
    <div class="card chart-card" style="margin-bottom: 32px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <div>
          <h2 style="margin:0; font-size:18px; font-weight:800;">Revenue Trend</h2>
          <p style="margin:4px 0 0 0; font-size:14px; color:var(--text-secondary);">Historical data vs. AI-driven projection</p>
        </div>
        <select id="rangeSelect" style="border-radius:10px; padding:8px 12px; border:1px solid rgba(15,23,36,0.06); background:#fff; box-shadow:0 6px 18px rgba(16,24,40,0.03); min-width:140px;">
          <option value="7" selected>Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
        </select>
      </div>

      <!-- Chart Container -->
      <div class="chart-area" style="position:relative; height:400px; border-radius:8px; background:#fafbfc; padding:0;">
        <canvas id="salesChart" style="display:block; width:100% !important; height:100% !important;"></canvas>
      </div>
    </div>

    <!-- Sales Overview & Prediction Chart -->
    <!-- Sales Overview Cards -->
    <!-- Overview cards removed per user request -->

<!-- forecast-hero-grid: moved earlier in the file to match requested design -->
    <script>
      // Export button functionality
      document.getElementById('btnExport')?.addEventListener('click', function(){
        const data = {
          daily: window._serverDaily,
          weekly: window._serverWeekly,
          monthly: window._serverMonthly,
          yearly: window._serverYearly,
          currency: window.currencySymbol
        };
        
        const csv = generateForecastCSV(data);
        downloadCSV(csv, 'forecast-' + new Date().toISOString().split('T')[0] + '.csv');
      });

      function generateForecastCSV(data) {
        let csv = 'Forecast Export\n';
        csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';
        
        // Daily data
        csv += 'Daily Forecast\n';
        csv += 'Date,Revenue\n';
        if(data.daily && data.daily.labels) {
          for(let i = 0; i < data.daily.labels.length; i++) {
            csv += data.daily.labels[i] + ',' + (data.daily.actual?.[i] || '') + '\n';
          }
        }
        csv += '\n';
        
        // Weekly data
        csv += 'Weekly Forecast\n';
        csv += 'Week,Revenue\n';
        if(data.weekly && data.weekly.labels) {
          for(let i = 0; i < data.weekly.labels.length; i++) {
            csv += data.weekly.labels[i] + ',' + (data.weekly.actual?.[i] || '') + '\n';
          }
        }
        csv += '\n';
        
        // Monthly data
        csv += 'Monthly Forecast\n';
        csv += 'Month,Revenue\n';
        if(data.monthly && data.monthly.labels) {
          for(let i = 0; i < data.monthly.labels.length; i++) {
            csv += data.monthly.labels[i] + ',' + (data.monthly.actual?.[i] || '') + '\n';
          }
        }
        
        return csv;
      }

      function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Add range selector listener for Revenue Trend chart
      document.getElementById('rangeSelect')?.addEventListener('change', function(){ 
        console.log('[Forecast] Range changed to:', this.value);
        if(typeof refreshForecast === 'function'){ 
          refreshForecast(); 
        }
      });
    </script>

    <script>
      // Expose currency symbol to static scripts
      window.currencySymbol = '{{ currency|escapejs }}' || '';
      // Expose server-side pre-computed JSON series so client can use them without extra fetches
      // These JSON blobs are revenue-converted on the server for accurate display
      // Prefer direct revenue series when available (daily_revenue_json is the canonical source for daily revenue)
      window._serverDaily = {{ daily_revenue_json|default:"null"|safe }} || {{ daily_json|default:"null"|safe }} || null;
      window._serverWeekly = {{ weekly_revenue_json|default:"null"|safe }} || {{ weekly_json|default:"null"|safe }} || null;
      window._serverMonthly = {{ monthly_revenue_json|default:"null"|safe }} || {{ monthly_json|default:"null"|safe }} || null;
      window._serverYearly = {{ yearly_revenue_json|default:"null"|safe }} || null;
      // Expose today's forecast revenue (currency) so client can sanity-check scaling
      window._todayForecastRevenue = {{ today_forecast_revenue|default:0 }};
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function(){
        const v2 = "{% static 'core/js/forecast_chart_init_v2.js' %}?v={% now 'U' %}";
        const v1 = "{% static 'core/js/forecast_chart_init.js' %}?v={% now 'U' %}";
        const s = document.createElement('script');
        s.src = v2;
        s.async = false;
        s.onload = function(){ console.log('[Forecast Loader] Loaded v2 script:', v2); };
        s.onerror = function(){
          console.warn('[Forecast Loader] Failed to load v2 script, falling back to v1:', v2);
          const f = document.createElement('script');
          f.src = v1;
          f.async = false;
          f.onload = function(){ console.log('[Forecast Loader] Loaded fallback v1 script:', v1); };
          f.onerror = function(){ console.error('[Forecast Loader] Failed to load forecast script fallback:', v1); };
          document.head.appendChild(f);
        };
        document.head.appendChild(s);
      })();
    </script>

    <style>
      .overview-grid .overview-card .card-icon { width:44px; height:44px; border-radius:8px; background:rgba(15,23,36,0.03); display:flex; align-items:center; justify-content:center; }
      /* Responsive breakpoints: 3-up -> 2-up -> 1-up */
      @media (max-width: 980px) { .overview-grid .overview-card { flex: 1 1 calc(50% - 12px); max-width: calc(50% - 12px); } }
      @media (max-width: 680px) { .overview-grid { gap: 12px; } .overview-grid .overview-card { flex:1 1 100%; max-width:100%; } }

      /* When the sidebar overlays or is expanded, keep cards on one horizontal row that can be scrolled into view */
      .page-wrapper.sidebar-expanded .overview-grid,
      .sidebar:hover + .main-content .overview-grid,
      .sidebar:hover ~ .main-content .overview-grid {
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
      }
      .page-wrapper.sidebar-expanded .overview-grid .overview-card { flex: 0 0 320px !important; min-width:320px !important; max-width:320px !important; }
      .page-wrapper.sidebar-expanded .overview-grid::after { content: ''; position: absolute; right: 0; top: 0; width: 48px; height: 100%; pointer-events: none; background: linear-gradient(to left, rgba(255,255,255,0.95), rgba(255,255,255,0)); }

      /* Shift the inner content container to the right when the sidebar expands or is hovered so cards are not hidden */
      .page-wrapper.sidebar-expanded .main-content .container,
      .sidebar:hover + .main-content .container,
      .sidebar:hover ~ .main-content .container {
        margin-left: 208px !important;
        transition: margin-left 220ms ease;
      }
      /* If viewport is very small, use a smaller shift so content stays readable */
      @media (max-width: 900px) {
        .page-wrapper.sidebar-expanded .main-content .container,
        .sidebar:hover + .main-content .container,
        .sidebar:hover ~ .main-content .container { margin-left: 140px !important; }
      }
      .badge { padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; }
      .badge-warning { background:#fef3c7; color:#92400e; }
      .badge-danger { background:#fff3f2; color:#7f1d1d; }

      /* Analytics cards removed as per design request */

      /* Chart card: match reference visual: rounded, subtle border, p-6, shadow-sm */
      .card.chart-card { background: #ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:28px; box-shadow:0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom:32px; overflow:hidden; }
      .card.chart-card .chart-area { position:relative; height:400px; border-radius:8px; background:#fafbfc; padding:0; }
      .card.chart-card #rangeSelect { border-radius:10px; padding:8px 12px; border:1px solid rgba(15,23,36,0.06); background:#fff; box-shadow:none; min-width:140px; }
      .legend-row{ gap:12px; align-items:center; }
      .legend-swatch{ width:12px; height:12px; border-radius:12px; box-shadow:none; }
      .legend-swatch.actual{ background:#0f172a; }
      .legend-swatch.predicted{ background:#FF8C42; }
      .legend-item span.muted{ font-size:13px; color:#6b7280; }
      .card.chart-card #rangeSelect { border-radius:10px; padding:8px 12px; border:1px solid rgba(15,23,36,0.06); background:#fff; box-shadow:0 6px 18px rgba(16,24,40,0.03); min-width:140px; }

      /* Slight header tweak */
      .section-title { font-size:22px; margin-bottom:6px; font-weight:800; }

      /* Improve forecast wrapper spacing on wider screens */
      .forecast-wrapper { max-width: 1180px; margin: 20px auto; padding: 0 22px; padding-left:36px; box-sizing: border-box; }
      .page-wrapper.sidebar-expanded .main-content .forecast-wrapper,
      .sidebar:hover + .main-content .forecast-wrapper,
      .sidebar:hover ~ .main-content .forecast-wrapper { margin-left: auto !important; margin-right: auto !important; padding-left:36px !important; }

      /* Duplicate chart-card styles consolidated above (intentionally kept minimal to avoid overrides) */
      /* Two column layout for actual / forecast */
      .two-up{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:12px; }
      .small-card{ padding:14px; min-height:180px; }
      .small-chart-area{ height:160px; }
      @media (max-width:720px){ .two-up{ grid-template-columns: 1fr; } .small-chart-area{ height:200px; } }
      .card.chart-card canvas{ display:block; width:100% !important; height:100% !important; }

      .card.chart-card h2{ font-size:18px; margin-bottom:8px; }
      .forecast-header-mini { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
      .btn-group .btn { border-radius:8px; }
      .btn-ghost.btn-active{ background:var(--accent); color:#000; box-shadow:0 6px 18px rgba(16,24,40,0.06); }
      .btn{ transition: all .12s ease-in-out; }

      /* Move legend to top-left and make it lighter */
      .legend-row { display:flex; justify-content:flex-start; gap:18px; flex-wrap:wrap; padding:8px 0 18px 0; border-top:0; margin-top:8px; }
      .legend-item { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-secondary); }
      .legend-swatch { width:16px; height:16px; border-radius:4px; box-shadow: 0 1px 0 rgba(0,0,0,0.04); }
      .legend-swatch.actual { background:#f97316; }
      .legend-swatch.predicted { background:#f59e0b; border:none; }
      .legend-swatch.bound { background:#fecaca; opacity:0.9; border-radius:2px; }

      /* Empty chart notice improvements */
      .empty-notice{ position:absolute; top:48%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,0.95); padding:14px 18px; border-radius:8px; box-shadow:0 8px 24px rgba(16,24,40,0.06); color:var(--text-secondary); }

      /* Friendly error banner shown in the chart header when API errors occur */
      .forecast-error{ background: linear-gradient(90deg, rgba(253,224,71,0.12), rgba(255,255,255,0.02)); border:1px solid rgba(250,204,21,0.12); padding:10px 12px; border-radius:8px; color:var(--text-secondary); margin-top:8px; }
      .debug-panel{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; font-size:12px; }

      /* Hero tweaks */
      .forecast-hero-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:20px; align-items:stretch; margin-bottom:28px; }
      .forecast-hero-card{ background:#fff; border-radius:16px; padding:20px 22px; box-shadow:0 6px 18px rgba(16,24,40,0.04); border:1px solid #eef2f6; min-height:140px; position:relative; display:flex; flex-direction:column; justify-content:space-between; }
      .forecast-hero-card .hero-icon{ width:44px; height:44px; border-radius:10px; background:linear-gradient(180deg,#eef7ff,#f8fbff); display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(16,24,40,0.03); }
      .forecast-hero-card .hero-title{ font-size:13px; font-weight:800; }
      .forecast-hero-card .hero-amount{ font-size:34px; font-weight:900; margin-top:8px; color:#111; }
      .conf-pill{ display:inline-block; padding:6px 8px; border-radius:999px; background:#fff; border:1px solid rgba(15,23,36,0.06); font-weight:700; font-size:12px; color:var(--text-secondary); }
      .growth-badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; box-shadow: 0 2px 8px rgba(16,24,40,0.04); }
      .growth-up{ background:#ecfdf5; color:#065f46; }
      .growth-down{ background:#fff1f2; color:#991b1b; }
      .forecast-hero-card .hero-pct{ position:absolute; top:14px; right:14px; font-size:12px; }
      .forecast-hero-card .hero-icon{ width:44px; height:44px; border-radius:10px; background:rgba(15,23,36,0.03); display:flex; align-items:center; justify-content:center; }
      .forecast-hero-card .hero-title{ font-size:14px; font-weight:700; color:var(--fg); }
      .forecast-hero-card .hero-date{ font-size:12px; color:var(--text-secondary); margin-top:4px; }
      .forecast-hero-card .hero-amount{ font-size:38px; font-weight:900; margin-top:12px; color:#111; }
      .forecast-hero-card .hero-row-bottom{ display:flex; justify-content:space-between; align-items:center; margin-top:12px; font-size:13px; color:var(--text-secondary); }

      /* Centered page wrapper for forecast page */
      .forecast-wrapper { max-width: 1100px; margin: 18px auto; padding: 0 20px; padding-left:36px; box-sizing: border-box; }
      /* Ensure the forecast wrapper stays centered even if the sidebar is hovered/expanded */
      .page-wrapper.sidebar-expanded .main-content .forecast-wrapper,
      .sidebar:hover + .main-content .forecast-wrapper,
      .sidebar:hover ~ .main-content .forecast-wrapper { margin-left: auto !important; margin-right: auto !important; padding-left:36px !important; }
      @media (max-width: 1100px) { .forecast-wrapper { max-width: 98%; padding: 0 12px; padding-left:12px; } }

      /* Responsive tweak: reduce x-label density for small screens */
      @media (max-width: 520px) { .filters-row { flex-direction: column; align-items: stretch; } .filters-actions{ margin-left:0; justify-content:flex-end; }
        .overview-grid { flex-direction: column; }
        .card.chart-card { padding:16px; }
        .legend-row { justify-content:center; }
      }

      /* Product forecast grid and pagination removed */

      /* Removed product grid responsive rules */
      .conf-badge{ padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; }
      .conf-high{ background:#dcfce7; color:#065f46; }
      .conf-medium{ background:#fffbeb; color:#92400e; }
      .conf-low{ background:#fee2e2; color:#991b1b; }

      /* Growth badges for hero tiles */
      .growth-badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; box-shadow: 0 2px 8px rgba(16,24,40,0.04); }
      .growth-up{ background:#ecfdf5; color:#065f46; }
      .growth-down{ background:#fff1f2; color:#991b1b; }
      .forecast-hero-card .hero-pct{ text-align:right; font-size:12px; }
      .forecast-hero-card .hero-icon svg{ opacity:0.85; }

      /* Responsive tweaks */
      @media (max-width: 520px) { .filters-row { flex-direction: column; align-items: stretch; } .filters-actions{ margin-left:0; justify-content:flex-end; }
        .overview-grid { flex-direction: column; }
      }
    </style>
  {% else %}
    <div class="card" style="text-align: center; padding: 48px 24px;">
      <p style="color: var(--text-secondary); font-size: 16px;">Loading forecast data from historical sales...</p>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">Using real pizza sales data for ML predictions.</p>
    </div>
  {% endif %}
  </div> {# .forecast-wrapper #}
{% endblock %}
