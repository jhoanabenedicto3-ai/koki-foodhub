{% extends "layouts/base.html" %}

{% block title %}Forecast - Koki's Foodhub{% endblock %}

{% block content %}
  <div class="forecast-wrapper container">
  {% block extra_head %}
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
  {% endblock %}
  <div class="page-header">
    <h1 class="section-title">üìà Sales Forecast & Analytics</h1>
    <p class="muted">Predictive insights for better planning</p>
  </div>

  <!-- Simplified hero tiles (large summary cards) -->
  <div class="hero-row">
    <div class="hero-card">
      <div class="hero-card-label">Today's Sales</div>
      <div class="hero-card-amount">{{ currency }}{{ today_sales|floatformat:0 }}</div>
      <div class="hero-card-sub">Forecast: {{ today_forecast_preview }} units</div>
    </div>
    <div class="hero-card">
      <div class="hero-card-label">This Week's Sales</div>
      <div class="hero-card-amount">{{ currency }}{{ this_week_sales|floatformat:0 }}</div>
      <div class="hero-card-sub">Forecast: {{ week_forecast_preview }} units</div>
    </div>
    <div class="hero-card">
      <div class="hero-card-label">This Month's Sales</div>
      <div class="hero-card-amount">{{ currency }}{{ this_month_sales|floatformat:0 }}</div>
      <div class="hero-card-sub">Forecast: {{ month_forecast_preview }} units</div>
    </div>
    <div class="hero-badge">Trained on historical DB sales data</div>
  </div>

  <!-- Compact controls removed for simplified UI to match mock -->

  {% if error_message %}
    <div style="margin-bottom: 16px; padding: 12px 16px; background: #fff3f2; border: 1px solid #fcd5d5; color:#7f1d1d; border-radius:8px;">
      <strong>Note:</strong> {{ error_message }}
    </div>
  {% endif %}

  {% if data %}
    <!-- Sales Overview & Prediction Chart -->
    <!-- Sales Overview Cards -->
    <div class="overview-grid" style="display:flex; gap:16px; align-items:stretch; overflow-x:auto; padding-bottom:6px; flex-wrap:wrap; justify-content:center;">
      <div class="overview-card" style="flex:0 0 320px; min-width:260px; max-width:320px; display:flex; margin:8px;">
        <div style="display:flex; align-items:center; gap:12px; width:100%;">
          <div class="card-left">
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Daily Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewDailyTotal">{{ daily_summary.total|default:'‚Äî' }}</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewDailyPct">{% if daily_summary %}{{ daily_summary.pct_change }}% {{ daily_summary.arrow|default:'' }}{% else %}‚Äî{% endif %}</div>
          </div>
          <div class="card-right">
            <div class="badge badge-warning">Predicted</div>
            <div id="overviewDailyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: {{ daily_confidence|floatformat:0 }}%</div>
            <div class="card-icon">üìä</div>
          </div>
        </div>
      </div>

      <div class="overview-card" style="flex:0 0 320px; min-width:260px; max-width:320px; display:flex; margin:8px;">
        <div style="display:flex; align-items:center; gap:12px; width:100%;">
          <div class="card-left">
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Weekly Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewWeeklyTotal">{{ weekly_summary.total|default:'‚Äî' }}</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewWeeklyPct">{% if weekly_summary %}{{ weekly_summary.pct_change }}% {{ weekly_summary.arrow|default:'' }}{% else %}‚Äî{% endif %}</div>
          </div>
          <div class="card-right">
            <div class="badge badge-danger">Predicted</div>
            <div id="overviewWeeklyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: {{ weekly_confidence|floatformat:0 }}%</div>
            <div class="card-icon">‚úîÔ∏è</div>
          </div>
        </div>
      </div>

      <div class="overview-card" style="flex:0 0 320px; min-width:260px; max-width:320px; display:flex; margin:8px;">
        <div style="display:flex; align-items:center; gap:12px; width:100%;">
          <div class="card-left">
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Monthly Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewMonthlyTotal">{{ monthly_summary.total|default:'‚Äî' }}</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewMonthlyPct">{% if monthly_summary %}{{ monthly_summary.pct_change }}% {{ monthly_summary.arrow|default:'' }}{% else %}‚Äî{% endif %}</div>
          </div>
          <div class="card-right">
            <div class="badge badge-warning">Predicted</div>
            <div id="overviewMonthlyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: {{ monthly_confidence|floatformat:0 }}%</div>
            <div class="card-icon">üìÖ</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card chart-card">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: var(--fg);">üìä Sales Prediction (Next 8 Weeks)</h2>
      
      <div style="position: relative; margin-bottom: 12px;" data-insert-charts>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <h3 style="margin:0; font-size:16px; font-weight:700; display:flex; align-items:center; gap:8px;">üìä Sales Prediction
              <canvas id="headerSpark" class="header-spark" role="img" aria-label="Mini forecast sparkline" width="160" height="32"></canvas>
            </h3>
              <span id="forecastStatus" class="muted small-text"></span>
            </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="refreshForecastBtn" class="btn" aria-label="Refresh forecasts"><span class="btn-icon">üîÑ</span> <span class="btn-text">Refresh</span></button>
          </div>
        </div>
        <div style="margin-top:8px;">
          <!-- User-facing friendly error banner (hidden by default). Click 'Show details' to reveal raw server response -->
          <div id="forecastError" class="forecast-error" style="display:none;">
            <div style="display:flex; gap:8px; align-items:center;">
              <strong style="margin-right:8px;">Forecast temporarily unavailable</strong>
              <span id="forecastErrorMsg" style="color:var(--text-secondary);"></span>
              <button id="forecastToggleDetails" class="btn btn-ghost" style="margin-left:12px; display:none;">Show details</button>
            </div>
          </div>

          <pre id="forecastDebug" class="debug-panel" style="display:none; max-height:220px; overflow:auto; background:#0f1724; color:#e6edf3; padding:12px; border-radius:8px; font-size:12px; margin-top:8px; border:1px solid rgba(255,255,255,0.04);"></pre>

          {% if debug_mode %}
            <pre id="serverDebug" style="display:block; max-height:240px; overflow:auto; background:#f8fafc; color:#111; padding:8px; border-radius:6px; font-size:12px; border:1px solid var(--border); margin-top:6px;">Server context:\n
Data source: {{ data_source }}\n
Counts - daily: {{ daily_count }} weekly: {{ weekly_count }} monthly: {{ monthly_count }}\n
Daily summary: {{ daily_summary }}\n
Weekly summary: {{ weekly_summary }}\n
Monthly summary: {{ monthly_summary }}\n
Daily confidence: {{ daily_confidence }}\n
Weekly confidence: {{ weekly_confidence }}\n
Monthly confidence: {{ monthly_confidence }}\n
JSON snippets:\n daily_json: {{ daily_json|truncatechars:400 }}\n weekly_json: {{ weekly_json|truncatechars:400 }}\n monthly_json: {{ monthly_json|truncatechars:400 }}
            </pre>
          {% endif %}
              <button id="btnDaily" class="btn btn-ghost" style="font-weight:700;" aria-label="Daily view">Daily</button>
              <button id="btnWeekly" class="btn btn-ghost btn-active" style="font-weight:700;" aria-label="Weekly view">Weekly</button>
              <button id="btnMonthly" class="btn btn-ghost" style="font-weight:700;" aria-label="Monthly view">Monthly</button>
            </div>
          </div>


            <!-- Split view: Actual and Forecast cards -->
            <div class="two-up">
              <div class="card small-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div style="font-weight:700;">Actual</div>
                  <div class="muted small-text">Historical data</div>
                </div>
                <div class="chart-area small-chart-area">
                  <canvas id="actualChart" role="img" aria-label="Actual sales chart"></canvas>
                </div>
              </div>

              <div class="card small-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div style="font-weight:700;">Forecast</div>
                  <div class="muted small-text">Predicted values (upper/lower)</div>
                </div>
                <div class="chart-area small-chart-area">
                  <canvas id="forecastChart" role="img" aria-label="Forecast chart"></canvas>
                </div>
              </div>
            </div>

        </div>

        <!-- Removed separate forecast-only chart to simplify layout. Forecast is shown on the main chart. -->

      <div class="legend-row">
        <div class="legend-item">
          <div class="legend-swatch actual"></div>
          <span class="muted">Actual</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch predicted"></div>
          <span class="muted">Forecast</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch bound"></div>
          <span class="muted">Prediction bounds</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Safely parse server-provided JSON data for charts (defensive: avoid halting script)
      let daily = {labels: [], actual: [], forecast: [], upper: [], lower: [], confidence: 0};
      let weekly = {labels: [], actual: [], forecast: [], upper: [], lower: [], confidence: 0};
      let monthly = {labels: [], actual: [], forecast: [], upper: [], lower: [], confidence: 0};
      try { daily = JSON.parse('{{ daily_json|escapejs }}') || daily; } catch(e){ console.warn('daily_json parse failed', e); }
      try { weekly = JSON.parse('{{ weekly_json|escapejs }}') || weekly; } catch(e){ console.warn('weekly_json parse failed', e); }
      try { monthly = JSON.parse('{{ monthly_json|escapejs }}') || monthly; } catch(e){ console.warn('monthly_json parse failed', e); }
      // Expose to window for simplified single-chart updates
      window.daily = daily;
      window.weekly = weekly;
      window.monthly = monthly;

      // Helper: build forecast labels using actual dates when possible (daily/weekly/monthly)
      function buildForecastLabels(existingLabels, forecastLen, granularity){
        if(!forecastLen || forecastLen <= 0) return [];
        if(!existingLabels || existingLabels.length === 0){
          return Array.from({length: forecastLen}, (_, i) => 'F+' + (i+1));
        }
        const lastLabel = existingLabels[existingLabels.length - 1];
        try {
          if(granularity === 'daily'){
            const base = new Date(lastLabel);
            return Array.from({length: forecastLen}, (_, i) => {
              const d = new Date(base);
              d.setDate(base.getDate() + (i+1));
              return d.toISOString().slice(0,10);
            });
          } else if(granularity === 'weekly'){
            const base = new Date(lastLabel);
            return Array.from({length: forecastLen}, (_, i) => {
              const d = new Date(base);
              d.setDate(base.getDate() + 7*(i+1));
              return d.toISOString().slice(0,10);
            });
          } else if(granularity === 'monthly'){
            // lastLabel expected 'YYYY-MM'
            const parts = (lastLabel||'').split('-').map(Number);
            if(parts.length >= 2){
              const y = parts[0]; const m = parts[1] - 1;
              return Array.from({length: forecastLen}, (_, i) => {
                const d = new Date(y, m + (i+1), 1);
                return d.toISOString().slice(0,7);
              });
            }
          }
        } catch(e){ /* fall back */ }
        return Array.from({length: forecastLen}, (_, i) => 'F+' + (i+1));
      }

      // Format labels for display (e.g., 'Nov 24' or 'Nov 2025') but keep raw ISO labels accessible for tooltips
      function formatLabel(label, granularity){
        if(!label) return label;
        try{
          if(granularity === 'daily' || granularity === 'weekly'){
            const d = new Date(label);
            const opts = { month: 'short', day: 'numeric' };
            return d.toLocaleDateString(undefined, opts); // e.g., 'Nov 24'
          } else if(granularity === 'monthly'){
            const parts = (label||'').split('-').map(Number);
            if(parts.length >= 2){
              const d = new Date(parts[0], parts[1]-1, 1);
              const opts = { month: 'short', year: 'numeric' };
              return d.toLocaleDateString(undefined, opts); // e.g., 'Nov 2025'
            }
          }
        }catch(e){ /* fallback */ }
        return label;
      }

      // Format currency values simply using the page 'currency' context variable (symbol)
      window.currencySymbol = '{{ currency|escapejs }}' || '';
      function formatCurrency(v){
        if(v === null || v === undefined) return '-';
        // Use toLocaleString for thousands separators
        return (window.currencySymbol || '') + Number(v).toLocaleString();
      }

      // Format plain numbers (units) without currency symbol
      function formatNumber(v){
        if(v === null || v === undefined) return '-';
        return Number(v).toLocaleString();
      }

      function renderAreaChart(canvasId, data, granularity) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = data.labels.slice();
        // Prepare combined arrays: extend labels with date-aware forecast labels
        const forecastLabelsRaw = buildForecastLabels(labels, data.forecast.length, granularity);
        const combinedRaw = labels.concat(forecastLabelsRaw);
        const displayLabels = combinedRaw.map(l => formatLabel(l, granularity));

        const actualExtended = data.actual.slice();
        // Pad actual with nulls for forecast region so Chart.js shows forecast as separate series
        const actualPadded = actualExtended.concat(Array(data.forecast.length).fill(null));

        const forecastPadding = Array(labels.length).fill(null).concat(data.forecast);
        const upperPadding = Array(labels.length).fill(null).concat(data.upper);
        const lowerPadding = Array(labels.length).fill(null).concat(data.lower);

        const chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: displayLabels,
            datasets: [
              {
                label: 'Actual',
                data: actualPadded,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(59,130,246,0.08)',
                fill: true,
                tension: 0.36,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2
              },
              {
                label: 'Forecast',
                data: forecastPadding,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16,185,129,0.06)',
                fill: false,
                borderDash: [6,4],
                tension: 0.3,
                pointRadius: 4,
                pointStyle: 'circle',
                borderWidth: 2
              },
              {
                label: 'Upper',
                data: upperPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              },
              {
                label: 'Lower',
                data: lowerPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.04)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { left: 18, right: 18, top: 18, bottom: 16 } },
            plugins: {
              // Use our HTML legend instead of Chart.js internal legend to avoid overlap
              legend: { display: false },
              tooltip: {
                mode: 'index', intersect: false,
                callbacks: {
                  title: function(context){ const idx = context[0].dataIndex; return this.chart._rawLabels ? this.chart._rawLabels[idx] : context[0].label; },
                  label: function(ctx){ const v = ctx.raw; return ctx.dataset.label + ': ' + formatNumber(v); }
                }
              }
            },
            scales: {
              y: { beginAtZero: true, ticks: { callback: function(v){ return (v === 0 ? '0' : formatNumber(v)); } } },
              x: { display: true, ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 12 }, grid: { drawOnChartArea: true } }
            }
          }
        });
        // Store raw labels on the chart instance for tooltip titles
        chart._rawLabels = combinedRaw;
        chart._granularity = granularity;
        return chart;
      }

      // Render separate actual and forecast charts (default to weekly)
      window.currentView = 'weekly';
      window.actualChart = null;
      window.forecastChart = null;
      try {
        // Render header sparkline
        try { renderSparkline('headerSpark', weekly, { height: 28, limit: 8, color: '#10b981', bg: 'rgba(16,185,129,0.06)' }); } catch(e){ console.warn('header sparkline init failed', e); }

        // Actual chart: only plot historical actuals
        if(document.getElementById('actualChart') && weekly && Array.isArray(weekly.labels) && weekly.labels.length){
          window.actualChart = renderLineOnlyChart('actualChart', weekly, 'weekly');
        } else if(document.getElementById('actualChart')){
          const parent = document.getElementById('actualChart').parentElement;
          const notice = document.createElement('div');
          notice.className = 'empty-notice'; notice.style.position = 'absolute'; notice.style.top = '50%'; notice.style.left = '50%'; notice.style.transform = 'translate(-50%, -50%)'; notice.style.background = 'rgba(255,255,255,0.9)'; notice.style.padding = '12px 16px'; notice.style.borderRadius = '8px'; notice.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)'; notice.textContent = 'No historical data available'; parent.style.position = 'relative'; parent.appendChild(notice);
        }

        // Forecast chart: show forecast series and bounds
        if(document.getElementById('forecastChart') && weekly && Array.isArray(weekly.labels)){
          window.forecastChart = renderForecastOnlyChart('forecastChart', weekly, 'weekly');
        }
      } catch(e){ console.warn('chart init failed', e); }

      function setActiveButton(view){
        document.getElementById('btnDaily').classList.toggle('btn-active', view === 'daily');
        document.getElementById('btnWeekly').classList.toggle('btn-active', view === 'weekly');
        document.getElementById('btnMonthly').classList.toggle('btn-active', view === 'monthly');
      }

      document.getElementById('btnDaily').addEventListener('click', function(){
        setActiveButton('daily');
        window.currentView = 'daily';
        const series = window.daily;
        // recreate both small charts for the view
        try{ if(window.actualChart){ try{ window.actualChart.destroy(); }catch(e){} } window.actualChart = renderLineOnlyChart('actualChart', series, 'daily'); } catch(e){ console.warn('update actual failed', e); }
        try{ if(window.forecastChart){ try{ window.forecastChart.destroy(); }catch(e){} } window.forecastChart = renderForecastOnlyChart('forecastChart', series, 'daily'); } catch(e){ console.warn('update forecast failed', e); }
        try { updateSparkline('headerSpark', series); } catch(e){ console.warn('update sparkline failed', e); }
      });
      document.getElementById('btnWeekly').addEventListener('click', function(){
        setActiveButton('weekly');
        window.currentView = 'weekly';
        const series = window.weekly;
        try{ if(window.actualChart){ try{ window.actualChart.destroy(); }catch(e){} } window.actualChart = renderLineOnlyChart('actualChart', series, 'weekly'); } catch(e){ console.warn('update actual failed', e); }
        try{ if(window.forecastChart){ try{ window.forecastChart.destroy(); }catch(e){} } window.forecastChart = renderForecastOnlyChart('forecastChart', series, 'weekly'); } catch(e){ console.warn('update forecast failed', e); }
        try { updateSparkline('headerSpark', series); } catch(e){ console.warn('update sparkline failed', e); }
      });
      document.getElementById('btnMonthly').addEventListener('click', function(){
        setActiveButton('monthly');
        window.currentView = 'monthly';
        const series = window.monthly;
        try{ if(window.actualChart){ try{ window.actualChart.destroy(); }catch(e){} } window.actualChart = renderLineOnlyChart('actualChart', series, 'monthly'); } catch(e){ console.warn('update actual failed', e); }
        try{ if(window.forecastChart){ try{ window.forecastChart.destroy(); }catch(e){} } window.forecastChart = renderForecastOnlyChart('forecastChart', series, 'monthly'); } catch(e){ console.warn('update forecast failed', e); }
        try { updateSparkline('headerSpark', series); } catch(e){ console.warn('update sparkline failed', e); }
      });

      // Helper to update existing Chart.js chart with new data (legacy single-chart)
      function updateChart(chartObj, newData) {
        if(!chartObj) return;
        const labels = newData.labels.slice();
        const gran = window.currentView || 'weekly';
        const forecastLabelsRaw = buildForecastLabels(labels, newData.forecast.length, gran);
        const combinedRaw = labels.concat(forecastLabelsRaw);
        const displayLabels = combinedRaw.map(l => formatLabel(l, gran));
        chartObj.data.labels = displayLabels;
        chartObj._rawLabels = combinedRaw;

        // Actual padded
        const actualPadded = newData.actual.concat(Array(newData.forecast.length).fill(null));
        chartObj.data.datasets[0].data = actualPadded;

        // Forecast padded
        const forecastPadded = Array(newData.actual.length).fill(null).concat(newData.forecast);
        chartObj.data.datasets[1].data = forecastPadded;

        // Upper / Lower
        chartObj.data.datasets[2].data = Array(newData.actual.length).fill(null).concat(newData.upper);
        chartObj.data.datasets[3].data = Array(newData.actual.length).fill(null).concat(newData.lower);

        chartObj.update();
      }

      // Render a simple line-only chart for historical actuals
      function renderLineOnlyChart(canvasId, data, granularity){
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = data.labels.slice().map(l => formatLabel(l, granularity));
        const chart = new Chart(ctx, {
          type: 'line',
          data:{ labels: labels, datasets:[{ label: 'Actual', data: data.actual, borderColor: '#2563eb', backgroundColor: 'rgba(59,130,246,0.08)', fill: true, tension: 0.36, pointRadius: 3, borderWidth: 2 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ title: function(ctx){ return this.chart._rawLabels ? this.chart._rawLabels[ctx[0].dataIndex] : ctx[0].label; }, label: function(ctx){ return ctx.dataset.label + ': ' + formatNumber(ctx.raw); } } } }, scales:{ y:{ beginAtZero:true, ticks:{ callback: function(v){ return (v===0? '0': formatNumber(v)); } } }, x:{ ticks:{ maxRotation:30, autoSkip:true, maxTicksLimit:8 } } } }
        });
        chart._rawLabels = data.labels.slice();
        chart._granularity = granularity;
        return chart;
      }

      // Render forecast-only chart (forecast + bounds)
      function renderForecastOnlyChart(canvasId, data, granularity){
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = data.labels.slice();
        const forecastLabelsRaw = buildForecastLabels(labels, data.forecast.length, granularity);
        const combinedRaw = labels.concat(forecastLabelsRaw);
        const displayLabels = combinedRaw.map(l => formatLabel(l, granularity));

        const forecastOnly = Array(labels.length).fill(null).concat(data.forecast);
        const upperOnly = Array(labels.length).fill(null).concat(data.upper);
        const lowerOnly = Array(labels.length).fill(null).concat(data.lower);

        const chart = new Chart(ctx, {
          type:'line',
          data:{ labels: displayLabels, datasets:[
            { label:'Forecast', data: forecastOnly, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.06)', fill:false, borderDash:[6,4], tension:0.3, pointRadius:3, borderWidth:2 },
            { label:'Upper', data: upperOnly, borderColor:'rgba(254,202,202,0.9)', backgroundColor:'rgba(254,202,202,0.08)', fill:'-1', pointRadius:0, borderWidth:1 },
            { label:'Lower', data: lowerOnly, borderColor:'rgba(254,202,202,0.9)', backgroundColor:'rgba(254,202,202,0.04)', fill:'-1', pointRadius:0, borderWidth:1 }
          ] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false, callbacks:{ title:function(context){ const idx = context[0].dataIndex; return this.chart._rawLabels ? this.chart._rawLabels[idx] : context[0].label; }, label:function(ctx){ return ctx.dataset.label + ': ' + formatNumber(ctx.raw); } } } }, scales:{ y:{ beginAtZero:true, ticks:{ callback:function(v){ return (v===0? '0': formatNumber(v)); } } }, x:{ ticks:{ maxRotation:30, autoSkip:true, maxTicksLimit:8 } } } }
        });
        chart._rawLabels = combinedRaw;
        chart._granularity = granularity;
        return chart;
      }

      // Small sparkline utility supporting multiple canvas instances
      window.sparklines = window.sparklines || {};
      function renderSparkline(canvasId, series, opts){
        const c = document.getElementById(canvasId);
        if(!c) return null;
        const ctx = c.getContext('2d');
        const limit = (opts && opts.limit) || 8;
        const seriesData = (series && series.forecast && series.forecast.length) ? series.forecast.slice(0,limit) : (series && series.actual ? series.actual.slice(-limit) : []);
        const height = (opts && opts.height) || c.height || 32;
        c.style.height = height + 'px';
        // destroy any existing instance for that canvas
        if(window.sparklines[canvasId]){ try{ window.sparklines[canvasId].destroy(); }catch(e){} window.sparklines[canvasId] = null; }
        const chart = new Chart(ctx, {
          type: 'line',
          data: { labels: seriesData.map((_,i) => i+1), datasets: [{ data: seriesData, borderColor: (opts && opts.color) || '#10b981', backgroundColor: (opts && opts.bg) || 'rgba(16,185,129,0.08)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: (opts && opts.borderWidth) || 2 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: !!(opts && opts.tooltip) } }, scales: { x: { display: false }, y: { display: false } }, elements: { line: { capBezierPoints: true } } }
        });
        window.sparklines[canvasId] = chart;
        return chart;
      }

      function updateSparkline(canvasId, series){
        const chart = window.sparklines[canvasId];
        const limit = 8;
        const d = (series && series.forecast && series.forecast.length) ? series.forecast.slice(0,limit) : (series && series.actual ? series.actual.slice(-limit) : []);
        if(chart){ chart.data.datasets[0].data = d; chart.update(); } else { renderSparkline(canvasId, series); }
      }

      // Forecast-only chart removed to simplify UI; forecast series are drawn on the main chart.

      function showForecastError(message, details){
        const errEl = document.getElementById('forecastError');
        const debugEl = document.getElementById('forecastDebug');
        const toggleBtn = document.getElementById('forecastToggleDetails');
        if(!errEl) return;
        errEl.style.display = 'block';
        document.getElementById('forecastErrorMsg').textContent = '‚Äî ' + message;
        if(debugEl && details){
          debugEl.textContent = details;
          toggleBtn.style.display = 'inline-block';
        } else if(debugEl){
          debugEl.textContent = '';
          toggleBtn.style.display = 'none';
        }
      }

      // Wire the details toggle
      document.addEventListener('click', function(e){
        if(e.target && e.target.id === 'forecastToggleDetails'){
          const debugEl = document.getElementById('forecastDebug');
          const btn = document.getElementById('forecastToggleDetails');
          if(!debugEl) return;
          if(debugEl.style.display === 'block'){
            debugEl.style.display = 'none'; btn.textContent = 'Show details';
          } else {
            debugEl.style.display = 'block'; btn.textContent = 'Hide details';
          }
        }
      });

      function setConfBadge(elId, pct){
        const el = document.getElementById(elId);
        if(!el) return;
        const conf = Math.round(pct || 0);
        let cls = 'conf-low';
        let text = 'Low';
        if(conf >= 70){ cls = 'conf-high'; text = 'High'; }
        else if(conf >= 40){ cls = 'conf-medium'; text = 'Medium'; }
        el.innerHTML = `<span class="conf-badge ${cls}">${text}</span> ${conf}%`;
      }

      // Forecast controls removed.

      // Fetch API to refresh the charts
      async function refreshForecast() {
        const statusEl = document.getElementById('forecastStatus');
        const refreshBtn = document.getElementById('refreshForecastBtn');
        try {
          statusEl.textContent = 'Updating...';
          refreshBtn.classList.add('loading');
          refreshBtn.querySelector('.btn-text').textContent = 'Updating...';
          // Simplified: fetch forecasts without extra filter params (no UI filters in simplified view)
          const url = '{% url "forecast_api" %}';
          const res = await fetch(url, { credentials: 'same-origin' });
          // Check HTTP status first
          if (!res.ok) {
            const text = await res.text().catch(()=>'');
            showForecastError(`Server error (${res.status})`, text.slice(0,2000));
            throw new Error('Network response not ok: ' + res.status);
          }
          const contentType = (res.headers.get('content-type') || '').toLowerCase();
          if (!contentType.includes('application/json')){
            const txt = await res.text().catch(()=>'');
            showForecastError('Unexpected server response', txt.slice(0,2000));
            throw new Error('Non-JSON response received');
          }
          const json = await res.json();
          // simplified: no debug panel; do not dump JSON to the page
          document.getElementById('dataSource').textContent = json.data_source || 'unknown';
          document.getElementById('dailyCount').textContent = json.daily.labels.length || 0;
          document.getElementById('weeklyCount').textContent = json.weekly.labels.length || 0;
          document.getElementById('monthlyCount').textContent = json.monthly.labels.length || 0;

          // Update overview cards
          if(json.summary){
            const s = json.summary;
            const d = s.daily || {};
            const w = s.weekly || {};
            const m = s.monthly || {};
            document.getElementById('overviewDailyTotal').textContent = d.total || 0;
            document.getElementById('overviewDailyPct').textContent = ((d.pct_change || 0) + '% ' + (d.arrow === 'up' ? '‚Üë' : d.arrow === 'down' ? '‚Üì' : '')).replace('NaN%','0%');
            setConfBadge('overviewDailyConf', json.daily.confidence || 0);
            document.getElementById('overviewWeeklyTotal').textContent = w.total || 0;
            document.getElementById('overviewWeeklyPct').textContent = ((w.pct_change || 0) + '% ' + (w.arrow === 'up' ? '‚Üë' : w.arrow === 'down' ? '‚Üì' : '')).replace('NaN%','0%');
            setConfBadge('overviewWeeklyConf', json.weekly.confidence || 0);
            document.getElementById('overviewMonthlyTotal').textContent = m.total || 0;
            document.getElementById('overviewMonthlyPct').textContent = ((m.pct_change || 0) + '% ' + (m.arrow === 'up' ? '‚Üë' : m.arrow === 'down' ? '‚Üì' : '')).replace('NaN%','0%');
            setConfBadge('overviewMonthlyConf', json.monthly.confidence || 0);
          }

          // If no data, show message over charts
          function showEmptyNotice(id, msg){
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const parent = canvas.parentElement;
            let notice = parent.querySelector('.empty-notice');
            if(!notice){
              notice = document.createElement('div');
              notice.className = 'empty-notice';
              notice.style.position = 'absolute';
              notice.style.top = '50%';
              notice.style.left = '50%';
              notice.style.transform = 'translate(-50%, -50%)';
              notice.style.background = 'rgba(255,255,255,0.9)';
              notice.style.padding = '12px 16px';
              notice.style.borderRadius = '8px';
              notice.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
              parent.style.position = 'relative';
              parent.appendChild(notice);
            }
            notice.textContent = msg;
          }

          // Clear any existing notice on the main chart
          (function(){ const c = document.getElementById('salesChart'); if(c && c.parentElement){ const n = c.parentElement.querySelector('.empty-notice'); if(n) n.remove(); } })();

          // Replace global series with updated data
          window.daily = json.daily || window.daily;
          window.weekly = json.weekly || window.weekly;
          window.monthly = json.monthly || window.monthly;

          // If current view has no labels, show an empty notice on the main chart
          const currentSeries = (window.currentView === 'daily' ? window.daily : window.currentView === 'monthly' ? window.monthly : window.weekly);
          if(!currentSeries || !currentSeries.labels || !currentSeries.labels.length){ showEmptyNotice('salesChart', 'No data available for the selected view'); }

          // Update both actual and forecast charts with the currently selected view
          const mapping = { 'daily': window.daily, 'weekly': window.weekly, 'monthly': window.monthly };
          const series = mapping[window.currentView] || window.weekly;
          if(window.actualChart){ try{ window.actualChart.destroy(); }catch(e){} window.actualChart = renderLineOnlyChart('actualChart', series, window.currentView); }
          if(window.forecastChart){ try{ window.forecastChart.destroy(); }catch(e){} window.forecastChart = renderForecastOnlyChart('forecastChart', series, window.currentView); }
          try { updateSparkline('headerSpark', mapping[window.currentView] || window.weekly); } catch(e){ console.warn('refresh sparkline failed', e); }

          // AI insights area removed in simplified UI

          // product filter removed in simplified UI
          statusEl.textContent = 'Updated just now';
        } catch (e) {
          console.error('refresh error', e);
          statusEl.textContent = 'Update failed';
        } finally {
          setTimeout(()=>{ if(statusEl.textContent === 'Update failed' || statusEl.textContent === 'Updated just now') statusEl.textContent = ''; }, 2500);
          refreshBtn.classList.remove('loading');
          const t = refreshBtn.querySelector('.btn-text'); if(t) t.textContent = 'Refresh';
        }
      }

      document.getElementById('refreshForecastBtn').addEventListener('click', refreshForecast);

      // Filter controls removed in simplified UI; keep refresh bound
      document.getElementById('applyFilters')?.addEventListener('click', function(){ refreshForecast(); });

      // Auto-refresh after load
      window.addEventListener('load', function(){ setTimeout(refreshForecast, 600); });

      // Debug toggle removed in simplified UI
    </script>

    <!-- Analytics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <!-- Next Week Sales (horizontal layout) -->
      <div class="analytics-card-horizontal">
        <div style="display:flex; gap:12px; align-items:center;">
          <div>
            <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Next Week Sales</h3>
            <h2 style="margin: 8px 0 8px 0; color: var(--fg);">{{ currency }}{{ total_forecast|floatformat:0 }}</h2>
            <p style="margin: 0; font-size: 13px; color: #22c55e; font-weight: 600;">
              {% if growth_percentage >= 0 %}
                +{{ growth_percentage|floatformat:1 }}% increase expected
              {% else %}
                {{ growth_percentage|floatformat:1 }}% decrease expected
              {% endif %}
            </p>
          </div>
        </div>
        <div class="card-icon">üìà</div>
      </div>

      <!-- Forecast Accuracy (horizontal layout) -->
      <div class="analytics-card-horizontal">
        <div style="display:flex; gap:12px; align-items:center;">
          <div>
            <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Forecast Accuracy</h3>
            <h2 style="margin: 8px 0 8px 0; color: var(--fg);">{{ avg_confidence|floatformat:1 }}%</h2>
            <p style="margin: 0; font-size: 13px; color: #0ea5e9; font-weight: 600;">High confidence</p>
          </div>
        </div>
        <div class="card-icon">‚úì</div>
      </div>

      <!-- Peak Day (horizontal layout) -->
      <div class="analytics-card-horizontal">
        <div style="display:flex; gap:12px; align-items:center;">
          <div>
            <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Peak Day</h3>
            <h2 style="margin: 8px 0 8px 0; color: var(--fg);">{{ peak_day }}</h2>
            <p style="margin: 0; font-size: 13px; color: #f97316; font-weight: 600;">Expected: {{ peak_orders }} orders</p>
          </div>
        </div>
        <div class="card-icon">üìÖ</div>
      </div>
    </div>

    <!-- Simplified layout: diagnostics and debug panel removed for cleaner UI -->

    <!-- Product forecasts removed per request -->

    <style>
      /* Local styles to improve layout, spacing and visual hierarchy */
      .muted { color: var(--text-secondary); }
      .small-text { font-size: 13px; }
      .page-header { margin-bottom: 28px; }
      .filters-card { background: #fff; border: 1px solid var(--border); padding: 14px 16px; border-radius: 10px; margin-bottom: 18px; box-shadow: var(--shadow-sm); }
      .filters-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .filters-group { display:flex; gap:8px; align-items:center; }
      .filter-label { font-weight:700; font-size:13px; color:var(--text-secondary); }
      .filter-input { padding:8px; border:1px solid var(--border); border-radius:6px; min-width:160px; }
      .filters-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

      .btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; font-weight:700; cursor:pointer; }
      .btn-ghost { background:transparent; border:1px solid var(--border); }
      .btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
      .btn .btn-icon { margin-right:6px; }
      .btn.loading { opacity:0.8; pointer-events:none; }

      /* Dark theme hero tiles */
      /* Hero summary row (simplified to match mock) */
      .hero-row { display:flex; gap:16px; align-items:stretch; margin-bottom:18px; }
      .hero-card { flex:1; background:#fff; border-radius:12px; padding:18px 20px; box-shadow:var(--shadow-sm); border:1px solid var(--border); }
      .hero-card-label { font-size:13px; color:var(--text-secondary); font-weight:700; }
      .hero-card-amount { font-size:36px; font-weight:900; margin-top:6px; color:var(--fg); }
      .hero-card-sub { margin-top:8px; color:var(--text-secondary); font-weight:700; font-size:13px; }
      .hero-badge { align-self:center; padding:8px 12px; background:#f3f4f6; border-radius:8px; font-weight:700; font-size:13px; color:var(--text-secondary); }

      .overview-grid { display:flex !important; gap:16px; margin-bottom:18px; align-items:stretch; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:6px; justify-content:space-between; flex-wrap:wrap; position:relative; }
      .overview-grid .overview-card { flex: 1 1 calc(33.333% - 16px); min-width:260px; max-width:calc(33.333% - 16px); background:#fff; border-radius:10px; padding:20px 24px; box-shadow:var(--shadow-sm); border:1px solid rgba(0,0,0,0.18); min-height:110px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .overview-grid .overview-card .card-left { flex:1 1 auto; }
      .overview-grid .overview-card .card-right { display:flex; align-items:center; gap:8px; margin-left:12px; }
      .overview-grid .overview-card .card-icon { width:44px; height:44px; border-radius:8px; background:rgba(15,23,36,0.03); display:flex; align-items:center; justify-content:center; }
      /* Responsive breakpoints: 3-up -> 2-up -> 1-up */
      @media (max-width: 980px) { .overview-grid .overview-card { flex: 1 1 calc(50% - 12px); max-width: calc(50% - 12px); } }
      @media (max-width: 680px) { .overview-grid { gap: 12px; } .overview-grid .overview-card { flex:1 1 100%; max-width:100%; } }

      /* When the sidebar overlays or is expanded, keep cards on one horizontal row that can be scrolled into view */
      .page-wrapper.sidebar-expanded .overview-grid,
      .sidebar:hover + .main-content .overview-grid,
      .sidebar:hover ~ .main-content .overview-grid {
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
      }
      .page-wrapper.sidebar-expanded .overview-grid .overview-card { flex: 0 0 320px !important; min-width:320px !important; max-width:320px !important; }
      .page-wrapper.sidebar-expanded .overview-grid::after { content: ''; position: absolute; right: 0; top: 0; width: 48px; height: 100%; pointer-events: none; background: linear-gradient(to left, rgba(255,255,255,0.95), rgba(255,255,255,0)); }

      /* Shift the inner content container to the right when the sidebar expands or is hovered so cards are not hidden */
      .page-wrapper.sidebar-expanded .main-content .container,
      .sidebar:hover + .main-content .container,
      .sidebar:hover ~ .main-content .container {
        margin-left: 208px !important;
        transition: margin-left 220ms ease;
      }
      /* If viewport is very small, use a smaller shift so content stays readable */
      @media (max-width: 900px) {
        .page-wrapper.sidebar-expanded .main-content .container,
        .sidebar:hover + .main-content .container,
        .sidebar:hover ~ .main-content .container { margin-left: 140px !important; }
      }
      .badge { padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; }
      .badge-warning { background:#fef3c7; color:#92400e; }
      .badge-danger { background:#fff3f2; color:#7f1d1d; }

      /* Horizontal analytics cards (aligned visually with hero summary cards) */
      .analytics-card-horizontal {
        background:#fff;
        border:1px solid var(--border);
        border-radius:12px; /* match hero-card rounding */
        padding:18px 20px; /* match hero-card padding */
        box-shadow:var(--shadow-sm);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
        min-height:140px; /* slightly taller to match hero visual weight */
      }
      /* Make the headline number match Today's Sales weight and size */
      .analytics-card-horizontal h2 { font-size:36px; font-weight:900; margin: 8px 0 8px 0; color:var(--fg); }
      .analytics-card-horizontal h3 { margin:0; font-size:14px; font-weight:600; color:var(--text-secondary); }
      .analytics-card-horizontal .card-icon {
        font-size:28px;
        background: rgba(15,23,36,0.03);
        padding:10px 12px;
        border-radius:10px;
        display:flex;
        align-items:center;
        justify-content:center;
        min-width:56px;
        min-height:56px;
      }
      @media (max-width: 720px) {
        .analytics-card-horizontal { flex-direction:column; align-items:flex-start; }
        .analytics-card-horizontal .card-icon { align-self:flex-end; }
        .analytics-card-horizontal h2 { font-size:28px; }
      }

      .card.chart-card { background:#fff; border:1px solid var(--border); border-radius:10px; padding:18px 28px; box-shadow:var(--shadow-sm); margin-bottom:32px; overflow:hidden; }
      .card.chart-card .chart-area { position:relative; height:300px; }
      /* Two column layout for actual / forecast */
      .two-up{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:12px; }
      .small-card{ padding:14px; min-height:180px; }
      .small-chart-area{ height:160px; }
      @media (max-width:720px){ .two-up{ grid-template-columns: 1fr; } .small-chart-area{ height:200px; } }
      .card.chart-card canvas{ display:block; width:100% !important; height:100% !important; }
      .header-spark{ width:140px; height:28px; display:inline-block; vertical-align:middle; margin-left:6px; }
      .card.chart-card h2{ font-size:18px; margin-bottom:8px; }
      .forecast-header-mini { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
      .btn-group .btn { border-radius:8px; }
      .btn-ghost.btn-active{ background:var(--accent); color:#000; box-shadow:0 6px 18px rgba(16,24,40,0.06); }
      .btn{ transition: all .12s ease-in-out; }

      /* Move legend to top-left and make it lighter */
      .legend-row { display:flex; justify-content:flex-start; gap:18px; flex-wrap:wrap; padding:8px 0 18px 0; border-top:0; margin-top:8px; }
      .legend-item { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-secondary); }
      .legend-swatch { width:16px; height:16px; border-radius:4px; box-shadow: 0 1px 0 rgba(0,0,0,0.04); }
      .legend-swatch.actual { background:#2563eb; }
      .legend-swatch.predicted { background:#10b981; border:2px dashed rgba(16,185,129,0.25); }
      .legend-swatch.bound { background:#fecaca; opacity:0.9; border-radius:2px; }

      /* Empty chart notice improvements */
      .empty-notice{ position:absolute; top:48%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,0.95); padding:14px 18px; border-radius:8px; box-shadow:0 8px 24px rgba(16,24,40,0.06); color:var(--text-secondary); }

      /* Friendly error banner shown in the chart header when API errors occur */
      .forecast-error{ background: linear-gradient(90deg, rgba(253,224,71,0.12), rgba(255,255,255,0.02)); border:1px solid rgba(250,204,21,0.12); padding:10px 12px; border-radius:8px; color:var(--text-secondary); margin-top:8px; }
      .debug-panel{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; font-size:12px; }

      /* Hero tweaks */
      .hero-card-amount{ font-size:38px; }
      .hero-card-sub{ opacity:0.95; }

      /* Centered page wrapper for forecast page */
      .forecast-wrapper { max-width: 1100px; margin: 18px auto; padding: 0 20px; padding-left:36px; box-sizing: border-box; }
      /* Ensure the forecast wrapper stays centered even if the sidebar is hovered/expanded */
      .page-wrapper.sidebar-expanded .main-content .forecast-wrapper,
      .sidebar:hover + .main-content .forecast-wrapper,
      .sidebar:hover ~ .main-content .forecast-wrapper { margin-left: auto !important; margin-right: auto !important; padding-left:36px !important; }
      @media (max-width: 1100px) { .forecast-wrapper { max-width: 98%; padding: 0 12px; padding-left:12px; } }

      /* Responsive tweak: reduce x-label density for small screens */
      @media (max-width: 520px) { .filters-row { flex-direction: column; align-items: stretch; } .filters-actions{ margin-left:0; justify-content:flex-end; }
        .overview-grid { flex-direction: column; }
        .card.chart-card { padding:16px; }
        .legend-row { justify-content:center; }
      }

      /* Product forecast grid and pagination removed */

      /* Removed product grid responsive rules */
      .conf-badge{ padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; }
      .conf-high{ background:#dcfce7; color:#065f46; }
      .conf-medium{ background:#fffbeb; color:#92400e; }
      .conf-low{ background:#fee2e2; color:#991b1b; }

      /* Responsive tweaks */
      @media (max-width: 520px) { .filters-row { flex-direction: column; align-items: stretch; } .filters-actions{ margin-left:0; justify-content:flex-end; }
        .overview-grid { flex-direction: column; }
      }
    </style>
  {% else %}
    <div class="card" style="text-align: center; padding: 48px 24px;">
      <p style="color: var(--text-secondary); font-size: 16px;">Loading forecast data from historical sales...</p>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">Using real pizza sales data for ML predictions.</p>
    </div>
  {% endif %}
  </div> {# .forecast-wrapper #}
{% endblock %}
