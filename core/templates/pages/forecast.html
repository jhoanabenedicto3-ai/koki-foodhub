{% extends "layouts/base.html" %}

{% block title %}Forecast - Koki's Foodhub{% endblock %}

{% block content %}
  {% block extra_head %}
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
  {% endblock %}
  <div class="page-header">
    <h1 class="section-title">ðŸ“ˆ Sales Forecast & Analytics</h1>
    <p class="muted">Predictive insights for better planning</p>
  </div>

  <!-- Simplified hero tiles (large summary cards) -->
  <div class="hero-row">
    <div class="hero-card">
      <div class="hero-card-label">Today's Sales</div>
      <div class="hero-card-amount">{{ currency }}{{ today_sales|floatformat:0 }}</div>
      <div class="hero-card-sub">Forecast: {{ currency }}{{ today_forecast_preview }}</div>
    </div>
    <div class="hero-card">
      <div class="hero-card-label">This Week's Sales</div>
      <div class="hero-card-amount">{{ currency }}{{ this_week_sales|floatformat:0 }}</div>
      <div class="hero-card-sub">Forecast: {{ currency }}{{ week_forecast_preview }}</div>
    </div>
    <div class="hero-card">
      <div class="hero-card-label">This Month's Sales</div>
      <div class="hero-card-amount">{{ currency }}{{ this_month_sales|floatformat:0 }}</div>
      <div class="hero-card-sub">Forecast: {{ currency }}{{ month_forecast_preview }}</div>
    </div>
    <div class="hero-badge">Trained on last 100 CSV rows</div>
  </div>

  <!-- Compact controls removed for simplified UI to match mock -->

  {% if error_message %}
    <div style="margin-bottom: 16px; padding: 12px 16px; background: #fff3f2; border: 1px solid #fcd5d5; color:#7f1d1d; border-radius:8px;">
      <strong>Note:</strong> {{ error_message }}
    </div>
  {% endif %}

  {% if data %}
    <!-- Sales Overview & Prediction Chart -->
    <!-- Sales Overview Cards -->
    <div class="overview-grid">
      <div class="overview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div>
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Daily Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewDailyTotal">â€”</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewDailyPct">â€”</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="badge badge-warning">Predicted</div>
            <div id="overviewDailyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: â€”</div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div>
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Weekly Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewWeeklyTotal">â€”</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewWeeklyPct">â€”</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="badge badge-danger">Forecasted</div>
            <div id="overviewWeeklyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: â€”</div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div>
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Monthly Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewMonthlyTotal">â€”</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewMonthlyPct">â€”</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="badge badge-warning">Predicted</div>
            <div id="overviewMonthlyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: â€”</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card chart-card">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: var(--fg);">ðŸ“Š Sales Prediction (Next 8 Weeks)</h2>
      
      <div style="position: relative; height: 440px; margin-bottom: 20px;" data-insert-charts>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <h3 style="margin:0; font-size:16px; font-weight:700;">ðŸ“Š Sales Prediction</h3>
            <div style="display:flex; gap:6px; margin-left:12px;">
              <button id="btnDaily" class="btn btn-ghost" style="font-weight:700;" aria-label="Daily view">Daily</button>
              <button id="btnWeekly" class="btn btn-ghost btn-active" style="font-weight:700;" aria-label="Weekly view">Weekly</button>
              <button id="btnMonthly" class="btn btn-ghost" style="font-weight:700;" aria-label="Monthly view">Monthly</button>
            </div>
          </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="refreshForecastBtn" class="btn" aria-label="Refresh forecasts"><span class="btn-icon">ðŸ”„</span> <span class="btn-text">Refresh</span></button>
              <span id="forecastStatus" class="muted small-text"></span>
            </div>
        </div>
        <div style="position:relative; height:360px;">
          <canvas id="salesChart" style="height:100%; width:100%;" role="img" aria-label="Sales chart showing actual and forecasted sales"></canvas>
        </div>
      </div>

        <!-- Removed separate forecast-only chart to simplify layout. Forecast is shown on the main chart. -->

      <div class="legend-row">
        <div class="legend-item">
          <div class="legend-swatch actual"></div>
          <span class="muted">Today's Sales</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch predicted"></div>
          <span class="muted">Forecast</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Parse server-provided JSON data for charts
      const daily = JSON.parse('{{ daily_json|escapejs }}');
      const weekly = JSON.parse('{{ weekly_json|escapejs }}');
      const monthly = JSON.parse('{{ monthly_json|escapejs }}');
      // Expose to window for simplified single-chart updates
      window.daily = daily;
      window.weekly = weekly;
      window.monthly = monthly;

      function renderAreaChart(canvasId, data, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = data.labels.slice();
        // Prepare combined arrays: extend labels for forecast horizon
        const forecastLabels = labels.concat(Array.from({length: data.forecast.length}, (_, i) => 'F+' + (i+1)));

        const actualExtended = data.actual.slice();
        // Pad actual with nulls for forecast region so Chart.js shows forecast as separate series
        const actualPadded = actualExtended.concat(Array(data.forecast.length).fill(null));

        const forecastPadding = Array(labels.length).fill(null).concat(data.forecast);
        const upperPadding = Array(labels.length).fill(null).concat(data.upper);
        const lowerPadding = Array(labels.length).fill(null).concat(data.lower);

        return new Chart(ctx, {
          type: 'line',
          data: {
            labels: forecastLabels,
            datasets: [
              {
                label: 'Actual',
                data: actualPadded,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(59,130,246,0.06)',
                fill: true,
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Forecast',
                data: forecastPadding,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16,185,129,0.06)',
                fill: false,
                borderDash: [5,4],
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Upper',
                data: upperPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              },
              {
                label: 'Lower',
                data: lowerPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              y: { beginAtZero: true },
              x: { display: true }
            }
          }
        });
      }

      // Render a single chart (default to weekly)
      window.currentView = 'weekly';
      window.mainChart = renderAreaChart('salesChart', weekly, 'Weekly Sales');

      function setActiveButton(view){
        document.getElementById('btnDaily').classList.toggle('btn-active', view === 'daily');
        document.getElementById('btnWeekly').classList.toggle('btn-active', view === 'weekly');
        document.getElementById('btnMonthly').classList.toggle('btn-active', view === 'monthly');
      }

      document.getElementById('btnDaily').addEventListener('click', function(){
        setActiveButton('daily');
        window.currentView = 'daily';
        updateChart(window.mainChart, daily);
      });
      document.getElementById('btnWeekly').addEventListener('click', function(){
        setActiveButton('weekly');
        window.currentView = 'weekly';
        updateChart(window.mainChart, weekly);
      });
      document.getElementById('btnMonthly').addEventListener('click', function(){
        setActiveButton('monthly');
        window.currentView = 'monthly';
        updateChart(window.mainChart, monthly);
      });

      // Helper to update existing Chart.js chart with new data
      function updateChart(chartObj, newData) {
        if(!chartObj) return;
        const labels = newData.labels.slice();
        const paddedLabels = labels.concat(Array.from({length: newData.forecast.length}, (_, i) => 'F+' + (i+1)));
        chartObj.data.labels = paddedLabels;

        // Actual padded
        const actualPadded = newData.actual.concat(Array(newData.forecast.length).fill(null));
        chartObj.data.datasets[0].data = actualPadded;

        // Forecast padded
        const forecastPadded = Array(newData.actual.length).fill(null).concat(newData.forecast);
        chartObj.data.datasets[1].data = forecastPadded;

        // Upper / Lower
        chartObj.data.datasets[2].data = Array(newData.actual.length).fill(null).concat(newData.upper);
        chartObj.data.datasets[3].data = Array(newData.actual.length).fill(null).concat(newData.lower);

        chartObj.update();
      }

      // Forecast-only chart removed to simplify UI; forecast series are drawn on the main chart.

      function setConfBadge(elId, pct){
        const el = document.getElementById(elId);
        if(!el) return;
        const conf = Math.round(pct || 0);
        let cls = 'conf-low';
        let text = 'Low';
        if(conf >= 70){ cls = 'conf-high'; text = 'High'; }
        else if(conf >= 40){ cls = 'conf-medium'; text = 'Medium'; }
        el.innerHTML = `<span class="conf-badge ${cls}">${text}</span> ${conf}%`;
      }

      // Forecast controls removed.

      // Fetch API to refresh the charts
      async function refreshForecast() {
        const statusEl = document.getElementById('forecastStatus');
        const refreshBtn = document.getElementById('refreshForecastBtn');
        try {
          statusEl.textContent = 'Updating...';
          refreshBtn.classList.add('loading');
          refreshBtn.querySelector('.btn-text').textContent = 'Updating...';
          // Simplified: fetch forecasts without extra filter params (no UI filters in simplified view)
          const url = '{% url "forecast_api" %}';
          const res = await fetch(url);
          if (!res.ok) throw new Error('Network response not ok');
          const json = await res.json();
          // simplified: no debug panel; do not dump JSON to the page
          document.getElementById('dataSource').textContent = json.data_source || 'unknown';
          document.getElementById('dailyCount').textContent = json.daily.labels.length || 0;
          document.getElementById('weeklyCount').textContent = json.weekly.labels.length || 0;
          document.getElementById('monthlyCount').textContent = json.monthly.labels.length || 0;

          // Update overview cards
          if(json.summary){
            const s = json.summary;
            const d = s.daily || {};
            const w = s.weekly || {};
            const m = s.monthly || {};
            document.getElementById('overviewDailyTotal').textContent = d.total || 0;
            document.getElementById('overviewDailyPct').textContent = ((d.pct_change || 0) + '% ' + (d.arrow === 'up' ? 'â†‘' : d.arrow === 'down' ? 'â†“' : '')).replace('NaN%','0%');
            setConfBadge('overviewDailyConf', json.daily.confidence || 0);
            document.getElementById('overviewWeeklyTotal').textContent = w.total || 0;
            document.getElementById('overviewWeeklyPct').textContent = ((w.pct_change || 0) + '% ' + (w.arrow === 'up' ? 'â†‘' : w.arrow === 'down' ? 'â†“' : '')).replace('NaN%','0%');
            setConfBadge('overviewWeeklyConf', json.weekly.confidence || 0);
            document.getElementById('overviewMonthlyTotal').textContent = m.total || 0;
            document.getElementById('overviewMonthlyPct').textContent = ((m.pct_change || 0) + '% ' + (m.arrow === 'up' ? 'â†‘' : m.arrow === 'down' ? 'â†“' : '')).replace('NaN%','0%');
            setConfBadge('overviewMonthlyConf', json.monthly.confidence || 0);
          }

          // If no data, show message over charts
          function showEmptyNotice(id, msg){
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const parent = canvas.parentElement;
            let notice = parent.querySelector('.empty-notice');
            if(!notice){
              notice = document.createElement('div');
              notice.className = 'empty-notice';
              notice.style.position = 'absolute';
              notice.style.top = '50%';
              notice.style.left = '50%';
              notice.style.transform = 'translate(-50%, -50%)';
              notice.style.background = 'rgba(255,255,255,0.9)';
              notice.style.padding = '12px 16px';
              notice.style.borderRadius = '8px';
              notice.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
              parent.style.position = 'relative';
              parent.appendChild(notice);
            }
            notice.textContent = msg;
          }

          // Clear any existing notice on the main chart
          (function(){ const c = document.getElementById('salesChart'); if(c && c.parentElement){ const n = c.parentElement.querySelector('.empty-notice'); if(n) n.remove(); } })();

          // Replace global series with updated data
          window.daily = json.daily || window.daily;
          window.weekly = json.weekly || window.weekly;
          window.monthly = json.monthly || window.monthly;

          // If current view has no labels, show an empty notice on the main chart
          const currentSeries = (window.currentView === 'daily' ? window.daily : window.currentView === 'monthly' ? window.monthly : window.weekly);
          if(!currentSeries || !currentSeries.labels || !currentSeries.labels.length){ showEmptyNotice('salesChart', 'No data available for the selected view'); }

          // Update main chart with the currently selected view
          const mapping = { 'daily': window.daily, 'weekly': window.weekly, 'monthly': window.monthly };
          updateChart(window.mainChart, mapping[window.currentView] || window.weekly);

          // AI insights area removed in simplified UI

          // product filter removed in simplified UI
          statusEl.textContent = 'Updated just now';
        } catch (e) {
          console.error('refresh error', e);
          statusEl.textContent = 'Update failed';
        } finally {
          setTimeout(()=>{ if(statusEl.textContent === 'Update failed' || statusEl.textContent === 'Updated just now') statusEl.textContent = ''; }, 2500);
          refreshBtn.classList.remove('loading');
          const t = refreshBtn.querySelector('.btn-text'); if(t) t.textContent = 'Refresh';
        }
      }

      document.getElementById('refreshForecastBtn').addEventListener('click', refreshForecast);

      // Filter controls removed in simplified UI; keep refresh bound
      document.getElementById('applyFilters')?.addEventListener('click', function(){ refreshForecast(); });

      // Auto-refresh after load
      window.addEventListener('load', function(){ setTimeout(refreshForecast, 600); });

      // Debug toggle removed in simplified UI
    </script>

    <!-- Analytics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <!-- Next Week Sales -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Next Week Sales</h3>
          <span style="font-size: 20px;">ðŸ“ˆ</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ currency }}{{ total_forecast|floatformat:0 }}</h2>
        <p style="margin: 0; font-size: 13px; color: #22c55e; font-weight: 600;">
          {% if growth_percentage >= 0 %}
            +{{ growth_percentage|floatformat:1 }}% increase expected
          {% else %}
            {{ growth_percentage|floatformat:1 }}% decrease expected
          {% endif %}
        </p>
      </div>

      <!-- Forecast Accuracy -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Forecast Accuracy</h3>
          <span style="font-size: 20px;">âœ“</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ avg_confidence|floatformat:1 }}%</h2>
        <p style="margin: 0; font-size: 13px; color: #0ea5e9; font-weight: 600;">High confidence</p>
      </div>

      <!-- Peak Day -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Peak Day</h3>
          <span style="font-size: 20px;">ðŸ“…</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ peak_day }}</h2>
        <p style="margin: 0; font-size: 13px; color: #f97316; font-weight: 600;">Expected: {{ peak_orders }} orders</p>
      </div>
    </div>

    <!-- Simplified layout: diagnostics and debug panel removed for cleaner UI -->

    <!-- Product forecasts removed per request -->

    <style>
      /* Local styles to improve layout, spacing and visual hierarchy */
      .muted { color: var(--text-secondary); }
      .small-text { font-size: 13px; }
      .page-header { margin-bottom: 28px; }
      .filters-card { background: #fff; border: 1px solid var(--border); padding: 14px 16px; border-radius: 10px; margin-bottom: 18px; box-shadow: var(--shadow-sm); }
      .filters-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .filters-group { display:flex; gap:8px; align-items:center; }
      .filter-label { font-weight:700; font-size:13px; color:var(--text-secondary); }
      .filter-input { padding:8px; border:1px solid var(--border); border-radius:6px; min-width:160px; }
      .filters-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

      .btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; font-weight:700; cursor:pointer; }
      .btn-ghost { background:transparent; border:1px solid var(--border); }
      .btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
      .btn .btn-icon { margin-right:6px; }
      .btn.loading { opacity:0.8; pointer-events:none; }

      /* Dark theme hero tiles */
      /* Hero summary row (simplified to match mock) */
      .hero-row { display:flex; gap:16px; align-items:stretch; margin-bottom:18px; }
      .hero-card { flex:1; background:#fff; border-radius:12px; padding:18px 20px; box-shadow:var(--shadow-sm); border:1px solid var(--border); }
      .hero-card-label { font-size:13px; color:var(--text-secondary); font-weight:700; }
      .hero-card-amount { font-size:36px; font-weight:900; margin-top:6px; color:var(--fg); }
      .hero-card-sub { margin-top:8px; color:var(--text-secondary); font-weight:700; font-size:13px; }
      .hero-badge { align-self:center; padding:8px 12px; background:#f3f4f6; border-radius:8px; font-weight:700; font-size:13px; color:var(--text-secondary); }

      .overview-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:18px; }
      .overview-card { background:#fff; border-radius:10px; padding:18px; box-shadow:var(--shadow-sm); border:1px solid rgba(0,0,0,0.04); min-height:92px; }
      .badge { padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; }
      .badge-warning { background:#fef3c7; color:#92400e; }
      .badge-danger { background:#fff3f2; color:#7f1d1d; }

      .card.chart-card { background:#fff; border:1px solid var(--border); border-radius:8px; padding:24px; box-shadow:var(--shadow-sm); margin-bottom:32px; }
      .forecast-header-mini { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
      .btn-group .btn { border-radius:6px; }

      .legend-row { display:flex; justify-content:center; gap:24px; flex-wrap:wrap; padding-top:16px; border-top:1px solid var(--border); }
      .legend-item { display:flex; align-items:center; gap:8px; }
      .legend-swatch { width:16px; height:16px; border-radius:2px; }
      .legend-swatch.actual { background:#2563eb; }
      .legend-swatch.predicted { background:#10b981; }
      .legend-swatch.bound { background:#fecaca; opacity:0.6; }

      /* Product forecast grid and pagination removed */

      /* Removed product grid responsive rules */
      .conf-badge{ padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; }
      .conf-high{ background:#dcfce7; color:#065f46; }
      .conf-medium{ background:#fffbeb; color:#92400e; }
      .conf-low{ background:#fee2e2; color:#991b1b; }

      /* Responsive tweaks */
      @media (max-width: 520px) { .filters-row { flex-direction: column; align-items: stretch; } .filters-actions{ margin-left:0; justify-content:flex-end; }
        .overview-grid { grid-template-columns: 1fr; }
      }
    </style>
  {% else %}
    <div class="card" style="text-align: center; padding: 48px 24px;">
      <p style="color: var(--text-secondary); font-size: 16px;">Loading forecast data from historical sales...</p>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">Using real pizza sales data for ML predictions.</p>
    </div>
  {% endif %}
{% endblock %}
