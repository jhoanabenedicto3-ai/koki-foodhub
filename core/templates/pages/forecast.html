{% extends "layouts/base.html" %}

{% block title %}Forecast - Koki's Foodhub{% endblock %}

{% block content %}
  <div class="page-header">
    <h1 class="section-title">üìà Sales Forecast & Analytics</h1>
    <p class="muted">Predictive insights for better planning</p>
  </div>

  <!-- Controls: Date range and product filter -->
  <div class="filters-card">
    <div class="filters-row">
      <div class="filters-group">
        <label class="filter-label">From</label>
        <input id="startDate" type="date" class="filter-input" />
        <label class="filter-label">To</label>
        <input id="endDate" type="date" class="filter-input" />
      </div>

      <div class="filters-group">
        <label class="filter-label">Product</label>
        <select id="productFilter" class="filter-input">
          <option value="">All products</option>
        </select>
      </div>

      <div class="filters-actions">
        <button id="applyFilters" class="btn btn-primary">Apply</button>
        <button id="clearFilters" class="btn btn-ghost">Clear</button>
      </div>
    </div>
  </div>

  {% if error_message %}
    <div style="margin-bottom: 16px; padding: 12px 16px; background: #fff3f2; border: 1px solid #fcd5d5; color:#7f1d1d; border-radius:8px;">
      <strong>Note:</strong> {{ error_message }}
    </div>
  {% endif %}

  {% if data %}
    <!-- Sales Overview & Prediction Chart -->
    <!-- Sales Overview Cards -->
    <div class="overview-grid">
      <div class="overview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div>
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Daily Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewDailyTotal">‚Äî</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewDailyPct">‚Äî</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="badge badge-warning">Predicted</div>
            <div id="overviewDailyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: ‚Äî</div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div>
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Weekly Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewWeeklyTotal">‚Äî</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewWeeklyPct">‚Äî</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="badge badge-danger">Forecasted</div>
            <div id="overviewWeeklyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: ‚Äî</div>
          </div>
        </div>
      </div>

      <div class="overview-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <div>
            <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">Monthly Sales</div>
            <div style="margin-top:8px; font-size:20px; font-weight:800; color:#111;" id="overviewMonthlyTotal">‚Äî</div>
            <div style="margin-top:6px; font-size:12px; color:var(--text-secondary);" id="overviewMonthlyPct">‚Äî</div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <div class="badge badge-warning">Predicted</div>
            <div id="overviewMonthlyConf" style="font-size:12px; color:var(--text-secondary);">Confidence: ‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card chart-card">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: var(--fg);">üìä Sales Prediction (Next 8 Weeks)</h2>
      
      <div style="position: relative; height: 440px; margin-bottom: 20px;" data-insert-charts>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <h3 style="margin:0; font-size:16px; font-weight:700;">üìä Sales Prediction</h3>
            <div style="display:flex; gap:6px; margin-left:12px;">
              <button id="btnDaily" class="btn btn-ghost" style="font-weight:700;" aria-label="Daily view">Daily</button>
              <button id="btnWeekly" class="btn btn-ghost btn-active" style="font-weight:700;" aria-label="Weekly view">Weekly</button>
              <button id="btnMonthly" class="btn btn-ghost" style="font-weight:700;" aria-label="Monthly view">Monthly</button>
            </div>
          </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="refreshForecastBtn" class="btn" aria-label="Refresh forecasts"><span class="btn-icon">üîÑ</span> <span class="btn-text">Refresh</span></button>
              <span id="forecastStatus" class="muted small-text"></span>
            </div>
        </div>
        <div style="position:relative; height:360px;">
          <canvas id="salesChart" style="height:100%; width:100%;" role="img" aria-label="Sales chart showing actual and forecasted sales"></canvas>
        </div>
      </div>

        <!-- Forecast-only chart (shows predicted future values) -->
        <div style="background:#fff; border:1px solid var(--border); border-radius:8px; padding:16px; box-shadow:var(--shadow-sm); margin-bottom:24px;">
          <div class="forecast-header-mini">
              <h3>üîÆ Forecast (Future)</h3>
              <div class="btn-group">
                <button id="fcDaily" class="btn btn-ghost">Daily</button>
                <button id="fcWeekly" class="btn btn-ghost btn-active">Weekly</button>
                <button id="fcMonthly" class="btn btn-ghost">Monthly</button>
              </div>
            </div>
          <div style="height:260px; position:relative;">
            <canvas id="forecastChart" style="height:100%; width:100%;" role="img" aria-label="Forecast-only chart showing predicted future values"></canvas>
          </div>
        </div>

      <div class="legend-row">
        <div class="legend-item">
          <div class="legend-swatch actual"></div>
          <span class="muted">Actual Sales</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch predicted"></div>
          <span class="muted">Predicted Sales</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch bound"></div>
          <span class="muted">Upper Bound</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch bound"></div>
          <span class="muted">Lower Bound</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Parse server-provided JSON data for charts
      const daily = JSON.parse('{{ daily_json|escapejs }}');
      const weekly = JSON.parse('{{ weekly_json|escapejs }}');
      const monthly = JSON.parse('{{ monthly_json|escapejs }}');

      function renderAreaChart(canvasId, data, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = data.labels.slice();
        // Prepare combined arrays: extend labels for forecast horizon
        const forecastLabels = labels.concat(Array.from({length: data.forecast.length}, (_, i) => 'F+' + (i+1)));

        const actualExtended = data.actual.slice();
        // Pad actual with nulls for forecast region so Chart.js shows forecast as separate series
        const actualPadded = actualExtended.concat(Array(data.forecast.length).fill(null));

        const forecastPadding = Array(labels.length).fill(null).concat(data.forecast);
        const upperPadding = Array(labels.length).fill(null).concat(data.upper);
        const lowerPadding = Array(labels.length).fill(null).concat(data.lower);

        return new Chart(ctx, {
          type: 'line',
          data: {
            labels: forecastLabels,
            datasets: [
              {
                label: 'Actual',
                data: actualPadded,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.06)',
                fill: true,
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Forecast',
                data: forecastPadding,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.06)',
                fill: false,
                borderDash: [5,4],
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Upper',
                data: upperPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              },
              {
                label: 'Lower',
                data: lowerPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              y: { beginAtZero: true },
              x: { display: true }
            }
          }
        });
      }

      // Render a single chart (default to weekly)
      window.currentView = 'weekly';
      window.mainChart = renderAreaChart('salesChart', weekly, 'Weekly Sales');

      function setActiveButton(view){
        document.getElementById('btnDaily').classList.toggle('btn-active', view === 'daily');
        document.getElementById('btnWeekly').classList.toggle('btn-active', view === 'weekly');
        document.getElementById('btnMonthly').classList.toggle('btn-active', view === 'monthly');
      }

      document.getElementById('btnDaily').addEventListener('click', function(){
        setActiveButton('daily');
        window.currentView = 'daily';
        updateChart(window.mainChart, daily);
      });
      document.getElementById('btnWeekly').addEventListener('click', function(){
        setActiveButton('weekly');
        window.currentView = 'weekly';
        updateChart(window.mainChart, weekly);
      });
      document.getElementById('btnMonthly').addEventListener('click', function(){
        setActiveButton('monthly');
        window.currentView = 'monthly';
        updateChart(window.mainChart, monthly);
      });

      // Helper to update existing Chart.js chart with new data
      function updateChart(chartObj, newData) {
        if(!chartObj) return;
        const labels = newData.labels.slice();
        const paddedLabels = labels.concat(Array.from({length: newData.forecast.length}, (_, i) => 'F+' + (i+1)));
        chartObj.data.labels = paddedLabels;

        // Actual padded
        const actualPadded = newData.actual.concat(Array(newData.forecast.length).fill(null));
        chartObj.data.datasets[0].data = actualPadded;

        // Forecast padded
        const forecastPadded = Array(newData.actual.length).fill(null).concat(newData.forecast);
        chartObj.data.datasets[1].data = forecastPadded;

        // Upper / Lower
        chartObj.data.datasets[2].data = Array(newData.actual.length).fill(null).concat(newData.upper);
        chartObj.data.datasets[3].data = Array(newData.actual.length).fill(null).concat(newData.lower);

        chartObj.update();
      }

      // Render forecast-only chart (future predictions with bounds)
      function renderForecastChart(canvasId, data, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const horizon = data.forecast.length || 0;
        const labels = Array.from({length: horizon}, (_, i) => 'F+' + (i+1));

        const dsForecast = {
          label: label + ' Forecast',
          data: data.forecast,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245,158,11,0.06)',
          borderWidth: 3,
          fill: false,
          tension: 0.3,
        };

        const dsUpper = {
          label: 'Upper Bound',
          data: data.upper,
          borderColor: 'rgba(254,202,202,0.9)',
          backgroundColor: 'rgba(254,202,202,0.08)',
          pointRadius: 0,
          borderWidth: 1,
          fill: '-1'
        };

        const dsLower = {
          label: 'Lower Bound',
          data: data.lower,
          borderColor: 'rgba(254,202,202,0.9)',
          backgroundColor: 'rgba(254,202,202,0.08)',
          pointRadius: 0,
          borderWidth: 1,
          fill: '-1'
        };

        return new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [dsForecast, dsUpper, dsLower]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { tooltip: { mode: 'index', intersect: false } },
            scales: { y: { beginAtZero: true }, x: { display: true } },
            animations: { tension: { duration: 700 } }
          }
        });
      }

      function setConfBadge(elId, pct){
        const el = document.getElementById(elId);
        if(!el) return;
        const conf = Math.round(pct || 0);
        let cls = 'conf-low';
        let text = 'Low';
        if(conf >= 70){ cls = 'conf-high'; text = 'High'; }
        else if(conf >= 40){ cls = 'conf-medium'; text = 'Medium'; }
        el.innerHTML = `<span class="conf-badge ${cls}">${text}</span> ${conf}%`;
      }

      // Forecast chart reference
      window.forecastChart = renderForecastChart('forecastChart', weekly, 'Weekly');

      function setForecastActive(view){
        document.getElementById('fcDaily').classList.toggle('btn-active', view === 'daily');
        document.getElementById('fcWeekly').classList.toggle('btn-active', view === 'weekly');
        document.getElementById('fcMonthly').classList.toggle('btn-active', view === 'monthly');
      }

      document.getElementById('fcDaily').addEventListener('click', function(){ setForecastActive('daily'); updateForecastChart('daily'); });
      document.getElementById('fcWeekly').addEventListener('click', function(){ setForecastActive('weekly'); updateForecastChart('weekly'); });
      document.getElementById('fcMonthly').addEventListener('click', function(){ setForecastActive('monthly'); updateForecastChart('monthly'); });

      function updateForecastChart(view){
        const mapping = { 'daily': daily, 'weekly': weekly, 'monthly': monthly };
        const data = mapping[view] || weekly;
        // rebuild the chart data
        if(window.forecastChart){
          window.forecastChart.data.labels = Array.from({length: data.forecast.length}, (_, i) => 'F+' + (i+1));
          window.forecastChart.data.datasets[0].data = data.forecast;
          window.forecastChart.data.datasets[1].data = data.upper;
          window.forecastChart.data.datasets[2].data = data.lower;
          window.forecastChart.update();
        } else {
          window.forecastChart = renderForecastChart('forecastChart', data, view.charAt(0).toUpperCase() + view.slice(1));
        }
      }

      // Fetch API to refresh the charts
      async function refreshForecast() {
        const statusEl = document.getElementById('forecastStatus');
        const refreshBtn = document.getElementById('refreshForecastBtn');
        try {
          statusEl.textContent = 'Updating...';
          refreshBtn.classList.add('loading');
          refreshBtn.querySelector('.btn-text').textContent = 'Updating...';
          // Build query params from filters
          const params = new URLSearchParams();
          const start = document.getElementById('startDate').value;
          const end = document.getElementById('endDate').value;
          const product = document.getElementById('productFilter').value;
          if(start) params.set('start', start);
          if(end) params.set('end', end);
          if(product) params.set('product', product);
          const url = '{% url "forecast_api" %}' + (params.toString() ? ('?' + params.toString()) : '');
          const res = await fetch(url);
          if (!res.ok) throw new Error('Network response not ok');
          const json = await res.json();
          // dump json to debug panel
          const dbg = document.getElementById('forecastDebug');
          if(dbg){ dbg.textContent = JSON.stringify(json, null, 2); }
          document.getElementById('dataSource').textContent = json.data_source || 'unknown';
          document.getElementById('dailyCount').textContent = json.daily.labels.length || 0;
          document.getElementById('weeklyCount').textContent = json.weekly.labels.length || 0;
          document.getElementById('monthlyCount').textContent = json.monthly.labels.length || 0;

          // Update overview cards
          if(json.summary){
            const s = json.summary;
            const d = s.daily || {};
            const w = s.weekly || {};
            const m = s.monthly || {};
            document.getElementById('overviewDailyTotal').textContent = d.total || 0;
            document.getElementById('overviewDailyPct').textContent = ((d.pct_change || 0) + '% ' + (d.arrow === 'up' ? '‚Üë' : d.arrow === 'down' ? '‚Üì' : '')).replace('NaN%','0%');
            setConfBadge('overviewDailyConf', json.daily.confidence || 0);
            document.getElementById('overviewWeeklyTotal').textContent = w.total || 0;
            document.getElementById('overviewWeeklyPct').textContent = ((w.pct_change || 0) + '% ' + (w.arrow === 'up' ? '‚Üë' : w.arrow === 'down' ? '‚Üì' : '')).replace('NaN%','0%');
            setConfBadge('overviewWeeklyConf', json.weekly.confidence || 0);
            document.getElementById('overviewMonthlyTotal').textContent = m.total || 0;
            document.getElementById('overviewMonthlyPct').textContent = ((m.pct_change || 0) + '% ' + (m.arrow === 'up' ? '‚Üë' : m.arrow === 'down' ? '‚Üì' : '')).replace('NaN%','0%');
            setConfBadge('overviewMonthlyConf', json.monthly.confidence || 0);
          }

          // If no data, show message over charts
          function showEmptyNotice(id, msg){
            const canvas = document.getElementById(id);
            if(!canvas) return;
            const parent = canvas.parentElement;
            let notice = parent.querySelector('.empty-notice');
            if(!notice){
              notice = document.createElement('div');
              notice.className = 'empty-notice';
              notice.style.position = 'absolute';
              notice.style.top = '50%';
              notice.style.left = '50%';
              notice.style.transform = 'translate(-50%, -50%)';
              notice.style.background = 'rgba(255,255,255,0.9)';
              notice.style.padding = '12px 16px';
              notice.style.borderRadius = '8px';
              notice.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
              parent.style.position = 'relative';
              parent.appendChild(notice);
            }
            notice.textContent = msg;
          }

          // Clear any existing notices
          ['dailyChart','salesChart','monthlyChart'].forEach(function(id){
            const c = document.getElementById(id);
            if(c && c.parentElement){ const n = c.parentElement.querySelector('.empty-notice'); if(n) n.remove(); }
          });

          if(!json.daily.labels.length){ showEmptyNotice('dailyChart','No daily data available'); }
          if(!json.weekly.labels.length){ showEmptyNotice('salesChart','No weekly data available'); }
          if(!json.monthly.labels.length){ showEmptyNotice('monthlyChart','No monthly data available'); }

          updateChart(window.dailyChart, json.daily);
          updateChart(window.weeklyChart, json.weekly);
          updateChart(window.monthlyChart, json.monthly);
          // Update forecast-only chart too
          updateForecastChart(window.currentView);

          // display AI insights if present
          const insightsEl = document.getElementById('aiInsights');
          if(insightsEl){
            insightsEl.innerHTML = '';
            (json.ai_insights || []).forEach(function(ins){
              const p = document.createElement('div');
              p.textContent = ins;
              p.style.padding = '8px 0';
              p.style.color = 'var(--text-secondary)';
              insightsEl.appendChild(p);
            });
          }

          // populate product filter options from API products
          const pf = document.getElementById('productFilter');
          if(pf && json.products){
            // preserve selected
            const selected = pf.value || '';
            // clear non-empty options (except the first 'All products')
            Array.from(pf.querySelectorAll('option')).forEach((opt, i)=>{ if(i>0) opt.remove(); });
            json.products.forEach(function(p){
              const opt = document.createElement('option');
              opt.value = p.product;
              opt.textContent = p.product + ' (' + (p.last_7_days || 0) + ')';
              pf.appendChild(opt);
            });
            if(selected) pf.value = selected;
          }
          statusEl.textContent = 'Updated just now';
        } catch (e) {
          console.error('refresh error', e);
          statusEl.textContent = 'Update failed';
        } finally {
          setTimeout(()=>{ if(statusEl.textContent === 'Update failed' || statusEl.textContent === 'Updated just now') statusEl.textContent = ''; }, 2500);
          refreshBtn.classList.remove('loading');
          const t = refreshBtn.querySelector('.btn-text'); if(t) t.textContent = 'Refresh';
        }
      }

      document.getElementById('refreshForecastBtn').addEventListener('click', refreshForecast);

      document.getElementById('applyFilters').addEventListener('click', function(){ refreshForecast(); });
      document.getElementById('clearFilters').addEventListener('click', function(){ document.getElementById('startDate').value=''; document.getElementById('endDate').value=''; document.getElementById('productFilter').value=''; refreshForecast(); });

      // Auto-refresh after load
      window.addEventListener('load', function(){ setTimeout(refreshForecast, 600); });

      document.getElementById('toggleDebug').addEventListener('click', function(){
        const dbg = document.getElementById('forecastDebug');
        if(!dbg) return;
        dbg.style.display = dbg.style.display === 'none' ? 'block' : 'none';
      });
    </script>

    <!-- Analytics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <!-- Next Week Sales -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Next Week Sales</h3>
          <span style="font-size: 20px;">üìà</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ currency }}{{ total_forecast|floatformat:0 }}</h2>
        <p style="margin: 0; font-size: 13px; color: #22c55e; font-weight: 600;">
          {% if growth_percentage >= 0 %}
            +{{ growth_percentage|floatformat:1 }}% increase expected
          {% else %}
            {{ growth_percentage|floatformat:1 }}% decrease expected
          {% endif %}
        </p>
      </div>

      <!-- Forecast Accuracy -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Forecast Accuracy</h3>
          <span style="font-size: 20px;">‚úì</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ avg_confidence|floatformat:1 }}%</h2>
        <p style="margin: 0; font-size: 13px; color: #0ea5e9; font-weight: 600;">High confidence</p>
      </div>

      <!-- Peak Day -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Peak Day</h3>
          <span style="font-size: 20px;">üìÖ</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ peak_day }}</h2>
        <p style="margin: 0; font-size: 13px; color: #f97316; font-weight: 600;">Expected: {{ peak_orders }} orders</p>
      </div>
    </div>

    <!-- Diagnostics / Data source info (visible to Admin) -->
    <div style="margin-bottom:16px; display:flex; gap:12px; align-items:center;">
      <div style="padding:8px 12px; background:#f3f4f6; border-radius:8px; font-weight:700;">Source: <span id="dataSource">{{ data_source|default:'unknown' }}</span></div>
      <div style="padding:8px 12px; background:#fff; border:1px solid var(--border); border-radius:8px;">Daily: <strong id="dailyCount">{{ daily_count }}</strong> ({{ daily_first }} ‚Üí {{ daily_last }})</div>
      <div style="padding:8px 12px; background:#fff; border:1px solid var(--border); border-radius:8px;">Weekly: <strong id="weeklyCount">{{ weekly_count }}</strong> ({{ weekly_first }} ‚Üí {{ weekly_last }})</div>
      <div style="padding:8px 12px; background:#fff; border:1px solid var(--border); border-radius:8px;">Monthly: <strong id="monthlyCount">{{ monthly_count }}</strong> ({{ monthly_first }} ‚Üí {{ monthly_last }})</div>
      <button id="toggleDebug" class="btn" style="margin-left:auto;">Toggle Debug JSON</button>
    </div>

    <div id="forecastDebug" style="display:none; background:#0f172a; color:#fff; padding:12px; border-radius:8px; font-family:monospace; white-space:pre-wrap; max-height:240px; overflow:auto;"></div>

    <!-- AI Insights area -->
    <div id="aiInsights" style="background:#fff; padding:12px; margin-top:16px; border-radius:8px; border:1px solid var(--border); box-shadow:var(--shadow-sm);"></div>

    <!-- Product Forecast Cards with Pagination -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 24px; box-shadow: var(--shadow-sm);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);">üìä All Product Forecasts</h2>
      </div>

      <!-- Forecast Grid Container -->
      <div class="forecast-container" id="forecastContainer" role="list" aria-label="Product forecasts">
        {% for row in data %}
          <div class="forecast-card" data-product-id="{{ forloop.counter }}" role="listitem" aria-label="Forecast for {{ row.product }}">
            <div class="forecast-header">
              <div>
                <h3 style="margin: 0 0 4px 0; font-size: 16px; text-transform: capitalize;">{{ row.product }}</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">{{ row.source }}</p>
              </div>
              {% if row.is_csv %}
                <span class="trend-badge trend-{{ row.trend }}">{{ row.trend|upper }}</span>
                <span style="margin-left:8px; padding:4px 8px; border-radius:8px; font-weight:700; font-size:11px;" class="conf-{{ row.accuracy|default:'low'|lower }}">{{ row.accuracy|default:'Low' }}</span>
              {% endif %}
            </div>

            <div class="forecast-metrics">
              <div class="metric">
                <div class="metric-label">Next Day Forecast</div>
                <div class="metric-value" style="color: var(--accent);">{{ row.forecast }} units</div>
              </div>
              <div class="metric">
                <div class="metric-label">Average</div>
                <div class="metric-value">{{ row.avg|floatformat:1 }}</div>
              </div>
              {% if row.is_csv %}
                <div class="metric">
                  <div class="metric-label">Last 7 Days</div>
                  <div class="metric-value">{{ row.last_7_days }} units</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Confidence</div>
                  <div class="metric-value">{{ row.confidence|floatformat:0 }}%</div>
                </div>
              {% endif %}
            </div>

            {% comment %} Sparkline canvas for recent activity - values stored in data-values attr as comma-separated numbers {% endcomment %}
            <div class="forecast-sparkline-wrapper">
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Recent Activity</div>
              <div class="forecast-sparkline" data-values="{% for entry in row.history %}{{ entry.1 }}{% if not forloop.last %},{% endif %}{% endfor %}"></div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Items per page selector (moved out of header) -->
      <div style="display:flex; justify-content:center; margin-top: 12px; margin-bottom: 6px;">
        <label for="itemsPerPage" style="font-size:13px; color:var(--text-secondary); font-weight:600; margin-right:8px; align-self:center;">Items per page:</label>
        <select id="itemsPerPage" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: #fff; cursor: pointer;">
          <option value="6">6</option>
          <option value="9" selected>9</option>
          <option value="12">12</option>
          <option value="20">20</option>
        </select>
      </div>

      <!-- Pagination Controls -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button id="prevBtn" style="padding: 8px 14px; background: #fff; color: var(--fg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s ease;" onclick="previousPage()">‚Üê Previous</button>
        
        <div id="pageNumbers" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;"></div>
        
        <button id="nextBtn" style="padding: 8px 14px; background: #fff; color: var(--fg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s ease;" onclick="nextPage()">Next ‚Üí</button>
      </div>

      <div style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
        Showing <span id="startItem">1</span> to <span id="endItem">9</span> of <span id="totalItems">{{ data|length }}</span> products
      </div>
    </div>

    <style>
      /* Local styles to improve layout, spacing and visual hierarchy */
      .muted { color: var(--text-secondary); }
      .small-text { font-size: 13px; }
      .page-header { margin-bottom: 28px; }
      .filters-card { background: #fff; border: 1px solid var(--border); padding: 14px 16px; border-radius: 10px; margin-bottom: 18px; box-shadow: var(--shadow-sm); }
      .filters-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .filters-group { display:flex; gap:8px; align-items:center; }
      .filter-label { font-weight:700; font-size:13px; color:var(--text-secondary); }
      .filter-input { padding:8px; border:1px solid var(--border); border-radius:6px; min-width:160px; }
      .filters-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

      .btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:#fff; font-weight:700; cursor:pointer; }
      .btn-ghost { background:transparent; border:1px solid var(--border); }
      .btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
      .btn .btn-icon { margin-right:6px; }
      .btn.loading { opacity:0.8; pointer-events:none; }

      .overview-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-bottom:18px; }
      .overview-card { background:#fff; border-radius:10px; padding:18px; box-shadow:var(--shadow-sm); border:1px solid rgba(0,0,0,0.04); min-height:92px; }
      .badge { padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; }
      .badge-warning { background:#fef3c7; color:#92400e; }
      .badge-danger { background:#fff3f2; color:#7f1d1d; }

      .card.chart-card { background:#fff; border:1px solid var(--border); border-radius:8px; padding:24px; box-shadow:var(--shadow-sm); margin-bottom:32px; }
      .forecast-header-mini { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
      .btn-group .btn { border-radius:6px; }

      .legend-row { display:flex; justify-content:center; gap:24px; flex-wrap:wrap; padding-top:16px; border-top:1px solid var(--border); }
      .legend-item { display:flex; align-items:center; gap:8px; }
      .legend-swatch { width:16px; height:16px; border-radius:2px; }
      .legend-swatch.actual { background:#10b981; }
      .legend-swatch.predicted { background:#f59e0b; }
      .legend-swatch.bound { background:#fecaca; opacity:0.6; }

      .forecast-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 0;
      }

      .forecast-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }

      .forecast-card {
        display: none;
      }

      .forecast-card.visible {
        display: block;
      }

      .forecast-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .forecast-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }

      .trend-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
      }

      .trend-increasing {
        background: #d1fae5;
        color: #065f46;
      }

      .trend-decreasing {
        background: #fee2e2;
        color: #991b1b;
      }

      .trend-stable {
        background: #fef3c7;
        color: #92400e;
      }

      .forecast-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .metric {
        background: var(--muted);
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }

      .metric-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--fg);
      }

      .forecast-chart {
        padding: 12px;
        background: var(--muted);
        border-radius: 6px;
      }

      #pageNumbers button {
        padding: 6px 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--fg);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      #pageNumbers button:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      #pageNumbers button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      @media (max-width: 1200px) {
        .forecast-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .forecast-container {
          grid-template-columns: 1fr;
        }
      }
      .conf-badge{ padding:6px 10px; border-radius:8px; font-weight:700; font-size:12px; display:inline-block; }
      .conf-high{ background:#dcfce7; color:#065f46; }
      .conf-medium{ background:#fffbeb; color:#92400e; }
      .conf-low{ background:#fee2e2; color:#991b1b; }

      /* Responsive tweaks */
      @media (max-width: 900px) { .forecast-container { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 520px) { .filters-row { flex-direction: column; align-items: stretch; } .filters-actions{ margin-left:0; justify-content:flex-end; }
        .overview-grid { grid-template-columns: 1fr; }
      }
    </style>

    <script>
      let currentPage = 1;
      let itemsPerPage = 9;
      const totalItems = (function(){ const el = document.getElementById('totalItems'); return el ? parseInt(el.textContent,10) || 0 : 0; })();

      function setupPagination() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pageNumbersDiv = document.getElementById('pageNumbers');
        pageNumbersDiv.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.className = i === currentPage ? 'active' : '';
          btn.onclick = () => goToPage(i);
          pageNumbersDiv.appendChild(btn);
        }

        updateVisibility();
        updatePageInfo();
      }

      function updateVisibility() {
        const cards = document.querySelectorAll('.forecast-card');
        const startIdx = (currentPage - 1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;

        cards.forEach((card, idx) => {
          if (idx >= startIdx && idx < endIdx) {
            card.classList.add('visible');
          } else {
            card.classList.remove('visible');
          }
        });

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === Math.ceil(totalItems / itemsPerPage);
      }

      function updatePageInfo() {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);
        document.getElementById('startItem').textContent = startItem;
        document.getElementById('endItem').textContent = endItem;
      }

      function goToPage(page) {
        currentPage = page;
        setupPagination();
      }

      function nextPage() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) {
          goToPage(currentPage + 1);
        }
      }

      function previousPage() {
        if (currentPage > 1) {
          goToPage(currentPage - 1);
        }
      }

      document.getElementById('itemsPerPage').addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        setupPagination();
      });

      // Initialize pagination on page load
      window.addEventListener('load', setupPagination);
    </script>
  {% else %}
    <div class="card" style="text-align: center; padding: 48px 24px;">
      <p style="color: var(--text-secondary); font-size: 16px;">Loading forecast data from historical sales...</p>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">Using real pizza sales data for ML predictions.</p>
    </div>
  {% endif %}
{% endblock %}
