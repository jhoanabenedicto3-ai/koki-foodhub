{% extends "layouts/base.html" %}

{% block title %}Forecast - Koki's Foodhub{% endblock %}

{% block content %}
  <div style="margin-bottom: 28px;">
    <h1 class="section-title">üìà Sales Forecast & Analytics</h1>
    <p style="color: var(--text-secondary); margin: 0;">Predictive insights for better planning</p>
  </div>

  {% if data %}
    <!-- Sales Prediction Chart -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 32px;">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: var(--fg);">üìä Sales Prediction (Next 8 Weeks)</h2>
      
      <div style="position: relative; height: 400px; margin-bottom: 20px;">
        <canvas id="salesChart"></canvas>
      </div>

      <div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; padding-top: 16px; border-top: 1px solid var(--border);">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #10b981; border-radius: 2px;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Actual Sales</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 2px;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Predicted Sales</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #fecaca; border-radius: 2px; opacity: 0.5;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Upper Bound</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #fecaca; border-radius: 2px; opacity: 0.5;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Lower Bound</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Generate 8-week forecast data
      const weeks = [];
      const actualData = [];
      const predictedData = [];
      const upperBound = [];
      const lowerBound = [];
      
      const baseValue = {{ total_forecast }};
      const variance = baseValue * 0.15; // 15% variance
      
      for (let i = 1; i <= 8; i++) {
        weeks.push('Week ' + i);
        
        // Simulate actual data with some randomness
        const actual = baseValue + (Math.random() - 0.5) * baseValue * 0.2;
        actualData.push(Math.round(actual));
        
        // Predicted trend (slight upward trend)
        const predicted = baseValue + (i * baseValue * 0.02) + (Math.random() - 0.5) * baseValue * 0.1;
        predictedData.push(Math.round(predicted));
        
        // Bounds
        upperBound.push(Math.round(predicted + variance));
        lowerBound.push(Math.round(predicted - variance));
      }

      const ctx = document.getElementById('salesChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: weeks,
          datasets: [
            {
              label: 'Actual Sales',
              data: actualData,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.05)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointBackgroundColor: '#10b981',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverRadius: 7
            },
            {
              label: 'Predicted Sales',
              data: predictedData,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.05)',
              borderWidth: 3,
              borderDash: [5, 5],
              fill: false,
              tension: 0.4,
              pointRadius: 5,
              pointBackgroundColor: '#f59e0b',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverRadius: 7
            },
            {
              label: 'Upper Bound',
              data: upperBound,
              borderColor: '#fecaca',
              backgroundColor: 'rgba(254, 202, 202, 0.1)',
              borderWidth: 1,
              fill: false,
              tension: 0.4,
              pointRadius: 0,
              borderDash: [2, 2]
            },
            {
              label: 'Lower Bound',
              data: lowerBound,
              borderColor: '#fecaca',
              backgroundColor: 'rgba(254, 202, 202, 0.1)',
              borderWidth: 1,
              fill: '-1',
              tension: 0.4,
              pointRadius: 0,
              borderDash: [2, 2]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              borderColor: '#ddd',
              borderWidth: 1,
              usePointStyle: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: 'rgba(0, 0, 0, 0.5)',
                font: { size: 12 }
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: false
              },
              ticks: {
                color: 'rgba(0, 0, 0, 0.5)',
                font: { size: 12 }
              }
            }
          }
        }
      });
    </script>

    <!-- Analytics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <!-- Next Week Sales -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Next Week Sales</h3>
          <span style="font-size: 20px;">üìà</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ currency }}{{ total_forecast|floatformat:0 }}</h2>
        <p style="margin: 0; font-size: 13px; color: #22c55e; font-weight: 600;">
          {% if growth_percentage >= 0 %}
            +{{ growth_percentage|floatformat:1 }}% increase expected
          {% else %}
            {{ growth_percentage|floatformat:1 }}% decrease expected
          {% endif %}
        </p>
      </div>

      <!-- Forecast Accuracy -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Forecast Accuracy</h3>
          <span style="font-size: 20px;">‚úì</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ avg_confidence|floatformat:1 }}%</h2>
        <p style="margin: 0; font-size: 13px; color: #0ea5e9; font-weight: 600;">High confidence</p>
      </div>

      <!-- Peak Day -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Peak Day</h3>
          <span style="font-size: 20px;">üìÖ</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ peak_day }}</h2>
        <p style="margin: 0; font-size: 13px; color: #f97316; font-weight: 600;">Expected: {{ peak_orders }} orders</p>
      </div>
    </div>

    <!-- Product Forecast Cards with Pagination -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 24px; box-shadow: var(--shadow-sm);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);">üìä All Product Forecasts</h2>
        <div style="display: flex; align-items: center; gap: 12px;">
          <label style="font-size: 13px; color: var(--text-secondary); font-weight: 600;">Items per page:</label>
          <select id="itemsPerPage" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: #fff; cursor: pointer;">
            <option value="6">6</option>
            <option value="9" selected>9</option>
            <option value="12">12</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>

      <!-- Forecast Grid Container -->
      <div class="forecast-container" id="forecastContainer">
        {% for row in data %}
          <div class="forecast-card" data-product-id="{{ forloop.counter }}">
            <div class="forecast-header">
              <div>
                <h3 style="margin: 0 0 4px 0; font-size: 16px; text-transform: capitalize;">{{ row.product }}</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">{{ row.source }}</p>
              </div>
              {% if row.is_csv %}
                <span class="trend-badge trend-{{ row.trend }}">{{ row.trend|upper }}</span>
              {% endif %}
            </div>

            <div class="forecast-metrics">
              <div class="metric">
                <div class="metric-label">Next Day Forecast</div>
                <div class="metric-value" style="color: var(--accent);">{{ row.forecast }} units</div>
              </div>
              <div class="metric">
                <div class="metric-label">Average</div>
                <div class="metric-value">{{ row.avg|floatformat:1 }}</div>
              </div>
              {% if row.is_csv %}
                <div class="metric">
                  <div class="metric-label">Last 7 Days</div>
                  <div class="metric-value">{{ row.last_7_days }} units</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Confidence</div>
                  <div class="metric-value">{{ row.confidence|floatformat:0 }}%</div>
                </div>
              {% endif %}
            </div>

            {% if row.history %}
              <div class="forecast-chart">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Recent Activity</div>
                <div style="display: flex; align-items: flex-end; gap: 4px; height: 80px;">
                  {% for entry in row.history %}
                    <div style="flex: 1; background: var(--accent); border-radius: 4px; height: {% if row.is_csv %}{{ entry.1|default:entry }}{% else %}{{ entry.1 }}{% endif %}px; min-height: 8px; cursor: pointer;" title="{% if row.is_csv %}{{ entry.0 }}: {{ entry.1 }} units{% else %}{{ entry.0 }}: {{ entry.1 }} units{% endif %}"></div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Pagination Controls -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button id="prevBtn" style="padding: 8px 14px; background: #fff; color: var(--fg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s ease;" onclick="previousPage()">‚Üê Previous</button>
        
        <div id="pageNumbers" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;"></div>
        
        <button id="nextBtn" style="padding: 8px 14px; background: #fff; color: var(--fg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s ease;" onclick="nextPage()">Next ‚Üí</button>
      </div>

      <div style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
        Showing <span id="startItem">1</span> to <span id="endItem">9</span> of <span id="totalItems">{{ data|length }}</span> products
      </div>
    </div>

    <style>
      .forecast-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 0;
      }

      .forecast-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }

      .forecast-card {
        display: none;
      }

      .forecast-card.visible {
        display: block;
      }

      .forecast-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .forecast-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }

      .trend-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
      }

      .trend-increasing {
        background: #d1fae5;
        color: #065f46;
      }

      .trend-decreasing {
        background: #fee2e2;
        color: #991b1b;
      }

      .trend-stable {
        background: #fef3c7;
        color: #92400e;
      }

      .forecast-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .metric {
        background: var(--muted);
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }

      .metric-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--fg);
      }

      .forecast-chart {
        padding: 12px;
        background: var(--muted);
        border-radius: 6px;
      }

      #pageNumbers button {
        padding: 6px 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--fg);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      #pageNumbers button:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      #pageNumbers button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      @media (max-width: 1200px) {
        .forecast-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .forecast-container {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <script>
      let currentPage = 1;
      let itemsPerPage = 9;
      const totalItems = {{ data|length }};

      function setupPagination() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pageNumbersDiv = document.getElementById('pageNumbers');
        pageNumbersDiv.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.className = i === currentPage ? 'active' : '';
          btn.onclick = () => goToPage(i);
          pageNumbersDiv.appendChild(btn);
        }

        updateVisibility();
        updatePageInfo();
      }

      function updateVisibility() {
        const cards = document.querySelectorAll('.forecast-card');
        const startIdx = (currentPage - 1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;

        cards.forEach((card, idx) => {
          if (idx >= startIdx && idx < endIdx) {
            card.classList.add('visible');
          } else {
            card.classList.remove('visible');
          }
        });

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === Math.ceil(totalItems / itemsPerPage);
      }

      function updatePageInfo() {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);
        document.getElementById('startItem').textContent = startItem;
        document.getElementById('endItem').textContent = endItem;
      }

      function goToPage(page) {
        currentPage = page;
        setupPagination();
      }

      function nextPage() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) {
          goToPage(currentPage + 1);
        }
      }

      function previousPage() {
        if (currentPage > 1) {
          goToPage(currentPage - 1);
        }
      }

      document.getElementById('itemsPerPage').addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        setupPagination();
      });

      // Initialize pagination on page load
      window.addEventListener('load', setupPagination);
    </script>
  {% else %}
    <div class="card" style="text-align: center; padding: 48px 24px;">
      <p style="color: var(--text-secondary); font-size: 16px;">Loading forecast data from historical sales...</p>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">Using real pizza sales data for ML predictions.</p>
    </div>
  {% endif %}
{% endblock %}
