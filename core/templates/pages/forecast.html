{% extends "layouts/base.html" %}

{% block title %}Forecast - Koki's Foodhub{% endblock %}

{% block content %}
  <div style="margin-bottom: 28px;">
    <h1 class="section-title">üìà Sales Forecast & Analytics</h1>
    <p style="color: var(--text-secondary); margin: 0;">Predictive insights for better planning</p>
  </div>

  {% if data %}
    <!-- Sales Prediction Chart -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 24px; box-shadow: var(--shadow-sm); margin-bottom: 32px;">
      <h2 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: var(--fg);">üìä Sales Prediction (Next 8 Weeks)</h2>
      
      <div style="position: relative; height: 400px; margin-bottom: 20px;" data-insert-charts>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;">
          <div style="display:flex; gap:12px; align-items:center;">
            <h3 style="margin:0; font-size:16px; font-weight:700;">üìä Sales Prediction (Next Weeks)</h3>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="refreshForecastBtn" class="btn">üîÑ Refresh</button>
            <span id="forecastStatus" style="color:var(--text-secondary); font-size:13px;"></span>
          </div>
        </div>
        <canvas id="salesChart"></canvas>
      </div>

      <div style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; padding-top: 16px; border-top: 1px solid var(--border);">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background:#f59e0b ; border-radius: 2px;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Actual Sales</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 2px;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Predicted Sales</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #fecaca; border-radius: 2px; opacity: 0.5;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Upper Bound</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 16px; height: 16px; background: #fecaca; border-radius: 2px; opacity: 0.5;"></div>
          <span style="font-size: 13px; color: var(--text-secondary);">Lower Bound</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Parse server-provided JSON data for charts
      const daily = JSON.parse('{{ daily_json|escapejs }}');
      const weekly = JSON.parse('{{ weekly_json|escapejs }}');
      const monthly = JSON.parse('{{ monthly_json|escapejs }}');

      function renderAreaChart(canvasId, data, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const labels = data.labels.slice();
        // Prepare combined arrays: extend labels for forecast horizon
        const forecastLabels = labels.concat(Array.from({length: data.forecast.length}, (_, i) => 'F+' + (i+1)));

        const actualExtended = data.actual.slice();
        // Pad actual with nulls for forecast region so Chart.js shows forecast as separate series
        const actualPadded = actualExtended.concat(Array(data.forecast.length).fill(null));

        const forecastPadding = Array(labels.length).fill(null).concat(data.forecast);
        const upperPadding = Array(labels.length).fill(null).concat(data.upper);
        const lowerPadding = Array(labels.length).fill(null).concat(data.lower);

        return new Chart(ctx, {
          type: 'line',
          data: {
            labels: forecastLabels,
            datasets: [
              {
                label: 'Actual',
                data: actualPadded,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.06)',
                fill: true,
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Forecast',
                data: forecastPadding,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.06)',
                fill: false,
                borderDash: [5,4],
                tension: 0.3,
                pointRadius: 3
              },
              {
                label: 'Upper',
                data: upperPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              },
              {
                label: 'Lower',
                data: lowerPadding,
                borderColor: 'rgba(254,202,202,0.9)',
                backgroundColor: 'rgba(254,202,202,0.08)',
                fill: '-1',
                pointRadius: 0,
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              y: { beginAtZero: true },
              x: { display: true }
            }
          }
        });
      }

      // Render three charts and keep references for updates
      window.weeklyChart = renderAreaChart('salesChart', weekly, 'Weekly Sales');
      window.dailyChart = null;
      window.monthlyChart = null;
      // create additional canvas elements for daily and monthly charts
      // insert them before analytics cards
      (function(){
        const container = document.querySelector('[data-insert-charts]');
        if(container){
          const html = `
            <div style="display:grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
              <div style="background:#fff; border:1px solid var(--border); border-radius:8px; padding:16px;">
                <h3 style="margin:0 0 12px 0; font-size:14px; font-weight:700;">Daily Sales (Last ${daily.labels.length} days)</h3>
                <div style="height:300px;"><canvas id="dailyChart"></canvas></div>
              </div>
              <div style="background:#fff; border:1px solid var(--border); border-radius:8px; padding:16px;">
                <h3 style="margin:0 0 12px 0; font-size:14px; font-weight:700;">Monthly Sales (Last ${monthly.labels.length} months)</h3>
                <div style="height:300px;"><canvas id="monthlyChart"></canvas></div>
              </div>
            </div>
          `;
          container.insertAdjacentHTML('beforebegin', html);
          window.dailyChart = renderAreaChart('dailyChart', daily, 'Daily Sales');
          window.monthlyChart = renderAreaChart('monthlyChart', monthly, 'Monthly Sales');
        }
      })();

      // Helper to update existing Chart.js chart with new data
      function updateChart(chartObj, newData) {
        if(!chartObj) return;
        const labels = newData.labels.slice();
        const paddedLabels = labels.concat(Array.from({length: newData.forecast.length}, (_, i) => 'F+' + (i+1)));
        chartObj.data.labels = paddedLabels;

        // Actual padded
        const actualPadded = newData.actual.concat(Array(newData.forecast.length).fill(null));
        chartObj.data.datasets[0].data = actualPadded;

        // Forecast padded
        const forecastPadded = Array(newData.actual.length).fill(null).concat(newData.forecast);
        chartObj.data.datasets[1].data = forecastPadded;

        // Upper / Lower
        chartObj.data.datasets[2].data = Array(newData.actual.length).fill(null).concat(newData.upper);
        chartObj.data.datasets[3].data = Array(newData.actual.length).fill(null).concat(newData.lower);

        chartObj.update();
      }

      // Fetch API to refresh the charts
      async function refreshForecast() {
        const statusEl = document.getElementById('forecastStatus');
        try {
          statusEl.textContent = 'Updating...';
          const res = await fetch('{% url "forecast_api" %}');
          if (!res.ok) throw new Error('Network response not ok');
          const json = await res.json();
          updateChart(window.dailyChart, json.daily);
          updateChart(window.weeklyChart, json.weekly);
          updateChart(window.monthlyChart, json.monthly);
          statusEl.textContent = 'Updated just now';
        } catch (e) {
          console.error('refresh error', e);
          statusEl.textContent = 'Update failed';
        } finally {
          setTimeout(()=>{ if(statusEl.textContent === 'Update failed' || statusEl.textContent === 'Updated just now') statusEl.textContent = ''; }, 2500);
        }
      }

      document.getElementById('refreshForecastBtn').addEventListener('click', refreshForecast);

      // Auto-refresh after load
      window.addEventListener('load', function(){ setTimeout(refreshForecast, 600); });
        }
      })();
    </script>

    <!-- Analytics Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <!-- Next Week Sales -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Next Week Sales</h3>
          <span style="font-size: 20px;">üìà</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ currency }}{{ total_forecast|floatformat:0 }}</h2>
        <p style="margin: 0; font-size: 13px; color: #22c55e; font-weight: 600;">
          {% if growth_percentage >= 0 %}
            +{{ growth_percentage|floatformat:1 }}% increase expected
          {% else %}
            {{ growth_percentage|floatformat:1 }}% decrease expected
          {% endif %}
        </p>
      </div>

      <!-- Forecast Accuracy -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Forecast Accuracy</h3>
          <span style="font-size: 20px;">‚úì</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ avg_confidence|floatformat:1 }}%</h2>
        <p style="margin: 0; font-size: 13px; color: #0ea5e9; font-weight: 600;">High confidence</p>
      </div>

      <!-- Peak Day -->
      <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Peak Day</h3>
          <span style="font-size: 20px;">üìÖ</span>
        </div>
        <h2 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 700; color: var(--fg);">{{ peak_day }}</h2>
        <p style="margin: 0; font-size: 13px; color: #f97316; font-weight: 600;">Expected: {{ peak_orders }} orders</p>
      </div>
    </div>

    <!-- Product Forecast Cards with Pagination -->
    <div style="background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 24px; box-shadow: var(--shadow-sm);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);">üìä All Product Forecasts</h2>
      </div>

      <!-- Forecast Grid Container -->
      <div class="forecast-container" id="forecastContainer">
        {% for row in data %}
          <div class="forecast-card" data-product-id="{{ forloop.counter }}">
            <div class="forecast-header">
              <div>
                <h3 style="margin: 0 0 4px 0; font-size: 16px; text-transform: capitalize;">{{ row.product }}</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">{{ row.source }}</p>
              </div>
              {% if row.is_csv %}
                <span class="trend-badge trend-{{ row.trend }}">{{ row.trend|upper }}</span>
              {% endif %}
            </div>

            <div class="forecast-metrics">
              <div class="metric">
                <div class="metric-label">Next Day Forecast</div>
                <div class="metric-value" style="color: var(--accent);">{{ row.forecast }} units</div>
              </div>
              <div class="metric">
                <div class="metric-label">Average</div>
                <div class="metric-value">{{ row.avg|floatformat:1 }}</div>
              </div>
              {% if row.is_csv %}
                <div class="metric">
                  <div class="metric-label">Last 7 Days</div>
                  <div class="metric-value">{{ row.last_7_days }} units</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Confidence</div>
                  <div class="metric-value">{{ row.confidence|floatformat:0 }}%</div>
                </div>
              {% endif %}
            </div>

            {% if row.history %}
              <div class="forecast-chart">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Recent Activity</div>
                <div style="display: flex; align-items: flex-end; gap: 4px; height: 80px;">
                  {% for entry in row.history %}
                    <div style="flex: 1; background: var(--accent); border-radius: 4px; height: {% if row.is_csv %}{{ entry.1|default:entry }}{% else %}{{ entry.1 }}{% endif %}px; min-height: 8px; cursor: pointer;" title="{% if row.is_csv %}{{ entry.0 }}: {{ entry.1 }} units{% else %}{{ entry.0 }}: {{ entry.1 }} units{% endif %}"></div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Items per page selector (moved out of header) -->
      <div style="display:flex; justify-content:center; margin-top: 12px; margin-bottom: 6px;">
        <label for="itemsPerPage" style="font-size:13px; color:var(--text-secondary); font-weight:600; margin-right:8px; align-self:center;">Items per page:</label>
        <select id="itemsPerPage" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: #fff; cursor: pointer;">
          <option value="6">6</option>
          <option value="9" selected>9</option>
          <option value="12">12</option>
          <option value="20">20</option>
        </select>
      </div>

      <!-- Pagination Controls -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button id="prevBtn" style="padding: 8px 14px; background: #fff; color: var(--fg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s ease;" onclick="previousPage()">‚Üê Previous</button>
        
        <div id="pageNumbers" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;"></div>
        
        <button id="nextBtn" style="padding: 8px 14px; background: #fff; color: var(--fg); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s ease;" onclick="nextPage()">Next ‚Üí</button>
      </div>

      <div style="text-align: center; margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
        Showing <span id="startItem">1</span> to <span id="endItem">9</span> of <span id="totalItems">{{ data|length }}</span> products
      </div>
    </div>

    <style>
      .forecast-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 0;
      }

      .forecast-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }

      .forecast-card {
        display: none;
      }

      .forecast-card.visible {
        display: block;
      }

      .forecast-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .forecast-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }

      .trend-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
      }

      .trend-increasing {
        background: #d1fae5;
        color: #065f46;
      }

      .trend-decreasing {
        background: #fee2e2;
        color: #991b1b;
      }

      .trend-stable {
        background: #fef3c7;
        color: #92400e;
      }

      .forecast-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .metric {
        background: var(--muted);
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }

      .metric-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .metric-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--fg);
      }

      .forecast-chart {
        padding: 12px;
        background: var(--muted);
        border-radius: 6px;
      }

      #pageNumbers button {
        padding: 6px 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--fg);
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      #pageNumbers button:hover {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      #pageNumbers button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      @media (max-width: 1200px) {
        .forecast-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .forecast-container {
          grid-template-columns: 1fr;
        }
      }
    </style>

    <script>
      let currentPage = 1;
      let itemsPerPage = 9;
      const totalItems = {{ data|length }};

      function setupPagination() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pageNumbersDiv = document.getElementById('pageNumbers');
        pageNumbersDiv.innerHTML = '';

        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.className = i === currentPage ? 'active' : '';
          btn.onclick = () => goToPage(i);
          pageNumbersDiv.appendChild(btn);
        }

        updateVisibility();
        updatePageInfo();
      }

      function updateVisibility() {
        const cards = document.querySelectorAll('.forecast-card');
        const startIdx = (currentPage - 1) * itemsPerPage;
        const endIdx = startIdx + itemsPerPage;

        cards.forEach((card, idx) => {
          if (idx >= startIdx && idx < endIdx) {
            card.classList.add('visible');
          } else {
            card.classList.remove('visible');
          }
        });

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === Math.ceil(totalItems / itemsPerPage);
      }

      function updatePageInfo() {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);
        document.getElementById('startItem').textContent = startItem;
        document.getElementById('endItem').textContent = endItem;
      }

      function goToPage(page) {
        currentPage = page;
        setupPagination();
      }

      function nextPage() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (currentPage < totalPages) {
          goToPage(currentPage + 1);
        }
      }

      function previousPage() {
        if (currentPage > 1) {
          goToPage(currentPage - 1);
        }
      }

      document.getElementById('itemsPerPage').addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1;
        setupPagination();
      });

      // Initialize pagination on page load
      window.addEventListener('load', setupPagination);
    </script>
  {% else %}
    <div class="card" style="text-align: center; padding: 48px 24px;">
      <p style="color: var(--text-secondary); font-size: 16px;">Loading forecast data from historical sales...</p>
      <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">Using real pizza sales data for ML predictions.</p>
    </div>
  {% endif %}
{% endblock %}
