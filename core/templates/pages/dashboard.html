{% extends "layouts/base.html" %}

{% block title %}Dashboard - Koki's Foodhub{% endblock %}

{% block content %}
  {% csrf_token %}
  <!-- Top Navigation Bar -->
  <div style="background: #fff; border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: 24px;">üçï</span>
      <h1 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);">Koki's Foodhub</h1>
    </div>
    <a href="{% url 'logout' %}" style="padding: 10px 16px; background: transparent; color: #666; text-decoration: none; border: 1px solid var(--border); border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">Logout</a>
  </div>

  <div style="display: flex; gap: 0; min-height: calc(100vh - 60px); padding: 0; background: #f5f5f5;">
    <!-- Left: Search & Products Area -->
    <div style="flex: 1; padding: 24px; overflow-y: auto;">
      <!-- Search Box Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #e8e8f0; padding: 20px; border-radius: 12px;">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <span style="font-size: 24px;">üîç</span>
            <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);">Search Products</h2>
          </div>
          <input type="text" id="searchInput" placeholder="Search menu items..." style="width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; background: #fff;">
        </div>
        <!-- Add Item button removed per user request -->
      </div>

      <!-- Category Filter Tabs -->
      <div style="display: flex; gap: 12px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px;">
        <button class="category-filter active" data-category="All" style="padding: 10px 20px; border: none; background: #fff; cursor: pointer; font-weight: 600; font-size: 14px; color: #374151; border-radius: 20px; transition: all 0.2s ease; white-space: nowrap; border: 1px solid var(--border);">
          All
        </button>
        {% for category in categories %}
        <button class="category-filter" data-category="{{ category }}" style="padding: 10px 20px; border: none; background: transparent; cursor: pointer; font-weight: 600; font-size: 14px; color: var(--text-secondary); border-radius: 20px; transition: all 0.2s ease; white-space: nowrap; border: 1px solid var(--border);">
          {{ category }}
        </button>
        {% endfor %}
      </div>

      <!-- Product Grid - 3 columns; auto height so it can use bottom space -->
      <style>
        /* Dashboard product card styles matching product-list appearance */
        #productGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; padding-right:8px; align-content:start; }
        .product-card { position: relative; border: 1px solid #e9eef2; border-radius: 12px; overflow: hidden; background: #fff; cursor: pointer; transition: all 0.18s ease; box-shadow: 0 6px 18px rgba(15,23,42,0.04); display:flex; flex-direction:column; min-height:300px; }
        .product-card .product-image { width:100%; height:160px; overflow:hidden; flex-shrink:0; position:relative; }
        .product-card .product-image img { width:100%; height:100%; object-fit:cover; display:block; }
        .product-card .name-strip { position: relative; z-index: 3; background: #fff; padding: 14px 16px; margin-top: -34px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; box-shadow: 0 6px 12px rgba(15,23,42,0.06); }
        .product-card h3 { margin:0; font-weight:800; font-size:16px; color:#071029; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; white-space:normal; line-height:1.1; }
        .product-card .price-row { background: #ffffff; padding: 16px 18px 20px 18px; display:flex; justify-content:space-between; align-items:center; gap:12px; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .product-card .price { margin:0; font-size:16px; font-weight:900; color:#ff6a00; }
        .product-card .cat-pill { display:inline-block; padding:7px 12px; background:#ffffff; color:#0f172a; border-radius:999px; font-size:13px; border:1px solid #ececec; }
      </style>

      <div id="productGrid">
        {% for product in all_products %}
        <div class="product-card" data-category="{{ product.category }}" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
          <button aria-label="remove" style="position: absolute; top: 10px; right: 10px; width: 26px; height: 26px; border-radius: 999px; border: none; background: rgba(239,68,68,0.06); color: #ef4444; font-weight: 700; font-size: 14px; cursor: pointer; display:flex; align-items:center; justify-content:center;">‚úï</button>
          {% if product.image %}
            <div class="product-image"><img src="{{ product.image }}" alt="{{ product.name }}"></div>
          {% else %}
            <div class="product-image"><div style="font-size:44px">üçΩÔ∏è</div></div>
          {% endif %}

          <div class="name-strip">
            <h3 title="{{ product.name }}">{{ product.name }}</h3>
          </div>

          <div class="price-row">
            <p class="price">‚Ç±{{ product.price|floatformat:2 }}</p>
            <span class="cat-pill">{{ product.category }}</span>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination Controls -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
        <div style="display: flex; gap: 8px;">
          <button id="prevBtn" style="padding: 8px 12px; background: var(--border); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; color: var(--fg);">‚Üê Prev</button>
          <button id="nextBtn" style="padding: 8px 12px; background: var(--border); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; color: var(--fg);">Next ‚Üí</button>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <select id="itemsPerPage" style="padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer; background: #fff;">
            <option value="6" selected>6 per page</option>
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="48">48 per page</option>
          </select>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600;" id="pageInfo">Page 1</div>
      </div>

      <!-- Bottom logout button removed per request -->
    </div>

    <!-- Right: Transaction Cart -->


    <!-- Right: Transaction Cart -->
    <div style="width: 480px; background: #fff; padding: 24px; display: flex; flex-direction: column; box-shadow: -4px 0 16px rgba(0,0,0,0.1); overflow-y: auto; position: sticky; top: 20px; align-self: flex-start; height: calc(100vh - 40px);">
      <!-- Header with Badge -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 24px;">üõí</span>
          <h2 style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);">Transaction Cart</h2>
        </div>
        <div style="background: #0066FF; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;" id="cartCount">0</div>
      </div>

      <!-- Cart Items -->
      <div style="flex: 1; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 8px; padding: 16px; background: #f9f9f9; min-height: 200px;" id="orderItems">
        <div style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 48px; margin-bottom: 12px;">üõí</div>
          <p style="margin: 0 0 4px 0; color: var(--text-secondary); font-weight: 600;">Cart is empty</p>
          <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">Search and select products to begin</p>
        </div>
      </div>

      <!-- Divider -->
      <div style="height: 1px; background: var(--border); margin-bottom: 20px;"></div>

      <!-- Summary Section -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px;">
          <span style="color: var(--text-secondary);">Subtotal:</span>
          <span style="font-weight: 600; color: var(--fg);" id="subtotal">‚Ç±0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 13px;">
          <span style="color: var(--text-secondary);">Discount: <span style="color: #16a34a;">‚Ç±0.00</span></span>
          <span style="font-weight: 600; color: var(--fg);" id="discount">‚Ç±0.00</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding: 12px; background: #e8f5f0; border-radius: 8px; margin-bottom: 20px; border-top: 3px solid #16a34a;">
          <span style="font-weight: 700; color: var(--fg); font-size: 16px;">TOTAL:</span>
          <span style="font-weight: 700; color: #16a34a; font-size: 20px;" id="total">‚Ç±0.00</span>
        </div>
      </div>

      <!-- Amount Paid & Change -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 600; color: var(--fg);">Amount Paid:</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <span style="color: var(--text-secondary); font-weight: 600;">‚Ç±</span>
          <input type="number" id="amountPaid" placeholder="0.00" style="flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
        </div>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f0f0f0; border-radius: 8px; margin-bottom: 20px;">
        <span style="font-weight: 600; color: var(--fg); font-size: 13px;">Change:</span>
        <span style="font-weight: 700; color: #16a34a; font-size: 18px;" id="change">‚Ç±0.00</span>
      </div>

      <!-- Customer Name -->
      <input type="text" placeholder="Customer name (Optional)" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; margin-bottom: 16px; background: #f9f9f9;">

      <!-- Process Button -->
      <button id="checkoutBtn" type="button" style="width: 100%; padding: 14px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s ease;">
        <span>‚úì</span>PROCESS
      </button>
    </div>
  </div>

  <script>
    let cart = [];
    let currentPage = 1;
    let itemsPerPage = 6;
    let filteredProducts = [];

    // Build products object from Django template data
    const products = {};
    {% for product in all_products %}
    products[{{ product.id }}] = {
      id: {{ product.id }},
      name: '{{ product.name }}',
      category: '{{ product.category }}',
      price: {{ product.price }}
    };
    {% endfor %}

    // Get all product cards
    const allProductCards = Array.from(document.querySelectorAll('.product-card'));
    
    // Initialize filtered products with all products
    filteredProducts = allProductCards;

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.style.color = 'var(--text-secondary)';
          b.style.borderBottomColor = 'transparent';
        });
        btn.style.color = '#0066FF';
        btn.style.borderBottomColor = '#0066FF';
      });
    });

    function updatePagination() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      filteredProducts = allProductCards.filter(card => {
        const name = card.dataset.name.toLowerCase();
        return name.includes(searchTerm);
      });

      currentPage = 1;
      displayPage();
    }

    function displayPage() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

      // Hide all products
      allProductCards.forEach(card => card.style.display = 'none');

      // Show current page products
      filteredProducts.slice(startIndex, endIndex).forEach(card => {
        card.style.display = 'flex';
      });

      // Update pagination info
      const showing = filteredProducts.length > 0 ? `${startIndex + 1}-${Math.min(endIndex, filteredProducts.length)} of ${filteredProducts.length}` : '0';
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1} (${showing})`;

      // Update button states
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
      document.getElementById('prevBtn').style.opacity = currentPage === 1 ? '0.5' : '1';
      document.getElementById('nextBtn').style.opacity = (currentPage === totalPages || totalPages === 0) ? '0.5' : '1';
    }

    document.getElementById('searchInput').addEventListener('input', updatePagination);

    // Category filtering
    document.querySelectorAll('.category-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active tab style
        document.querySelectorAll('.category-filter').forEach(b => {
          b.style.background = 'transparent';
          b.style.color = 'var(--text-secondary)';
          b.style.borderColor = 'var(--border)';
        });
        btn.style.background = '#fff';
        btn.style.color = '#374151';
        btn.style.borderColor = '#0066FF';

        // Filter products by category
        const selectedCategory = btn.dataset.category;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (selectedCategory === 'All') {
          filteredProducts = allProductCards.filter(card => 
            card.dataset.name.toLowerCase().includes(searchTerm)
          );
        } else {
          filteredProducts = allProductCards.filter(card => 
            card.dataset.category === selectedCategory && 
            card.dataset.name.toLowerCase().includes(searchTerm)
          );
        }
        
        currentPage = 1;
        displayPage();
      });
    });

    document.getElementById('searchInput').addEventListener('input', updatePagination);

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        displayPage();
        document.getElementById('productGrid').scrollTop = 0;
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        displayPage();
        document.getElementById('productGrid').scrollTop = 0;
      }
    });

    document.getElementById('itemsPerPage').addEventListener('change', (e) => {
      itemsPerPage = parseInt(e.target.value);
      currentPage = 1;
      displayPage();
    });

    allProductCards.forEach(card => {
      card.addEventListener('click', () => {
        const product = products[card.dataset.id];
        addToCart(product);
      });
    });

    function addToCart(product) {
      const existing = cart.find(item => item.id === product.id);

      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      updateCart();
    }

    function updateCart() {
      const orderItemsDiv = document.getElementById('orderItems');
      orderItemsDiv.innerHTML = '';

      if (cart.length === 0) {
        orderItemsDiv.innerHTML = `
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 12px;">üõí</div>
            <p style="margin: 0 0 4px 0; color: var(--text-secondary); font-weight: 600;">Cart is empty</p>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">Search and select products to begin</p>
          </div>
        `;
        document.getElementById('cartCount').textContent = '0';
      } else {
        cart.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'display: flex; gap: 12px; align-items: center; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--border);';
          itemDiv.innerHTML = `
            <div style="flex: 1;">
              <p style="margin: 0 0 4px 0; font-weight: 600; font-size: 12px; color: var(--fg);">${item.name}</p>
              <p style="margin: 0; font-size: 13px; color: #16a34a; font-weight: 700;">‚Ç±${item.price.toFixed(2)}</p>
            </div>
            <div style="display: flex; align-items: center; gap: 4px;">
              <button class="qty-minus" data-id="${item.id}" style="padding: 2px 5px; background: var(--border); border: none; cursor: pointer; font-size: 12px; color: var(--fg); border-radius: 3px; font-weight: 700;">‚àí</button>
              <span style="padding: 4px 8px; font-weight: 600; color: var(--fg); font-size: 12px; min-width: 28px; text-align: center; background: var(--muted); border-radius: 3px;">${item.quantity}</span>
              <button class="qty-plus" data-id="${item.id}" style="padding: 2px 5px; background: var(--border); border: none; cursor: pointer; font-size: 12px; color: var(--fg); border-radius: 3px; font-weight: 700;">+</button>
            </div>
          `;
          orderItemsDiv.appendChild(itemDiv);
        });

        document.getElementById('cartCount').textContent = cart.length;

        document.querySelectorAll('.qty-plus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = parseInt(btn.dataset.id);
            const item = cart.find(p => p.id === id);
            if (item) item.quantity++;
            updateCart();
          });
        });

        document.querySelectorAll('.qty-minus').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = parseInt(btn.dataset.id);
            const item = cart.find(p => p.id === id);
            if (item) {
              item.quantity--;
              if (item.quantity === 0) {
                cart = cart.filter(p => p.id !== id);
              }
            }
            updateCart();
          });
        });
      }

      updateSummary();
    }

    function updateSummary() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const discount = 0;
      const total = subtotal - discount;

      document.getElementById('subtotal').textContent = '‚Ç±' + subtotal.toFixed(2);
      document.getElementById('discount').textContent = '‚Ç±' + discount.toFixed(2);
      document.getElementById('total').textContent = '‚Ç±' + total.toFixed(2);
      updateChange();
    }

    function updateChange() {
      const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const change = Math.max(0, amountPaid - total);
      document.getElementById('change').textContent = '‚Ç±' + change.toFixed(2);
    }

    function processPayment() {
      if (cart.length === 0) {
        alert('Please add items to cart first');
        return;
      }
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const total = subtotal;
      const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
      
      if (amountPaid < total) {
        alert('Insufficient payment');
        return;
      }
      
      // helper: read cookie (for csrftoken fallback)
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // Send sale data to server (include credentials so session cookie is sent)
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
      console.log('Using CSRF token:', csrfToken);

      const payload = {
        items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity }))
      };
      console.log('Posting sales payload:', payload);

      fetch('/sales/api/create/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          items: cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity
          }))
        })
      })
      .then(async response => {
        // If redirected (e.g., to login), surface an error
        if (response.redirected) {
          throw new Error('Request was redirected (maybe your session expired). Please login and try again.');
        }
        // Try parse JSON, but handle non-JSON gracefully
        const text = await response.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error('Invalid server response: ' + text.slice(0, 200));
        }
      })
      .then(data => {
        if (data && data.success) {
          const change = amountPaid - total;
          alert(`Payment processed!\nTotal: ‚Ç±${total.toFixed(2)}\nChange: ‚Ç±${change.toFixed(2)}`);

          // Persist sale to localStorage so Sales Dashboard (which reads localStorage) updates
          const saleRecord = {
            timestamp: new Date().toLocaleString(),
            total: total,
            items: cart.map(i => ({ id: i.id, name: i.name, price: i.price, quantity: i.quantity, category: (products[i.id] && products[i.id].category) || '' }))
          };
          try {
            const existing = JSON.parse(localStorage.getItem('salesHistory')) || [];
            existing.push(saleRecord);
            localStorage.setItem('salesHistory', JSON.stringify(existing));
            // Also dispatch a storage event for other tabs/windows
            try { window.dispatchEvent(new Event('storage')); } catch (e) {}
          } catch (e) {
            console.warn('Failed to persist salesHistory to localStorage', e);
          }

          cart = [];
          document.getElementById('amountPaid').value = '';
          updateCart();
        } else {
          alert('Error: ' + (data && data.error ? data.error : 'Failed to process payment'));
        }
      })
      .catch(error => {
        console.error('Error processing payment:', error);
        alert('Error processing payment: ' + error.message);
      });
    }

    document.getElementById('amountPaid').addEventListener('input', updateChange);
    // Wire checkout button
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) {
      checkoutBtn.addEventListener('click', processPayment);
    }

    // Initialize pagination display
    displayPage();
  </script>
{% endblock %}
