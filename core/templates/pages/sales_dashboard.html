{% extends "layouts/base.html" %}

{% block title %}Sales Dashboard - Koki's Foodhub{% endblock %}

{% block content %}
  <div style="padding: 24px 20px; background: #f5f5f5; min-height: 100vh;">
    <!-- Header -->
    <div style="margin-bottom: 24px;">
      <h2 style="margin: 0 0 4px 0; font-size: 20px; font-weight: 700; color: var(--fg);">Sales Dashboard</h2>
      <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">Track sales, revenue, and customer purchases</p>
    </div>

    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px;">
      <!-- Total Sales Card -->
      <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <p style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Total Sales</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700; color: var(--fg);" id="totalSales">‚Ç±0.00</p>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--success);">+0% from last week</p>
          </div>
          <span style="font-size: 32px;">üí∞</span>
        </div>
      </div>

      <!-- Total Orders Card -->
      <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <p style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Total Orders</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700; color: var(--fg);" id="totalOrders">0</p>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--success);">+0% from last week</p>
          </div>
          <span style="font-size: 32px;">üì¶</span>
        </div>
      </div>

      <!-- Avg Order Value Card -->
      <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <p style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Avg Order Value</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700; color: var(--fg);" id="avgOrderValue">‚Ç±0.00</p>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--success);">+0% from last week</p>
          </div>
          <span style="font-size: 32px;">üìä</span>
        </div>
      </div>

      <!-- Popular Item Card -->
      <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div>
            <p style="margin: 0 0 8px 0; font-size: 12px; color: var(--text-secondary); font-weight: 600;">Most Popular</p>
            <p style="margin: 0; font-size: 18px; font-weight: 700; color: var(--fg);" id="popularItem">-</p>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);" id="popularCount">0 sold</p>
          </div>
          <span style="font-size: 32px;">‚≠ê</span>
        </div>
      </div>
    </div>

    <!-- Sales by Product -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;">
      <!-- Sales History Table -->
      <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--fg);">Recent Sales History</h3>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border);">
                <th style="text-align: left; padding: 12px 8px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 11px;">Item</th>
                <th style="text-align: center; padding: 12px 8px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 11px;">Qty</th>
                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 11px;">Price</th>
                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 11px;">Total</th>
                <th style="text-align: right; padding: 12px 8px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 11px;">Time</th>
              </tr>
            </thead>
            <tbody id="salesHistoryTable">
              <tr>
                <td colspan="5" style="padding: 40px 8px; text-align: center; color: var(--text-secondary);">No sales yet. Start selling!</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Top Selling Items -->
      <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm);">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--fg);">Top Selling Items</h3>
        <div id="topItemsList" style="display: flex; flex-direction: column; gap: 12px;">
          <p style="text-align: center; color: var(--text-secondary); padding: 20px 0;">No sales data</p>
        </div>
      </div>
    </div>

    <!-- Sales by Category -->
    <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-sm); margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--fg);">Sales by Category</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="categorySales">
        <p style="text-align: center; color: var(--text-secondary); padding: 20px 0; grid-column: 1 / -1;">No sales data</p>
      </div>
    </div>
  </div>

  <script>
    // Initialize with sample data from localStorage
    let salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];

    function calculateStats() {
      if (salesHistory.length === 0) {
        document.getElementById('totalSales').textContent = '‚Ç±0.00';
        document.getElementById('totalOrders').textContent = '0';
        document.getElementById('avgOrderValue').textContent = '‚Ç±0.00';
        document.getElementById('popularItem').textContent = '-';
        document.getElementById('popularCount').textContent = '0 sold';
        return;
      }

      // Calculate totals
      const totalSales = salesHistory.reduce((sum, sale) => sum + (sale.total || 0), 0);
      const totalOrders = salesHistory.length;
      const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

      document.getElementById('totalSales').textContent = '‚Ç±' + totalSales.toFixed(2);
      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('avgOrderValue').textContent = '‚Ç±' + avgOrderValue.toFixed(2);

      // Find most popular item
      const itemCounts = {};
      salesHistory.forEach(sale => {
        if (sale.items) {
          sale.items.forEach(item => {
            itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
          });
        }
      });

      if (Object.keys(itemCounts).length > 0) {
        const popular = Object.entries(itemCounts).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('popularItem').textContent = popular[0];
        document.getElementById('popularCount').textContent = popular[1] + ' sold';
      }

      updateSalesHistoryTable();
      updateTopItemsList();
      updateCategorySales();
    }

    function updateSalesHistoryTable() {
      const tbody = document.getElementById('salesHistoryTable');
      if (salesHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px 8px; text-align: center; color: var(--text-secondary);">No sales yet. Start selling!</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      const allItems = [];
      salesHistory.forEach(sale => {
        if (sale.items) {
          sale.items.forEach(item => {
            allItems.push({
              ...item,
              saleTime: sale.timestamp || new Date().toLocaleTimeString(),
              saleTotal: item.price * item.quantity
            });
          });
        }
      });

      allItems.reverse().forEach(item => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--border)';
        row.style.transition = 'background 0.2s ease';
        row.addEventListener('mouseenter', () => row.style.background = '#f9f9f9');
        row.addEventListener('mouseleave', () => row.style.background = 'transparent');
        row.innerHTML = `
          <td style="padding: 12px 8px; color: var(--fg); font-weight: 500;">${item.name}</td>
          <td style="padding: 12px 8px; text-align: center; color: var(--text-secondary);">${item.quantity}</td>
          <td style="padding: 12px 8px; text-align: right; color: var(--text-secondary);">‚Ç±${item.price.toFixed(2)}</td>
          <td style="padding: 12px 8px; text-align: right; color: var(--accent); font-weight: 600;">‚Ç±${item.saleTotal.toFixed(2)}</td>
          <td style="padding: 12px 8px; text-align: right; color: var(--text-secondary); font-size: 12px;">${item.saleTime}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function updateTopItemsList() {
      const container = document.getElementById('topItemsList');
      const itemCounts = {};
      
      salesHistory.forEach(sale => {
        if (sale.items) {
          sale.items.forEach(item => {
            if (!itemCounts[item.name]) {
              itemCounts[item.name] = { quantity: 0, price: item.price, revenue: 0 };
            }
            itemCounts[item.name].quantity += item.quantity;
            itemCounts[item.name].revenue += item.price * item.quantity;
          });
        }
      });

      const topItems = Object.entries(itemCounts).sort((a, b) => b[1].quantity - a[1].quantity).slice(0, 5);

      if (topItems.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px 0;">No sales data</p>';
        return;
      }

      container.innerHTML = '';
      topItems.forEach((item, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'padding: 12px; background: #f9f9f9; border-radius: 6px; border-left: 3px solid var(--accent);';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="font-weight: 600; color: var(--fg);">${index + 1}. ${item[0]}</span>
            <span style="color: var(--accent); font-weight: 700;">${item[1].quantity}</span>
          </div>
          <div style="font-size: 12px; color: var(--text-secondary);">Revenue: ‚Ç±${item[1].revenue.toFixed(2)}</div>
        `;
        container.appendChild(div);
      });
    }

    function updateCategorySales() {
      const container = document.getElementById('categorySales');
      const categorySales = {};

      salesHistory.forEach(sale => {
        if (sale.items) {
          sale.items.forEach(item => {
            const category = item.category || 'Other';
            if (!categorySales[category]) {
              categorySales[category] = { quantity: 0, revenue: 0 };
            }
            categorySales[category].quantity += item.quantity;
            categorySales[category].revenue += item.price * item.quantity;
          });
        }
      });

      if (Object.keys(categorySales).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px 0; grid-column: 1 / -1;">No sales data</p>';
        return;
      }

      container.innerHTML = '';
      const categories = Object.entries(categorySales).sort((a, b) => b[1].revenue - a[1].revenue);
      categories.forEach(([category, data]) => {
        const div = document.createElement('div');
        div.style.cssText = 'padding: 16px; background: linear-gradient(135deg, var(--accent) 0%, #ff7043 100%); border-radius: 8px; color: white;';
        div.innerHTML = `
          <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">${category}</p>
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-size: 12px;">Items Sold</span>
            <span style="font-weight: 700;">${data.quantity}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="font-size: 12px;">Revenue</span>
            <span style="font-weight: 700;">‚Ç±${data.revenue.toFixed(2)}</span>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Listen for sales updates from the dashboard
    window.addEventListener('storage', (e) => {
      if (e.key === 'salesHistory') {
        salesHistory = JSON.parse(e.newValue) || [];
        calculateStats();
      }
    });

    // Initial calculation
    calculateStats();
  </script>
{% endblock %}
