{% extends "layouts/base.html" %}
{% block content %}
<div class="forecast-wrapper">
  <div class="page-header">
    <h1 class="section-title">Product Performance</h1>
    <p class="muted" style="font-size:15px; margin-top:8px;">Manage inventory and view sales predictions</p>
  </div>

  <div class="card" style="margin-top:18px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="perfSearch" class="input small" placeholder="Search products..." style="min-width:300px;" />
        <select id="categoryFilter" class="input small" style="width:150px;">
          <option value="">All</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="rowsPerPage" class="input small" style="width:86px;"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select>
        <button id="downloadReportBtn" class="btn small">Download Report</button>
      </div>
    </div>

    <div style="overflow:auto;">
      <table class="table" id="productPerformanceTable" aria-label="Product performance table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:2px solid #e5e7eb; background:#f9fafb;">
            <th style="text-align:left; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="product">PRODUCT NAME <span class="sort-arrow">↕</span></th>
            <th style="text-align:left; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="category">CATEGORY <span class="sort-arrow">↕</span></th>
            <th style="text-align:right; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="last_7">LAST 7 DAYS <span class="sort-arrow">↕</span></th>
            <th style="text-align:right; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="last_30">LAST 30 DAYS <span class="sort-arrow">↕</span></th>
            <th style="text-align:center; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="trend">TREND <span class="sort-arrow">↕</span></th>
            <th style="text-align:right; padding:12px 8px; font-weight:700; color:#059669; cursor:pointer;" class="sortable-col" data-sort="forecast">PREDICTED (NEXT 7D) <span class="sort-arrow">↕</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px;">
      <div id="perfSummary" class="muted small">Showing 0 results</div>
      <div id="perfPagination"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const apiUrl = '{{ api_url }}';
      let perfProducts = [];
      let perfCurrentPage = 1;
      let perfRowsPerPage = 10;
      let perfSortCol = 'forecast';
      let perfSortAsc = false;
      let allCategories = new Set();

      function formatNumber(n){ 
        return (n === 0 ? '0' : n.toLocaleString()); 
      }

      function renderTable(products){
        perfProducts = (products || []).slice();
        
        // Collect all unique categories
        allCategories.clear();
        perfProducts.forEach(p => {
          if(p.category) allCategories.add(p.category);
        });
        
        // Populate category filter
        const catFilter = document.getElementById('categoryFilter');
        if(catFilter){
          const currentValue = catFilter.value;
          catFilter.innerHTML = '<option value="">All</option>';
          Array.from(allCategories).sort().forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            catFilter.appendChild(opt);
          });
          catFilter.value = currentValue;
        }
        
        perfCurrentPage = 1;
        renderPerfTablePage();
      }

      function sortProducts(products){
        const sorted = [...products];
        sorted.sort((a, b) => {
          let aVal, bVal;
          
          switch(perfSortCol){
            case 'product':
              aVal = (a.product || '').toLowerCase();
              bVal = (b.product || '').toLowerCase();
              break;
            case 'category':
              aVal = (a.category || '').toLowerCase();
              bVal = (b.category || '').toLowerCase();
              break;
            case 'last_7':
              aVal = a.last_7_days || a.past_7_days || 0;
              bVal = b.last_7_days || b.past_7_days || 0;
              break;
            case 'last_30':
              aVal = a.last_30_days || a.past_30_days || 0;
              bVal = b.last_30_days || b.past_30_days || 0;
              break;
            case 'trend':
              aVal = a.growth_rate || 0;
              bVal = b.growth_rate || 0;
              break;
            case 'forecast':
              aVal = a.forecast_h || 0;
              bVal = b.forecast_h || 0;
              break;
            default:
              return 0;
          }
          
          if(typeof aVal === 'string'){
            return perfSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return perfSortAsc ? aVal - bVal : bVal - aVal;
        });
        
        return sorted;
      }

      function renderPerfTablePage(){
        const tbody = document.querySelector('#productPerformanceTable tbody');
        if(!tbody) return;

        const searchVal = (document.getElementById('perfSearch')?.value || '').toLowerCase().trim();
        const categoryVal = (document.getElementById('categoryFilter')?.value || '').trim();
        
        let filtered = perfProducts.filter(p => {
          const matchSearch = !searchVal || (p.product || '').toLowerCase().includes(searchVal) || (p.category || '').toLowerCase().includes(searchVal);
          const matchCategory = !categoryVal || (p.category || '') === categoryVal;
          return matchSearch && matchCategory;
        });
        
        // Apply sorting
        filtered = sortProducts(filtered);

        const total = filtered.length;
        const rowsPerPageEl = document.getElementById('rowsPerPage');
        perfRowsPerPage = rowsPerPageEl ? parseInt(rowsPerPageEl.value, 10) : 10;
        const start = (perfCurrentPage - 1) * perfRowsPerPage;
        const pageItems = filtered.slice(start, start + perfRowsPerPage);

        tbody.innerHTML = '';
        if(total === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="6" style="text-align:center; padding:40px 8px; color:#999;">No products found</td>';
          tbody.appendChild(tr);
        } else {
          pageItems.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #e5e7eb';
            const gv = Number(p.growth_rate || 0);
            let trendMarkup = '';
            if(gv > 0){
              trendMarkup = `<span style="color:#059669; font-weight:600;">+${gv}%</span>`;
            } else if(gv < 0){
              trendMarkup = `<span style="color:#dc2626; font-weight:600;">${gv}%</span>`;
            } else {
              trendMarkup = `<span style="color:#6b7280; font-weight:600;">0%</span>`;
            }
            
            tr.innerHTML = `
              <td style="padding:12px 8px; font-weight:600; color:#111827;"><a href="#" data-pid="${p.product_id}" class="select-product" style="color:#0066cc; text-decoration:none;">${p.product}</a></td>
              <td style="padding:12px 8px; color:#6b7280;">${p.category || ''}</td>
              <td style="padding:12px 8px; text-align:right; color:#111827;">${formatNumber(p.past_7_days || p.last_7_days || 0)}</td>
              <td style="padding:12px 8px; text-align:right; color:#111827;">${formatNumber(p.past_30_days || p.last_30_days || 0)}</td>
              <td style="padding:12px 8px; text-align:center;">${trendMarkup}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:700; color:#059669;">${formatNumber(p.forecast_h || 0)}</td>
            `;
            tbody.appendChild(tr);
          });
        }

        if(total === 0){
          document.getElementById('perfSummary').innerText = 'Showing 0 results';
        } else {
          const end = Math.min(total, start + pageItems.length);
          document.getElementById('perfSummary').innerText = `Showing ${start + 1} to ${end} of ${total} results`;
        }
        renderPerfPagination(Math.ceil(total / perfRowsPerPage), perfCurrentPage);

        document.querySelectorAll('.select-product').forEach(a => {
          a.addEventListener('click', function(ev){ ev.preventDefault(); });
        });
      }

      function renderPerfPagination(totalPages, current){
        const el = document.getElementById('perfPagination');
        if(!el) return; 
        el.innerHTML = '';
        if(totalPages <= 1) return;

        const createBtn = (n, label, active=false) => {
          const b = document.createElement('button');
          b.style.padding = '6px 10px';
          b.style.margin = '0 2px';
          b.style.border = '1px solid #d1d5db';
          b.style.borderRadius = '4px';
          b.style.cursor = 'pointer';
          b.style.backgroundColor = active ? '#0066cc' : '#ffffff';
          b.style.color = active ? '#ffffff' : '#111827';
          b.style.fontWeight = active ? '600' : '500';
          b.innerText = label || n;
          b.addEventListener('click', function(){ perfCurrentPage = n; renderPerfTablePage(); });
          return b;
        };

        const prev = document.createElement('button'); 
        prev.style.padding = '6px 10px';
        prev.style.margin = '0 2px';
        prev.style.border = '1px solid #d1d5db';
        prev.style.borderRadius = '4px';
        prev.style.cursor = current === 1 ? 'not-allowed' : 'pointer';
        prev.style.backgroundColor = '#ffffff';
        prev.style.opacity = current === 1 ? '0.5' : '1';
        prev.innerText = 'Previous'; 
        prev.disabled = current === 1; 
        prev.addEventListener('click', ()=>{ perfCurrentPage = Math.max(1, current-1); renderPerfTablePage(); }); 
        el.appendChild(prev);

        const startPage = Math.max(1, current - 2);
        const endPage = Math.min(totalPages, startPage + 4);
        for(let p = startPage; p <= endPage; p++){ 
          el.appendChild(createBtn(p, p, p === current)); 
        }

        const next = document.createElement('button'); 
        next.style.padding = '6px 10px';
        next.style.margin = '0 2px';
        next.style.border = '1px solid #d1d5db';
        next.style.borderRadius = '4px';
        next.style.cursor = current === totalPages ? 'not-allowed' : 'pointer';
        next.style.backgroundColor = '#ffffff';
        next.style.opacity = current === totalPages ? '0.5' : '1';
        next.innerText = 'Next'; 
        next.disabled = current === totalPages; 
        next.addEventListener('click', ()=>{ perfCurrentPage = Math.min(totalPages, current+1); renderPerfTablePage(); }); 
        el.appendChild(next);
      }

      const perfSearchEl = document.getElementById('perfSearch');
      if(perfSearchEl){ 
        perfSearchEl.addEventListener('input', function(){ perfCurrentPage = 1; setTimeout(renderPerfTablePage, 200); }); 
      }
      
      const categoryFilterEl = document.getElementById('categoryFilter');
      if(categoryFilterEl){
        categoryFilterEl.addEventListener('change', function(){ perfCurrentPage = 1; renderPerfTablePage(); });
      }
      
      const sortableHeaders = document.querySelectorAll('.sortable-col');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', function(){
          const col = this.getAttribute('data-sort');
          if(perfSortCol === col){
            perfSortAsc = !perfSortAsc;
          } else {
            perfSortCol = col;
            perfSortAsc = false;
          }
          perfCurrentPage = 1;
          renderPerfTablePage();
        });
      });
      
      const rowsPerPageEl = document.getElementById('rowsPerPage');
      if(rowsPerPageEl){ 
        rowsPerPageEl.addEventListener('change', function(){ perfRowsPerPage = parseInt(this.value, 10); perfCurrentPage = 1; renderPerfTablePage(); }); 
      }

      const downloadReportBtn = document.getElementById('downloadReportBtn');
      if(downloadReportBtn){ 
        downloadReportBtn.addEventListener('click', function(){ 
          if(!perfProducts || !perfProducts.length){ alert('No data to export'); return; } 
          const headers = ['Product', 'Category', 'Last 7 Days', 'Last 30 Days', 'Trend %', 'Predicted (7d)'];
          const rows = perfProducts.map(p => [
            p.product, 
            p.category || '',
            p.past_7_days || p.last_7_days || 0, 
            p.past_30_days || p.last_30_days || 0, 
            p.growth_rate || 0, 
            p.forecast_h || 0
          ]);
          const csv = [headers.join(',')].concat(rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))).join('\n');
          const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'product_performance.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }); 
      }

      async function fetchData(){
        try{
          const params = new URLSearchParams();
          params.set('horizon', '7');
          params.set('top', '1000');

          console.log('[Product Performance] Fetching with URL:', apiUrl + '?' + params.toString());
          const res = await fetch(apiUrl + '?' + params.toString(), { credentials: 'same-origin', cache: 'no-store' });
          
          if(!res.ok){ 
            console.warn('[Product Performance] API error status:', res.status);
            return; 
          }

          const json = await res.json();
          if(json && json.error){ 
            console.warn('[Product Performance] API error:', json.error);
            return; 
          }

          const top = json.top || [];
          console.log('[Product Performance] Got', top.length, 'products');
          renderTable(top);
        }catch(e){ 
          console.error('[Product Performance] Error:', e); 
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function(){ setTimeout(fetchData, 100); });
      } else {
        setTimeout(fetchData, 100);
      }
    })();
  </script>
</div>
{% endblock %}
