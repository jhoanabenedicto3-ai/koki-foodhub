{% extends "layouts/base.html" %}
{% block content %}
<div class="forecast-wrapper">
  <!-- Dashboard Overview Section -->
  <div style="margin-bottom:24px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div>
        <h1 class="section-title">Dashboard Overview</h1>
        <p class="muted" style="font-size:15px; margin-top:8px;">AI-powered sales predictions and inventory insights.</p>
      </div>
      <div style="font-size:13px; color:var(--text-secondary); display:flex; align-items:center; gap:4px;">
        <span style="width:8px; height:8px; background:#059669; border-radius:50%; display:inline-block;"></span>
        <span>Last updated: <span id="lastUpdated">Just now</span></span>
      </div>
    </div>

    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:16px; margin-bottom:24px;">
      <!-- Next Day Forecast Card -->
      <div class="card" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
          <div>
            <p style="margin:0; font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase;">Next Day Forecast</p>
            <div style="display:flex; align-items:baseline; gap:8px; margin-top:8px;">
              <h2 id="forecast1d" style="margin:0; font-size:28px; font-weight:700; color:var(--fg);">0</h2>
              <span id="forecast1dTrend" style="color:#059669; font-weight:600;">↑ 0%</span>
            </div>
          </div>
        </div>
        <div style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
            <span style="font-size:12px; color:var(--text-secondary);">Confidence Score</span>
            <span style="font-size:12px; font-weight:600; color:var(--fg);" id="forecast1dConf">92%</span>
          </div>
          <div style="height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden;">
            <div id="forecast1dConfBar" style="height:100%; background:#059669; width:92%; border-radius:3px;"></div>
          </div>
        </div>
        <div>
          <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase;">Top Predicted Items</p>
          <div id="forecast1dItems" style="display:flex; flex-direction:column; gap:6px;">
            <div style="display:flex; justify-content:space-between; font-size:13px;">
              <span>-</span><span style="color:var(--text-secondary);">0 units</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Week Forecast Card -->
      <div class="card" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
          <div>
            <p style="margin:0; font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase;">Next Week Forecast</p>
            <div style="display:flex; align-items:baseline; gap:8px; margin-top:8px;">
              <h2 id="forecast7d" style="margin:0; font-size:28px; font-weight:700; color:var(--fg);">0</h2>
              <span id="forecast7dTrend" style="color:#059669; font-weight:600;">↑ 0%</span>
            </div>
          </div>
        </div>
        <div style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
            <span style="font-size:12px; color:var(--text-secondary);">Confidence Score</span>
            <span style="font-size:12px; font-weight:600; color:var(--fg);" id="forecast7dConf">85%</span>
          </div>
          <div style="height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden;">
            <div id="forecast7dConfBar" style="height:100%; background:#059669; width:85%; border-radius:3px;"></div>
          </div>
        </div>
        <div>
          <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase;">Top Predicted Items</p>
          <div id="forecast7dItems" style="display:flex; flex-direction:column; gap:6px;">
            <div style="display:flex; justify-content:space-between; font-size:13px;">
              <span>-</span><span style="color:var(--text-secondary);">0 units</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Month Forecast Card -->
      <div class="card" style="padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
          <div>
            <p style="margin:0; font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase;">Next Month Forecast</p>
            <div style="display:flex; align-items:baseline; gap:8px; margin-top:8px;">
              <h2 id="forecast30d" style="margin:0; font-size:28px; font-weight:700; color:var(--fg);">0</h2>
              <span id="forecast30dTrend" style="color:#059669; font-weight:600;">↑ 0%</span>
            </div>
          </div>
          <div style="font-size:18px; color:var(--warning);">⏱</div>
        </div>
        <div style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
            <span style="font-size:12px; color:var(--text-secondary);">Confidence Score</span>
            <span style="font-size:12px; font-weight:600; color:var(--fg);" id="forecast30dConf">68%</span>
          </div>
          <div style="height:6px; background:#e5e7eb; border-radius:3px; overflow:hidden;">
            <div id="forecast30dConfBar" style="height:100%; background:var(--warning); width:68%; border-radius:3px;"></div>
          </div>
        </div>
        <div>
          <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase;">Top Predicted Items</p>
          <div id="forecast30dItems" style="display:flex; flex-direction:column; gap:6px;">
            <div style="display:flex; justify-content:space-between; font-size:13px;">
              <span>-</span><span style="color:var(--text-secondary);">0 units</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Performance Section -->
  <div class="page-header">
    <h1 class="section-title">Product Performance</h1>
    <p class="muted" style="font-size:15px; margin-top:8px;">Manage inventory and view sales predictions</p>
  </div>

  <div class="card" style="margin-top:18px;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="perfSearch" class="input small" placeholder="Search products..." style="min-width:300px;" />
        <select id="categoryFilter" class="input small" style="width:150px;">
          <option value="">All</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="rowsPerPage" class="input small" style="width:86px;"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select>
        <button id="downloadReportBtn" class="btn small">Download Report</button>
      </div>
    </div>

    <div style="overflow:auto;">
      <table class="table" id="productPerformanceTable" aria-label="Product performance table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:2px solid #e5e7eb; background:#f9fafb;">
            <th style="text-align:left; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="product">PRODUCT NAME <span class="sort-arrow">↕</span></th>
            <th style="text-align:left; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="category">CATEGORY <span class="sort-arrow">↕</span></th>
            <th style="text-align:right; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="last_7">LAST 7 DAYS <span class="sort-arrow">↕</span></th>
            <th style="text-align:right; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="last_30">LAST 30 DAYS <span class="sort-arrow">↕</span></th>
            <th style="text-align:center; padding:12px 8px; font-weight:700; color:#374151; cursor:pointer;" class="sortable-col" data-sort="trend">TREND <span class="sort-arrow">↕</span></th>
            <th style="text-align:right; padding:12px 8px; font-weight:700; color:#059669; cursor:pointer;" class="sortable-col" data-sort="forecast">PREDICTED (NEXT 7D) <span class="sort-arrow">↕</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px; margin-bottom:24px;">
      <div id="perfSummary" class="muted small">Showing 0 results</div>
      <div id="perfPagination"></div>
    </div>

    <!-- Performance Summary Grid -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-top:24px;">
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase;">Total Products</p>
        <p id="summaryProductCount" style="margin:0; font-size:24px; font-weight:700; color:#111827;">0</p>
      </div>
      
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase;">Total Forecast (7D)</p>
        <p id="summaryTotalForecast" style="margin:0; font-size:24px; font-weight:700; color:#059669;">0</p>
        <p id="summaryForecastChange" style="margin:4px 0 0 0; font-size:12px; color:#6b7280;">units</p>
      </div>
      
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase;">Avg Trend</p>
        <p id="summaryAvgTrend" style="margin:0; font-size:24px; font-weight:700; color:#111827;">0%</p>
        <p style="margin:4px 0 0 0; font-size:12px; color:#6b7280;">across all products</p>
      </div>
      
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase;">Top Category</p>
        <p id="summaryTopCategory" style="margin:0; font-size:24px; font-weight:700; color:#111827;">-</p>
        <p id="summaryTopCategoryCount" style="margin:4px 0 0 0; font-size:12px; color:#6b7280;">0 products</p>
      </div>
      
      <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <p style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase;">Projected Revenue</p>
        <p id="summaryProjectedRevenue" style="margin:0; font-size:24px; font-weight:700; color:#059669;">$0</p>
        <p style="margin:4px 0 0 0; font-size:12px; color:#6b7280;">7-day forecast</p>
      </div>
      
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Dashboard Overview Data Fetching
    async function fetchDashboardData(){
      try {
        const res = await fetch('/product-forecast/api/?horizon=7&top=100', { credentials: 'same-origin', cache: 'no-store' });
        if(!res.ok) return;
        
        const data = await res.json();
        const topProducts = data.top || [];
        
        if(topProducts.length === 0) return;
        
        // Get forecasts from top products
        const forecasts = {
          '1d': { units: 0, trend: 0, conf: 0, items: [] },
          '7d': { units: 0, trend: 0, conf: 0, items: [] },
          '30d': { units: 0, trend: 0, conf: 0, items: [] }
        };
        
        // Aggregate forecasts from top products
        topProducts.slice(0, 20).forEach(p => {
          // 1-day (forecast_h is 7-day, so divide by 7 for daily)
          const f1 = Math.round((p.forecast_h || 0) / 7);
          forecasts['1d'].units += f1;
          forecasts['1d'].items.push({ name: p.product, units: f1, conf: p.confidence || 0 });
          
          // 7-day (use forecast_h directly)
          const f7 = (p.forecast_h || 0);
          forecasts['7d'].units += f7;
          forecasts['7d'].items.push({ name: p.product, units: f7, conf: p.confidence || 0 });
          
          // 30-day (multiply 7-day by ~4.3)
          const f30 = Math.round(f7 * 4.3);
          forecasts['30d'].units += f30;
          forecasts['30d'].items.push({ name: p.product, units: f30, conf: p.confidence || 0 });
        });
        
        // Calculate average confidence for each horizon
        forecasts['1d'].conf = topProducts.length > 0 ? Math.round(topProducts.slice(0, 5).reduce((s, p) => s + (p.confidence || 0), 0) / Math.min(5, topProducts.length)) : 0;
        forecasts['7d'].conf = topProducts.length > 0 ? Math.round(topProducts.slice(0, 10).reduce((s, p) => s + (p.confidence || 0), 0) / Math.min(10, topProducts.length)) : 0;
        forecasts['30d'].conf = topProducts.length > 0 ? Math.round(topProducts.slice(0, 15).reduce((s, p) => s + (p.confidence || 0), 0) / Math.min(15, topProducts.length)) : 0;
        
        // Calculate trends (use growth_rate from top products)
        const trendValues = topProducts.slice(0, 15).map(p => p.growth_rate || 0);
        const avgTrend = trendValues.length > 0 ? trendValues.reduce((s, t) => s + t, 0) / trendValues.length : 0;
        forecasts['1d'].trend = Math.round(avgTrend * 10) / 10;
        forecasts['7d'].trend = Math.round(avgTrend * 10) / 10;
        forecasts['30d'].trend = Math.round(avgTrend * 0.5 * 10) / 10;
        
        // Sort items by units descending and keep top 3
        Object.keys(forecasts).forEach(key => {
          forecasts[key].items.sort((a, b) => b.units - a.units);
          forecasts[key].items = forecasts[key].items.slice(0, 3);
        });
        
        // Update UI
        updateDashboardCard('forecast1d', forecasts['1d']);
        updateDashboardCard('forecast7d', forecasts['7d']);
        updateDashboardCard('forecast30d', forecasts['30d']);
        
        // Update timestamp
        const now = new Date();
        document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
      } catch(e){
        console.error('Dashboard fetch error:', e);
      }
    }
    
    function updateDashboardCard(prefix, data){
      // Update forecast number
      const numEl = document.getElementById(prefix);
      if(numEl) numEl.textContent = data.units.toLocaleString();
      
      // Update trend
      const trendEl = document.getElementById(prefix + 'Trend');
      if(trendEl){
        const arrow = data.trend >= 0 ? '↑' : '↓';
        const color = data.trend >= 0 ? '#059669' : '#dc2626';
        trendEl.innerHTML = `<span style="color:${color}; font-weight:600;">${arrow} ${Math.abs(data.trend)}%</span>`;
      }
      
      // Update confidence
      const confEl = document.getElementById(prefix + 'Conf');
      if(confEl) confEl.textContent = data.conf + '%';
      
      // Update confidence bar
      const confBar = document.getElementById(prefix + 'ConfBar');
      if(confBar){
        confBar.style.width = data.conf + '%';
        confBar.style.background = data.conf >= 70 ? '#059669' : data.conf >= 50 ? '#f59e0b' : '#dc2626';
      }
      
      // Update items
      const itemsEl = document.getElementById(prefix + 'Items');
      if(itemsEl){
        itemsEl.innerHTML = '';
        if(data.items && data.items.length > 0) {
          data.items.slice(0, 3).forEach((item, i) => {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.fontSize = '13px';
            div.innerHTML = `<span style="color:var(--fg); font-weight:500;">${item.name}</span><span style="color:var(--accent); font-weight:600;">${item.units.toLocaleString()} units</span>`;
            itemsEl.appendChild(div);
          });
        }
      }
    }
    
    // Fetch dashboard data on page load
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', fetchDashboardData);
    } else {
      fetchDashboardData();
    }

    // Product Performance Table
    let perfProducts = [];
    let perfCurrentPage = 1;
    let perfRowsPerPage = 10;
      let perfSortCol = 'forecast';
      let perfSortAsc = false;
      let allCategories = new Set();

      function formatNumber(n){ 
        return (n === 0 ? '0' : n.toLocaleString()); 
      }

      function renderTable(products){
        perfProducts = (products || []).slice();
        
        // Collect all unique categories
        allCategories.clear();
        perfProducts.forEach(p => {
          if(p.category) allCategories.add(p.category);
        });
        
        // Populate category filter
        const catFilter = document.getElementById('categoryFilter');
        if(catFilter){
          const currentValue = catFilter.value;
          catFilter.innerHTML = '<option value="">All</option>';
          Array.from(allCategories).sort().forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            catFilter.appendChild(opt);
          });
          catFilter.value = currentValue;
        }
        
        perfCurrentPage = 1;
        renderPerfTablePage();
      }

      function sortProducts(products){
        const sorted = [...products];
        sorted.sort((a, b) => {
          let aVal, bVal;
          
          switch(perfSortCol){
            case 'product':
              aVal = (a.product || '').toLowerCase();
              bVal = (b.product || '').toLowerCase();
              break;
            case 'category':
              aVal = (a.category || '').toLowerCase();
              bVal = (b.category || '').toLowerCase();
              break;
            case 'last_7':
              aVal = a.last_7_days || a.past_7_days || 0;
              bVal = b.last_7_days || b.past_7_days || 0;
              break;
            case 'last_30':
              aVal = a.last_30_days || a.past_30_days || 0;
              bVal = b.last_30_days || b.past_30_days || 0;
              break;
            case 'trend':
              aVal = a.growth_rate || 0;
              bVal = b.growth_rate || 0;
              break;
            case 'forecast':
              aVal = a.forecast_h || 0;
              bVal = b.forecast_h || 0;
              break;
            default:
              return 0;
          }
          
          if(typeof aVal === 'string'){
            return perfSortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return perfSortAsc ? aVal - bVal : bVal - aVal;
        });
        
        return sorted;
      }

      function renderPerfTablePage(){
        const tbody = document.querySelector('#productPerformanceTable tbody');
        if(!tbody) return;

        const searchVal = (document.getElementById('perfSearch')?.value || '').toLowerCase().trim();
        const categoryVal = (document.getElementById('categoryFilter')?.value || '').trim();
        
        let filtered = perfProducts.filter(p => {
          const matchSearch = !searchVal || (p.product || '').toLowerCase().includes(searchVal) || (p.category || '').toLowerCase().includes(searchVal);
          const matchCategory = !categoryVal || (p.category || '') === categoryVal;
          return matchSearch && matchCategory;
        });
        
        // Apply sorting
        filtered = sortProducts(filtered);

        const total = filtered.length;
        const rowsPerPageEl = document.getElementById('rowsPerPage');
        perfRowsPerPage = rowsPerPageEl ? parseInt(rowsPerPageEl.value, 10) : 10;
        const start = (perfCurrentPage - 1) * perfRowsPerPage;
        const pageItems = filtered.slice(start, start + perfRowsPerPage);

        tbody.innerHTML = '';
        if(total === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="6" style="text-align:center; padding:40px 8px; color:#999;">No products found</td>';
          tbody.appendChild(tr);
        } else {
          pageItems.forEach((p, i) => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #e5e7eb';
            const gv = Number(p.growth_rate || 0);
            let trendMarkup = '';
            if(gv > 0){
              trendMarkup = `<span style="color:#059669; font-weight:600;">+${gv}%</span>`;
            } else if(gv < 0){
              trendMarkup = `<span style="color:#dc2626; font-weight:600;">${gv}%</span>`;
            } else {
              trendMarkup = `<span style="color:#6b7280; font-weight:600;">0%</span>`;
            }
            
            tr.innerHTML = `
              <td style="padding:12px 8px; font-weight:600; color:#111827;"><a href="#" data-pid="${p.product_id}" class="select-product" style="color:#0066cc; text-decoration:none;">${p.product}</a></td>
              <td style="padding:12px 8px; color:#6b7280;">${p.category || ''}</td>
              <td style="padding:12px 8px; text-align:right; color:#111827;">${formatNumber(p.past_7_days || p.last_7_days || 0)}</td>
              <td style="padding:12px 8px; text-align:right; color:#111827;">${formatNumber(p.past_30_days || p.last_30_days || 0)}</td>
              <td style="padding:12px 8px; text-align:center;">${trendMarkup}</td>
              <td style="padding:12px 8px; text-align:right; font-weight:700; color:#059669;">${formatNumber(p.forecast_h || 0)}</td>
            `;
            tbody.appendChild(tr);
          });
        }

        if(total === 0){
          document.getElementById('perfSummary').innerText = 'Showing 0 results';
        } else {
          const end = Math.min(total, start + pageItems.length);
          document.getElementById('perfSummary').innerText = `Showing ${start + 1} to ${end} of ${total} results`;
        }
        renderPerfPagination(Math.ceil(total / perfRowsPerPage), perfCurrentPage);

        document.querySelectorAll('.select-product').forEach(a => {
          a.addEventListener('click', function(ev){ ev.preventDefault(); });
        });
      }

      function renderPerfPagination(totalPages, current){
        const el = document.getElementById('perfPagination');
        if(!el) return; 
        el.innerHTML = '';
        if(totalPages <= 1) return;

        const createBtn = (n, label, active=false) => {
          const b = document.createElement('button');
          b.style.padding = '6px 10px';
          b.style.margin = '0 2px';
          b.style.border = '1px solid #d1d5db';
          b.style.borderRadius = '4px';
          b.style.cursor = 'pointer';
          b.style.backgroundColor = active ? '#0066cc' : '#ffffff';
          b.style.color = active ? '#ffffff' : '#111827';
          b.style.fontWeight = active ? '600' : '500';
          b.innerText = label || n;
          b.addEventListener('click', function(){ perfCurrentPage = n; renderPerfTablePage(); });
          return b;
        };

        const prev = document.createElement('button'); 
        prev.style.padding = '6px 10px';
        prev.style.margin = '0 2px';
        prev.style.border = '1px solid #d1d5db';
        prev.style.borderRadius = '4px';
        prev.style.cursor = current === 1 ? 'not-allowed' : 'pointer';
        prev.style.backgroundColor = '#ffffff';
        prev.style.opacity = current === 1 ? '0.5' : '1';
        prev.innerText = 'Previous'; 
        prev.disabled = current === 1; 
        prev.addEventListener('click', ()=>{ perfCurrentPage = Math.max(1, current-1); renderPerfTablePage(); }); 
        el.appendChild(prev);

        const startPage = Math.max(1, current - 2);
        const endPage = Math.min(totalPages, startPage + 4);
        for(let p = startPage; p <= endPage; p++){ 
          el.appendChild(createBtn(p, p, p === current)); 
        }

        const next = document.createElement('button'); 
        next.style.padding = '6px 10px';
        next.style.margin = '0 2px';
        next.style.border = '1px solid #d1d5db';
        next.style.borderRadius = '4px';
        next.style.cursor = current === totalPages ? 'not-allowed' : 'pointer';
        next.style.backgroundColor = '#ffffff';
        next.style.opacity = current === totalPages ? '0.5' : '1';
        next.innerText = 'Next'; 
        next.disabled = current === totalPages; 
        next.addEventListener('click', ()=>{ perfCurrentPage = Math.min(totalPages, current+1); renderPerfTablePage(); }); 
        el.appendChild(next);
      }

      const perfSearchEl = document.getElementById('perfSearch');
      if(perfSearchEl){ 
        perfSearchEl.addEventListener('input', function(){ perfCurrentPage = 1; setTimeout(renderPerfTablePage, 200); }); 
      }
      
      const categoryFilterEl = document.getElementById('categoryFilter');
      if(categoryFilterEl){
        categoryFilterEl.addEventListener('change', function(){ perfCurrentPage = 1; renderPerfTablePage(); });
      }
      
      const sortableHeaders = document.querySelectorAll('.sortable-col');
      sortableHeaders.forEach(th => {
        th.addEventListener('click', function(){
          const col = this.getAttribute('data-sort');
          if(perfSortCol === col){
            perfSortAsc = !perfSortAsc;
          } else {
            perfSortCol = col;
            perfSortAsc = false;
          }
          perfCurrentPage = 1;
          renderPerfTablePage();
        });
      });
      
      const rowsPerPageEl = document.getElementById('rowsPerPage');
      if(rowsPerPageEl){ 
        rowsPerPageEl.addEventListener('change', function(){ perfRowsPerPage = parseInt(this.value, 10); perfCurrentPage = 1; renderPerfTablePage(); }); 
      }

      const downloadReportBtn = document.getElementById('downloadReportBtn');
      if(downloadReportBtn){ 
        downloadReportBtn.addEventListener('click', function(){ 
          if(!perfProducts || !perfProducts.length){ alert('No data to export'); return; } 
          const headers = ['Product', 'Category', 'Last 7 Days', 'Last 30 Days', 'Trend %', 'Predicted (7d)'];
          const rows = perfProducts.map(p => [
            p.product, 
            p.category || '',
            p.past_7_days || p.last_7_days || 0, 
            p.past_30_days || p.last_30_days || 0, 
            p.growth_rate || 0, 
            p.forecast_h || 0
          ]);
          const csv = [headers.join(',')].concat(rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(','))).join('\n');
          const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'product_performance.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }); 
      }

      function updateSummaryStats(products){
        if(!products || products.length === 0) return;

        // Total products
        document.getElementById('summaryProductCount').textContent = products.length;

        // Total forecast and projected revenue
        const totalForecast = products.reduce((sum, p) => sum + (p.forecast_h || 0), 0);
        const totalRevenue = products.reduce((sum, p) => sum + (p.projected_revenue || 0), 0);
        document.getElementById('summaryTotalForecast').textContent = totalForecast.toLocaleString();
        document.getElementById('summaryProjectedRevenue').textContent = '$' + totalRevenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Average trend
        const avgTrend = products.reduce((sum, p) => sum + (p.growth_rate || 0), 0) / products.length;
        const trendColor = avgTrend >= 0 ? '#059669' : '#dc2626';
        const trendArrow = avgTrend >= 0 ? '↑' : '↓';
        const trendEl = document.getElementById('summaryAvgTrend');
        trendEl.textContent = trendArrow + ' ' + Math.abs(avgTrend).toFixed(1) + '%';
        trendEl.style.color = trendColor;

        // Top category
        const categoryCounts = {};
        products.forEach(p => {
          const cat = p.category || 'Uncategorized';
          categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
        });
        const topCategory = Object.keys(categoryCounts).reduce((a, b) => 
          categoryCounts[a] > categoryCounts[b] ? a : b
        );
        document.getElementById('summaryTopCategory').textContent = topCategory;
        document.getElementById('summaryTopCategoryCount').textContent = categoryCounts[topCategory] + ' products';

        console.log('[Summary] Updated with', products.length, 'products');
      }

      async function fetchData(){
        try{
          const params = new URLSearchParams();
          params.set('horizon', '7');
          params.set('top', '200');

          const apiUrl = '/product-forecast/api/';
          const fullUrl = apiUrl + '?' + params.toString();
          console.log('[FetchData] Request URL:', fullUrl);
          
          const res = await fetch(fullUrl, { 
            credentials: 'same-origin', 
            cache: 'no-store',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          console.log('[FetchData] Response Status:', res.status);
          
          if(!res.ok){ 
            const text = await res.text();
            console.error('[FetchData] API error', res.status, ':', text);
            return; 
          }

          const json = await res.json();
          console.log('[FetchData] Full Response:', json);
          console.log('[FetchData] Top array length:', json.top ? json.top.length : 0);
          console.log('[FetchData] Summary:', json.summary);
          
          if(!json.top || json.top.length === 0) {
            console.warn('[FetchData] WARNING: No products in response');
            // Still update UI with empty state
            renderTable([]);
            updateSummaryStats([]);
            return;
          }
          
          console.log('[FetchData] First product:', json.top[0]);
          renderTable(json.top);
          updateSummaryStats(json.top);
        }catch(e){ 
          console.error('[FetchData] Exception:', e.message, e.stack);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function(){ 
          console.log('[FetchData] DOM loaded, fetching data...');
          setTimeout(fetchData, 100); 
        });
      } else {
        console.log('[FetchData] DOM already loaded, fetching data...');
        setTimeout(fetchData, 100);
      }
  </script>
</div>
{% endblock %}
