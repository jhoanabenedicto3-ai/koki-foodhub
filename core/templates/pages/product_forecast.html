{% extends "layouts/base.html" %}
{% block content %}
<div class="forecast-wrapper">
  <div class="page-header">
    <h1 class="section-title">Product Forecast</h1>
    <p class="muted" style="font-size:15px; margin-top:8px;">Predict best-selling products for the next day, week, and month.</p>
  </div>

  <div class="controls-row">
    <div class="analytics-grid three-up" style="flex:1; min-width:360px;">
      <div class="analytics-card">
        <h3>Best prediction</h3>
        <div id="best-product" class="insight-large">—</div>
        <div class="meta small muted" id="best-product-meta">—</div>
      </div>
      <div class="analytics-card">
        <h3>Projected sales</h3>
        <div id="proj-sales" class="insight-large">—</div>
        <div class="meta small muted" id="proj-sales-meta">—</div>
      </div>
      <div class="analytics-card">
        <h3>Projected revenue</h3>
        <div id="proj-revenue" class="insight-large">—</div>
        <div class="meta small muted" id="proj-revenue-meta">—</div>
      </div>
    </div>

    <div class="controls-actions">
      <div class="btn-group" role="radiogroup" aria-label="Time range">
        <button class="btn small range-btn active" data-range="7">Weekly</button>
        <button class="btn small range-btn" data-range="1">Daily</button>
        <button class="btn small range-btn" data-range="30">Monthly</button>
      </div>

      <select id="categorySelect" class="input small" aria-label="Filter by category">
        <option value="">All categories</option>
        {% for cat in categories %}
          <option value="{{ cat }}">{{ cat }}</option>
        {% endfor %}
      </select>

      <input id="searchInput" class="input small" placeholder="Search product" aria-label="Search product" />

      <label class="input small" style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="activeOnly" /> Active only
      </label>
      <label class="input small" style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="inStockOnly" /> In stock only
      </label>

      <input id="minPrice" class="input tiny" type="number" step="0.01" placeholder="Min price" aria-label="Minimum price" style="width:90px;" />
      <input id="maxPrice" class="input tiny" type="number" step="0.01" placeholder="Max price" aria-label="Maximum price" style="width:90px;" />

      <div style="display:flex; gap:6px;">
        <button id="exportCsv" class="btn small">Export CSV</button>
        <button id="exportJson" class="btn small">Export JSON</button>
      </div>
    </div>
  </div>

  <div class="card chart-card two-up">
    <div>
      <h2 class="section-sub" style="margin-bottom:8px;">Product trend (select a product below)</h2>
      <div class="chart-area">
        <canvas id="productLineChart" role="img" aria-label="Product sales and forecast chart"></canvas>
      </div>
      <div id="best-panel" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <div id="best-image" style="width:48px; height:48px; background:#f5f5f5; border-radius:6px;"></div>
        <div>
          <div id="best-name" style="font-weight:600;">—</div>
          <div id="best-details" class="muted small">—</div>
        </div>
      </div>
    </div>

    <div>
      <h2 class="section-sub" style="margin-bottom:8px;">Trending products</h2>
      <div class="chart-area small-chart-area">
        <canvas id="topProductsBar" role="img" aria-label="Top products bar chart"></canvas>
      </div>
      <div style="margin-top:12px; overflow:auto; max-height:260px;">
        <table class="table" id="productRankingTable" aria-label="Product ranking table">
          <thead>
            <tr><th>Rank</th><th>Product</th><th>Past 30d</th><th>Forecast</th><th>Growth%</th><th>Trend</th><th>Price</th><th>Revenue</th><th>Active</th><th>In stock</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="product-detail" class="card" style="display:none; margin-top:16px; padding:16px;">
    <h3 id="detail-title">Product detail</h3>
    <p id="detail-insight" class="muted">—</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Enhanced client to fetch product forecast API and render charts + exports
    (function(){
      const apiUrl = '{{ api_url }}';
      let lastProducts = [];
      let currentHorizon = 7;
      let currentCategory = '';
      let currentSearch = '';

      function formatNumber(n){ return (n===0? '0': n.toLocaleString()); }
      function formatCurrency(n){ return '£' + Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }

      function renderSummary(summary, best){
        document.getElementById('proj-sales').innerText = formatNumber(summary.total_forecast_units || 0);
        document.getElementById('proj-sales-meta').innerText = `${summary.count || 0} products`;
        document.getElementById('proj-revenue').innerText = formatCurrency(summary.projected_revenue || 0);
        document.getElementById('proj-revenue-meta').innerText = 'Projected for selected horizon';

        if(best){
          document.getElementById('best-product').innerText = best.product + ' — ' + formatNumber(best.forecast_h);
          document.getElementById('best-product-meta').innerText = 'Confidence: ' + Math.round(best.confidence) + '%';
          document.getElementById('best-name').innerText = best.product;
          document.getElementById('best-details').innerText = `Forecast: ${formatNumber(best.forecast_h)} • Growth: ${best.growth_rate}% • ${best.category}`;
        } else {
          document.getElementById('best-product').innerText = '—';
          document.getElementById('best-product-meta').innerText = '—';
        }
      }

      let barChart = null;
      let lineChart = null;

      function renderBarChart(canvasId, top){
        const labels = top.map(p => p.product);
        const data = top.map(p => p.forecast_h);
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(barChart){ try{ barChart.destroy(); }catch(e){} }
        barChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Forecast', data, backgroundColor: 'rgba(54, 162, 235, 0.85)' }] }, options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
      }

      function renderTable(products){
        lastProducts = products;
        const tbody = document.querySelector('#productRankingTable tbody'); tbody.innerHTML = '';
        products.forEach((p, i) =>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td><a href="#" data-pid="${p.product_id}" class="select-product">${p.product}</a></td><td>${formatNumber(p.past_30_days)}</td><td>${formatNumber(p.forecast_h)}</td><td>${p.growth_rate}%</td><td>${p.trend}</td><td>${formatCurrency(p.price)}</td><td>${formatCurrency(p.projected_revenue)}</td><td>${p.is_active? 'Yes':'No'}</td><td>${p.in_stock? 'Yes':'No'}</td>`;
          tbody.appendChild(tr);
        });
        document.querySelectorAll('.select-product').forEach(a => a.addEventListener('click', function(ev){ ev.preventDefault(); const pid = this.getAttribute('data-pid'); fetchProductDetail(pid); }));
      }

      function renderLine(canvasId, detail){
        const labels = detail.series.map(s => s[0]);
        const actual = detail.series.map(s => s[1]);
        const next30 = detail.horizons && detail.horizons.h_30 ? detail.horizons.h_30.forecast : 0;
        const futureLabels = [];
        const forecastVals = [];
        for(let i=1;i<=30;i++){ futureLabels.push('+'+i+'d'); forecastVals.push(next30); }
        const combinedLabels = labels.concat(futureLabels);
        const forecastPadded = Array(labels.length).fill(null).concat(forecastVals);

        const ctx = document.getElementById(canvasId).getContext('2d');
        if(lineChart){ try{ lineChart.destroy(); }catch(e){} }
        lineChart = new Chart(ctx, { type:'line', data:{ labels: combinedLabels, datasets:[ { label:'Actual', data: actual.concat(Array(futureLabels.length).fill(null)), borderColor: 'rgba(34,139,230,0.9)', backgroundColor: 'rgba(34,139,230,0.08)', fill:true }, { label:'Forecast', data: forecastPadded, borderColor:'rgba(235, 85, 95,0.9)', borderDash:[4,2], pointRadius:0 } ] }, options:{ responsive:true, plugins:{ tooltip:{ mode:'index', intersect:false } }, scales:{ y:{ beginAtZero:true } } } });
      }

      async function fetchData(){
        try{
          const params = new URLSearchParams();
          params.set('horizon', currentHorizon);
          if(currentCategory) params.set('category', currentCategory);
          if(currentSearch) params.set('search', currentSearch);
          params.set('top', '50');

          const activeOnlyChecked = document.getElementById('activeOnly').checked;
          const inStockOnlyChecked = document.getElementById('inStockOnly').checked;
          const minPriceVal = document.getElementById('minPrice').value;
          const maxPriceVal = document.getElementById('maxPrice').value;

          if(activeOnlyChecked) params.set('active', '1');
          if(inStockOnlyChecked) params.set('in_stock', '1');
          if(minPriceVal) params.set('min_price', minPriceVal);
          if(maxPriceVal) params.set('max_price', maxPriceVal);

          const res = await fetch(apiUrl + '?' + params.toString());
          const json = await res.json();
          const top = json.top || [];
          renderSummary(json.summary || {}, json.best || null);
          renderBarChart('topProductsBar', top.slice(0,10));
          renderTable(top);
        }catch(e){ console.warn('Failed to fetch product forecasts', e); }
      }

      async function fetchProductDetail(pid){
        try{
          const params = new URLSearchParams();
          params.set('product_id', pid);
          params.set('horizon', currentHorizon);
          const res = await fetch(apiUrl + '?' + params.toString());
          const j = await res.json();
          const d = j.product_detail;
          if(!d){ document.getElementById('product-detail').style.display='none'; return; }
          document.getElementById('product-detail').style.display='block';
          document.getElementById('detail-title').innerText = 'Details: ' + (d.series && d.series.length ? (d.series.slice(-1)[0][0] + ' — ' + d.series.slice(-1)[0][1]) : 'No history');
          document.getElementById('detail-insight').innerText = 'Trend: ' + d.trend + '. Last 7 days: ' + (d.last_7_days || 0) + '. Average daily: ' + (Math.round(d.avg) || 0);
          renderLine('productLineChart', d);
        }catch(e){ console.warn('Failed to fetch product detail', e); }
      }

      // Exports
      function exportCSV(){
        if(!lastProducts || !lastProducts.length){ alert('No data to export'); return; }
        const headers = ['Rank','Product','Past 30d','Forecast','Growth%','Trend','Price','ProjectedRevenue','Category'];
        const rows = lastProducts.map((p,i) => [i+1, p.product, p.past_30_days, p.forecast_h, p.growth_rate, p.trend, p.price, p.projected_revenue, p.category]);
        const csv = [headers.join(',')].concat(rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(','))).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `product_forecast_h${currentHorizon}${currentCategory?('_'+currentCategory):''}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function exportJSON(){
        if(!lastProducts || !lastProducts.length){ alert('No data to export'); return; }
        const blob = new Blob([JSON.stringify(lastProducts, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `product_forecast_h${currentHorizon}${currentCategory?('_'+currentCategory):''}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // Controls
      document.querySelectorAll('.range-btn').forEach(b => b.addEventListener('click', function(){ document.querySelectorAll('.range-btn').forEach(x=>x.classList.remove('active')); this.classList.add('active'); currentHorizon = parseInt(this.getAttribute('data-range')); fetchData(); }));
      document.getElementById('categorySelect').addEventListener('change', function(){ currentCategory = this.value; fetchData(); });
      let searchTimer = null;
      document.getElementById('searchInput').addEventListener('input', function(){ clearTimeout(searchTimer); searchTimer = setTimeout(()=>{ currentSearch = this.value.trim(); fetchData(); }, 350); });

      // New filters: active, in-stock, price range
      document.getElementById('activeOnly').addEventListener('change', function(){ /* checkbox */ fetchData(); });
      document.getElementById('inStockOnly').addEventListener('change', function(){ /* checkbox */ fetchData(); });
      document.getElementById('minPrice').addEventListener('change', function(){ fetchData(); });
      document.getElementById('maxPrice').addEventListener('change', function(){ fetchData(); });

      document.getElementById('exportCsv').addEventListener('click', exportCSV);
      document.getElementById('exportJson').addEventListener('click', exportJSON);

      // Initial load
      fetchData();

    })();
  </script>
</div>
{% endblock %}
