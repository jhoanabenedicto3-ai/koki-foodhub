<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}Koki's Foodhub{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Professional Food Hub Management System">
  <link rel="stylesheet" href="/static/styles.css?v=3" />

  <!-- PWA manifest -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#ff5722">
  {% block extra_head %}{% endblock %}
</head>
<body>
  {% load static %}

  <!-- Site-wide toast container (shows server messages as toasts after redirects) -->
  <div id="site-toast" aria-live="polite" role="status" style="display:none"></div>
  {% if messages %}
    {% for message in messages %}
      <div class="dj-msg" data-level="{{ message.level_tag }}" data-text="{{ message|escape }}" style="display:none"></div>
    {% endfor %}
  {% endif %}

  <div class="page-wrapper">
    <!-- Left Sidebar -->
    <aside class="sidebar" id="site-sidebar">
      <div class="sidebar-header">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div>
            <h2 style="margin: 0; font-size: 16px; font-weight: 700; color: var(--accent);">KOKI'S</h2>
            <p style="margin: 0; font-size: 11px; color: var(--text-secondary);">Food Hub</p>
          </div>
          <button id="sidebar-toggle" aria-expanded="false" title="Toggle sidebar" style="background:none;border:none;color:inherit;font-size:18px;cursor:pointer;padding:6px;">â˜°</button>
        </div>
      </div>

      <nav class="sidebar-menu">
        <!-- Persistent menu item to ensure visibility on all screen sizes and cached views -->
        <div class="sidebar-menu-item">
          <a id="product-forecast-btn" href="{% url 'product_forecast' %}" class="{% if '/product-forecast' in request.path %}active{% endif %}" style="display:flex;align-items:center;gap:10px;">
            <span class="sidebar-icon">ðŸ§¾</span>
            <span class="sidebar-label">Product Forecast</span>
          </a>
        </div>
        <div class="sidebar-menu-item">
          <a href="{% url 'dashboard' %}" class="{% if request.path == '/' %}active{% endif %}">
            <span class="sidebar-icon">ðŸ“Š</span>
            <span class="sidebar-label">Dashboard</span>
          </a>
        </div>
        <div class="sidebar-menu-item">
          <a href="{% url 'inventory_list' %}" class="{% if '/inventory' in request.path %}active{% endif %}">
            <span class="sidebar-icon">ðŸ“¦</span>
            <span class="sidebar-label">Inventory</span>
          </a>
        </div>
        <div class="sidebar-menu-item">
          <a href="{% url 'sale_list' %}" class="{% if '/sales' in request.path %}active{% endif %}">
            <span class="sidebar-icon">ðŸ“‹</span>
            <span class="sidebar-label">Reports</span>
          </a>
        </div>
        <div class="sidebar-menu-item">
          <a href="{% url 'sales_dashboard' %}" class="{% if '/sales-dashboard' in request.path %}active{% endif %}">
            <span class="sidebar-icon">ðŸ“Š</span>
            <span class="sidebar-label">Sales</span>
          </a>
        </div>
        <div class="sidebar-menu-item">
          <a href="{% url 'forecast' %}" class="{% if '/forecast' in request.path %}active{% endif %}">
            <span class="sidebar-icon">ðŸ“ˆ</span>
            <span class="sidebar-label">Forecast</span>
          </a>
        </div>

        <div class="sidebar-menu-item">
          <a href="{% url 'product_list' %}" class="{% if '/products' in request.path %}active{% endif %}">
            <span class="sidebar-icon">ðŸ›’</span>
            <span class="sidebar-label">Products List</span>
          </a>
        </div>
        {# Show User Management to Admin group members, staff, or superusers #}
        {% if request.user.is_authenticated and request.user.is_staff %}
          <div class="sidebar-menu-item">
            <a href="{% url 'admin_user_list' %}" class="{% if '/users/manage' in request.path %}active{% endif %}">
              <span class="sidebar-icon">ðŸ”§</span>
              <span class="sidebar-label">User Management</span>
            </a>
          </div>
        {% elif request.user.is_authenticated and request.user.is_superuser %}
          <div class="sidebar-menu-item">
            <a href="{% url 'admin_user_list' %}" class="{% if '/users/manage' in request.path %}active{% endif %}">
              <span class="sidebar-icon">ðŸ”§</span>
              <span class="sidebar-label">User Management</span>
            </a>
          </div>
        {% else %}
          {% for g in request.user.groups.all %}
            {% if g.name == 'Admin' %}
              <div class="sidebar-menu-item">
                <a href="{% url 'admin_user_list' %}" class="{% if '/users/manage' in request.path %}active{% endif %}">
                  <span class="sidebar-icon">ðŸ”§</span>
                  <span class="sidebar-label">User Management</span>
                </a>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
        {# Owner-only: show Pending Cashiers approval link #}
        {% if request.user.is_authenticated %}
          {% for g in request.user.groups.all %}
            {% if g.name == 'Owner' %}
              <div class="sidebar-menu-item">
                <a href="{% url 'pending_cashiers' %}" class="{% if '/users/pending' in request.path %}active{% endif %}">
                  <span class="sidebar-icon">âœ…</span>
                  <span class="sidebar-label">Pending Cashiers</span>
                </a>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
        <div class="sidebar-menu-item">
          <a href="{% url 'logout' %}" class="logout-link">
            <span class="sidebar-icon">ðŸšª</span>
            <span class="sidebar-label">Logout</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Top Header -->
      <header class="header">
        <div class="header-left">
          <h1 class="header-title">Restaurant Management System</h1>
          <p class="header-subtitle">Dashboard</p>
        </div>
        <div class="header-right">
          {% if request.user.is_authenticated %}
            <span class="user-info">ðŸ‘¤ {{ request.user.username }}</span>
            <span style="display:inline-block;width:8px"></span>
            {# Role badges: superuser -> staff -> group-based badges #}
            {% if request.user.is_superuser %}
              <span class="role-badge superuser">Superuser</span>
            {% else %}
              {% if request.user.is_staff %}
                <span class="role-badge staff">Owner</span>
              {% endif %}
              {% for g in request.user.groups.all %}
                {% if g.name == 'Admin' %}
                  <span class="role-badge admin">Admin</span>
                {% elif g.name == 'Cashier' %}
                  <span class="role-badge cashier">Cashier</span>
                {% endif %}
              {% endfor %}
            {% endif %}
          {% else %}
            <span class="user-info">ðŸ‘¤ Guest</span>
          {% endif %}
        </div>
      </header>

      <!-- Page Content -->
      <main class="container">
        {% include "organisms/toast.html" %}
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <!-- Service worker registration -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/static/service-worker.js")
        .then(reg => console.log("Service Worker registered:", reg))
        .catch(err => console.error("Service Worker failed:", err));
    }
  </script>

  <style>
    /* Center-top banner toast */
    #site-toast{position:fixed;left:50%;transform:translateX(-50%);top:20px;z-index:99999;min-width:280px;max-width:760px;padding:14px 18px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.18);color:#fff;font-weight:700;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s}
    #site-toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0)}
    #site-toast.success{background:linear-gradient(90deg,#2e7d32,#43a047)}
    #site-toast.info{background:linear-gradient(90deg,#1976d2,#2196f3)}
    #site-toast.error{background:linear-gradient(90deg,#c62828,#ef5350)}
    .role-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px;color:#fff;margin-left:6px}
    .role-badge.admin{background:linear-gradient(90deg,#5b9dfa,#4779d9)}
    .role-badge.cashier{background:linear-gradient(90deg,#ffb74d,#ff9800);color:#2b2b2b}
    .role-badge.staff{background:linear-gradient(90deg,#9e9e9e,#757575)}
    .role-badge.superuser{background:linear-gradient(90deg,#d32f2f,#ef5350)}
  </style>

  <script>
    (function(){
      function showSiteToast(text, level){
        var el = document.getElementById('site-toast');
        el.textContent = text;
        el.className = '';
        el.classList.add(level || 'info');
        // show
        el.style.display = 'block';
        // small pop animation
        requestAnimationFrame(function(){ el.classList.add('show'); });
        clearTimeout(el._hide);
        el._hide = setTimeout(function(){ el.classList.remove('show'); setTimeout(function(){ el.style.display='none'; },220); }, 4500);
      }

      // On DOM ready, render any server messages
      document.addEventListener('DOMContentLoaded', function(){
        var msgs = document.querySelectorAll('.dj-msg');
        if(!msgs || msgs.length===0) return;
        // Show them one after another
        Array.prototype.forEach.call(msgs, function(node, idx){
          var text = node.getAttribute('data-text');
          var level = node.getAttribute('data-level') || 'info';
          setTimeout(function(){ showSiteToast(text, level); }, idx*500);
        });
      });
    })();
  </script>

  <script>
    // Sidebar toggle: persist expanded state and support click toggle + hover expansion
    (function(){
      var wrapper = document.querySelector('.page-wrapper');
      var toggle = document.getElementById('sidebar-toggle');
      var STORAGE_KEY = 'koki_sidebar_expanded';

      function setExpanded(expanded){
        if(!wrapper) return;
        if(expanded){
          wrapper.classList.add('sidebar-expanded');
          toggle && toggle.setAttribute('aria-expanded','true');
        } else {
          wrapper.classList.remove('sidebar-expanded');
          toggle && toggle.setAttribute('aria-expanded','false');
        }
      }

      // Reset any previous preference so the new collapsed UI appears immediately
      try{
        localStorage.removeItem(STORAGE_KEY);
      }catch(e){}
      try{
        var value = localStorage.getItem(STORAGE_KEY);
        setExpanded(value === '1');
      }catch(e){}

      if(toggle){
        toggle.addEventListener('click', function(e){
          e.preventDefault();
          var isExpanded = wrapper && wrapper.classList.contains('sidebar-expanded');
          setExpanded(!isExpanded);
          try{ localStorage.setItem(STORAGE_KEY, !isExpanded ? '1' : '0'); }catch(e){}
        });
      }
    })();
  </script>
</body>
</html>
