name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  trigger-render-deploy:
    name: Trigger Render Deploy
    runs-on: ubuntu-latest
    # Only run if the required secrets are set (prevents accidental failures)
    if: ${{ secrets.RENDER_API_KEY && secrets.RENDER_SERVICE_ID }}

    steps:
    - name: Trigger deploy via Render API
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "Triggering deploy for service: $RENDER_SERVICE_ID"
        set -e
        response=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" -H "Authorization: Bearer $RENDER_API_KEY" -H "Content-Type: application/json" -d '{}')
        echo "Render response: $response"
        if echo "$response" | grep -q 'id'; then
          echo "Deploy triggered successfully."
        else
          echo "Failed to trigger deploy. Response follows:"; echo "$response"; exit 1
        fi
